%YAML 1.1
--- 
StructureVersion: "1.0"
Properties: 
  RUID: 151163573_5956463
  Name: "Зарплата.Пролог.Расчет среднедневного заработка"
  Caption: "Начисление отпускных (Пролог-скрипт)"
  Version: "1.0.0.90"
  Optional: False
  Internal: True
Uses: 
  - "147698171_43451302 Зарплата"
Objects: 
  - 
    Properties: 
      Class: "TgdcStoredProc"
      RUID: 151162335_5956463
      AlwaysOverwrite: True
      DontRemove: True
      IncludeSiblings: False
    Fields: 
      RDB$DESCRIPTION: | 
        USR$WG_TBLCALDAY_P
      PROCEDURENAME: "USR$WG_TBLCALDAY_P"
      PROCEDURESOURCE: | 
        CREATE OR ALTER PROCEDURE USR$WG_TBLCALDAY_P (
            IN_EMPLKEY INTEGER,
            IN_FIRSTMOVE INTEGER,
            IN_DATEFROM DATE,
            IN_DATETO DATE)
        RETURNS ( 
            EMPLKEY INTEGER,
            FIRSTMOVEKEY INTEGER,
            THEDAY DATE,
            WYEAR INTEGER,
            WMONTH INTEGER,
            WDAY INTEGER,
            WDURATION INTEGER,
            WORKDAY INTEGER,
            SCHEDULEKEY INTEGER)
         AS
         BEGIN
        FOR
        
        SELECT * FROM
        (
        SELECT
          ml.USR$EMPLKEY,
          ml.USR$FIRSTMOVE AS FirstMoveKey,
          tcd.THEDAY,
          EXTRACT(YEAR FROM tcd.THEDAY) AS WYEAR,
          EXTRACT(MONTH FROM tcd.THEDAY) AS WMONTH,
          EXTRACT(DAY FROM tcd.THEDAY) AS WDAY,
          tcd.WDURATION,
          tcd.WORKDAY,
          ml.USR$SCHEDULEKEY
        FROM
          (
          SELECT FIRST 1 * FROM USR$WG_MOVEMENTLINE
          WHERE
            USR$EMPLKEY = :IN_EMPLKEY
            AND
            USR$FIRSTMOVE = :IN_FIRSTMOVE
          ORDER BY USR$DATEBEGIN
          ) ml
        JOIN
          WG_TBLCAL tc
            ON tc.ID = ml.USR$SCHEDULEKEY
        JOIN
          WG_TBLCALDAY tcd
            ON tcd.TBLCALKEY = tc.ID
        WHERE
          ml.USR$EMPLKEY = :IN_EMPLKEY
          AND
          ml.USR$FIRSTMOVE = :IN_FIRSTMOVE
          AND
          COALESCE(tcd.WDURATION, 0) > 0
          AND
          tcd.THEDAY >= :IN_DATEFROM
          AND
          tcd.THEDAY < :IN_DATETO
          AND
          tcd.THEDAY < ml.USR$DATEBEGIN
        UNION ALL
        SELECT
          ml.USR$EMPLKEY,
          ml.USR$FIRSTMOVE AS FirstMoveKey,
          tcd.THEDAY,
          EXTRACT(YEAR FROM tcd.THEDAY) AS WYEAR,
          EXTRACT(MONTH FROM tcd.THEDAY) AS WMONTH,
          EXTRACT(DAY FROM tcd.THEDAY) AS WDAY,
          tcd.WDURATION,
          tcd.WORKDAY,
          ml.USR$SCHEDULEKEY
        FROM
          USR$WG_MOVEMENTLINE ml
        RIGHT JOIN
          WG_TBLCAL tc
            ON tc.ID = ml.USR$SCHEDULEKEY
        JOIN
          WG_TBLCALDAY tcd
            ON tcd.TBLCALKEY = tc.ID
        WHERE
          ml.USR$EMPLKEY = :IN_EMPLKEY
          AND
          ml.USR$FIRSTMOVE = :IN_FIRSTMOVE
          AND
          ml.USR$DATEBEGIN < :IN_DATETO
          AND
          COALESCE(tcd.WDURATION, 0) > 0
          AND
          tcd.THEDAY >= :IN_DATEFROM
          AND
          tcd.THEDAY < :IN_DATETO
          AND
          tcd.THEDAY >= ml.USR$DATEBEGIN
          AND
          tcd.THEDAY <
            COALESCE(
              (
              SELECT
                FIRST 1
                ml_next.USR$DATEBEGIN
              FROM
                USR$WG_MOVEMENTLINE ml_next
              WHERE
                ml_next.USR$EMPLKEY = :IN_EMPLKEY
                AND
                ml_next.USR$FIRSTMOVE = :IN_FIRSTMOVE
                AND
                ml_next.USR$DATEBEGIN > ml.USR$DATEBEGIN
              ORDER BY
                ml_next.USR$DATEBEGIN
              ),
            :IN_DATETO
            )
        ) ml_union
        ORDER BY
          THEDAY
        
        INTO
            :EMPLKEY,
            :FirstMoveKey,
            :THEDAY,
            :WYEAR,
            :WMONTH,
            :WDAY,
            :WDURATION,
            :WORKDAY,
            :SCHEDULEKEY
        DO
          SUSPEND;
        
        END
        
      EDITIONDATE: 2013-11-18T12:13:11+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151164077_5956463
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "MACROS"
      LANGUAGE: "VBScript"
      NAME: "Macros151164077_5956463"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#include wg_AvgSalaryStrGenerate
        
        Sub Macros151164077_5956463(OwnerForm)
          'Dim Ret
          
          call wg_AvgSalaryStrGenerate(OwnerForm, 0)
        End Sub
        
      DISPLAYSCRIPT: | 
        MACROS151164077_5956463
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QJAAAAT1dORVJGT1JNCQAAAE9XTkVSRk9STQAAAAAAAAAAAAAAAAsAAAAAAAAAAAAA
        AABGTlNURkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-01-10T16:42:52+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147489128_336327731 wg_AvgSalaryStrGenerate"
  - 
    Properties: 
      Class: "TgdcMacros"
      RUID: 151164075_5956463
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MACROSGROUPKEY: "147021904_119619099 Локальные макросы"
      FUNCTIONKEY: "151164077_5956463 Macros151164077_5956463"
      NAME: "Рассчитать ср. заработок"
      SERVERKEY: ~
      ISLOCALEXECUTE: 0
      ISREBUILD: 0
      EXECUTEDATE: ~
      SHORTCUT: 0
      EDITIONDATE: 2014-01-10T16:42:52+03:00
      DISPLAYINMENU: 1
      RUNONLOGIN: 0
  - 
    Properties: 
      Class: "TgdcTableField"
      RUID: 155817502_77029543
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      REFRELATIONNAME: ~
      REFLISTFIELD: ~
      REFCROSSRELATION: ~
      SETLISTFIELD: ~
      SETLISTFIELDKEY: ~
      RELATIONTYPE: "T"
      STRINGLENGTH: ~
      DEFSOURCE: | 
        DEFAULT '0'
      COMPUTED_VALUE: ~
      SOURCENULLFLAG: ~
      NULLFLAG: ~
      RDB$FIELD_POSITION: 33
      FIELDNAME: "USR$AVGDAYHOW"
      RELATIONNAME: "USR$WG_FEETYPE"
      FIELDSOURCE: "DBOOLEAN"
      CROSSTABLE: ~
      CROSSFIELD: ~
      RELATIONKEY: "147567082_119619099 Виды начислений, USR$WG_FEETYPE"
      FIELDSOURCEKEY: "147000135_486813904 Логическое, DBOOLEAN"
      CROSSTABLEKEY: ~
      CROSSFIELDKEY: ~
      LNAME: "Дни/часы для среднего"
      LSHORTNAME: "Дни/часы для среднег"
      DESCRIPTION: ~
      VISIBLE: 1
      FORMAT: ~
      ALIGNMENT: "L"
      COLWIDTH: 20
      READONLY: 0
      GDCLASSNAME: ~
      GDSUBTYPE: ~
      OBJECTS: ~
      DELETERULE: ~
      EDITIONDATE: 2013-12-26T15:52:05+03:00
  - 
    Properties: 
      Class: "TgdcAttrUserDefinedLBRBTree"
      SubType: "USR$WG_FEEGROUP"
      RUID: 147757383_84733194
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      PARENT: "147071456_274788016 Все начисления\\Ср. заработок\\Ср. заработок для отпусков"
      DISABLED: 0
      EDITIONDATE: 2014-01-08T18:30:20+03:00
      USR$NAME: "Ср. заработок для отпусков - не осовременивать"
      USR$DESCRIPTION: ~
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151158419_5956463
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 151163587_5956463
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "UNKNOWN"
      LANGUAGE: "VBScript"
      NAME: "pl_GetScriptIDByName"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        
        'uses pl_Const
        Function pl_GetScriptIDByName(Name)
          Dim Creator, ibsql
        
          pl_GetScriptIDByName = 0
        
          Set Creator = New TCreator
          Set ibsql = Creator.GetObject(nil, "TIBSQL", "")
        
          ibsql.Transaction = gdcBaseManager.ReadTransaction
          ibsql.SQL.TEXT = _
              "SELECT * FROM gd_function" & _
              " WHERE UPPER(name) = UPPER(:name) AND module = :module"
          ibsql.ParamByName("name").AsString = Name
          ibsql.ParamByName("module").AsString = scrPrologModuleName
          ibsql.ExecQuery
        
          If Not ibsql.EOF Then
             pl_GetScriptIDByName = ibsql.FieldByName("id").AsInteger
          End If
        End Function
        
      DISPLAYSCRIPT: | 
        PL_GETSCRIPTIDBYNAME
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QEAAAATkFNRQQAAABOQU1FAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZOU1RGTFBS
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2013-10-11T16:45:28+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151163587_5956463
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "UNKNOWN"
      LANGUAGE: "VBScript"
      NAME: "wg_AvgSalaryStrGenerate_pl"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#include wg_WageSettings
        '#include wg_EnableFieldChange
        '#include pl_GetScriptIDByName
        '#include wg_AvgSalary_CoefOption
        
        Function wg_AvgSalaryStrGenerate_pl(ByRef Sender, ByVal CalcType)
        '
          Dim T, T1, T2
          
          Dim Creator, gdcObject, gdcSalary
          '
          Dim PL, Ret, Pred, Tv, Append
          Dim PredFile
          'avg_wage
          Dim P_main, Tv_main, Q_main
          'avg_wage_in
          Dim P_in, Tv_in, Q_in
          Dim EmplKey, FirstMoveKey, DateCalc
          Dim InflType, InflFCType
          Dim MonthOffset, CoefOption
          'avg_wage_run, avg_wage_sql
          Dim P_run, Tv_run, Q_run, P_sql, Tv_sql, Q_sql, P_kb
          Dim DateCalcFrom, DateCalcTo
          Dim PredicateName, Arity, SQL
          'avg_wage_out, avg_wage_det
          Dim P_out, Tv_out, Q_out, P_det, Tv_det, Q_det
          Dim AvgWage, AvgWageRule
          Dim Period, PeriodRule, Wage, ModernWage, ModernCoef
          Dim TabDays, TabHoures, NormDays, NormHoures
          Dim IsFull, IsCheck
        
          T1 = Timer
          wg_AvgSalaryStrGenerate_pl = False
          Set Creator = New TCreator
          
          Sender.GetComponent("actApply").Execute
        
          Set gdcObject = Sender.gdcObject
          '
          EmplKey = gdcObject.FieldByName("usr$emplkey").AsInteger
          FirstMoveKey = gdcObject.FieldByName("usr$firstmovekey").AsInteger
          '
          if CalcType = 0 then
            dim IBSQL
            set IBSQL = Creator.GetObject(nil, "TIBSQL", "")
            IBSQL.Transaction = gdcBaseManager.ReadTransaction
            IBSQL.SQL.Text = _
              "select " & _
              "  t.USR$DATEBEGIN " & _
              "from " & _
              "  usr$wg_total t " & _
              "where " & _
              "  t.DOCUMENTKEY = :TDK "
            IBSQL.ParamByName("TDK").asInteger = gdcObject.FieldByName("USR$TOTALDOCKEY").AsInteger
            IBSQL.ExecQuery
            DateCalc = IBSQL.FieldByName("USR$DATEBEGIN").AsDateTime
          else
            DateCalc = gdcObject.FieldByName("usr$from").AsDateTime
          end if
          '
          MonthOffset = 0
          '
          InflType = wg_WageSettings.Inflation.InflType
          InflFCType = wg_WageSettings.Inflation.InflFCType
          'CoefOption: fc_fcratesum ; ml_rate ; ml_msalary
          Select Case InflType
            'usrg_rbSalaryInf - От оклада
            Case 0
              CoefOption = "ml_msalary"
            'usrg_rbRateInf - От ставки 1-го разряда
            Case 1
              Select Case InflFCType
                'usrg_rbFCRate - справочника
                Case 0
                  CoefOption = "fc_fcratesum"
                'usrg_rbMovementRate - кадрового движения
                Case 2
                  CoefOption = "ml_rate"
              End Select
          End Select
          '
        
          'проблема wg_WageSettings
          'CoefOption = "ml_rate" 'только для ММК, иначе эту строку закомментировать
        
          wg_AvgSalary_CoefOption(Sender)
        
          'init
          Set PL = Creator.GetObject(nil, "TgsPLClient", "")
          Ret = PL.Initialise("")
          If Not Ret Then
            Exit Function
          End If
          'debug
          PL.Debug = True
          'load
          Ret = PL.LoadScript(pl_GetScriptIDByName("twg_avg_wage"))
          If Not Ret Then
            Exit Function
          End If
        
          Set gdcSalary = Sender.GetComponent("usrg_gdcAvgSalaryStr")
          '
          Call wg_DisableFieldChange(gdcSalary, "AVGSALARYCALC")
          '
          gdcSalary.First
          While Not gdcSalary.EOF
            gdcSalary.Delete
          Wend
          '
          gdcObject.FieldByName("USR$AVGSUMMA").Clear
          '
          Sender.Repaint
        
          'avg_wage_in(EmplKey, FirstMoveKey, DateCalc, MonthOffset, CoefOption)
          P_in = "avg_wage_in"
          Set Tv_in = Creator.GetObject(5, "TgsPLTermv", "")
          Set Q_in = Creator.GetObject(nil, "TgsPLQuery", "")
          Tv_in.PutInteger 0, EmplKey
          Tv_in.PutInteger 1, FirstMoveKey
          Tv_in.PutDate 2, DateCalc
          Tv_in.PutInteger 3, MonthOffset
          Tv_in.PutAtom 4, CoefOption
          '
          Q_in.PredicateName = P_in
          Q_in.Termv = Tv_in
          '
          Q_in.OpenQuery
          If Q_in.EOF Then
            Exit Function
          End If
          Q_in.Close
        
          'avg_wage(_) - prepare data
          P_main = "avg_wage"
          Set Tv_main = Creator.GetObject(1, "TgsPLTermv", "")
          Set Q_main = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_main.PredicateName = P_main
          Q_main.Termv = Tv_main
          '
          Q_main.OpenQuery
          If Q_main.EOF Then
            Exit Function
          End If
          Q_main.Close
        
          'avg_wage_run(EmplKey, FirstMoveKey, DateCalcFrom, DateCalcTo)
          P_run = "avg_wage_run"
          Set Tv_run = Creator.GetObject(4, "TgsPLTermv", "")
          Set Q_run = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_run.PredicateName = P_run
          Q_run.Termv = Tv_run
          'avg_wage_sql(EmplKey, FirstMoveKey, PredicateName, Arity, SQL)
          P_sql = "avg_wage_sql"
          P_kb = "avg_wage_kb"
          Set Tv_sql = Creator.GetObject(5, "TgsPLTermv", "")
          Set Q_sql = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_sql.PredicateName = P_sql
          Q_sql.Termv = Tv_sql
          '
          Q_run.OpenQuery
          If Q_run.EOF Then
            Exit Function
          End If
          '
          Append = False
          '
          Do Until Q_run.EOF
            EmplKey = Tv_run.ReadInteger(0)
            FirstMoveKey = Tv_run.ReadInteger(1)
            DateCalcFrom = Tv_run.ReadDate(2)
            DateCalcTo = Tv_run.ReadDate(3)
            '
            Tv_sql.Reset
            Tv_sql.PutInteger 0, EmplKey
            Tv_sql.PutInteger 1, FirstMoveKey
            Q_sql.OpenQuery
            '
            Do Until Q_sql.EOF
              PredicateName = Tv_sql.ReadAtom(2)
              Arity = Tv_sql.ReadInteger(3)
              SQL = Tv_sql.ReadString(4)
              '
              Ret =  PL.MakePredicatesOfSQLSelect _
                        (SQL, _
                        gdcBaseManager.ReadTransaction, _
                        PredicateName, PredicateName, Append)
              If Ret >= 0 Then
                 Ret = PL.Call(P_kb, Tv_sql)
              End If
              '
              Q_sql.NextSolution
            Loop
            Q_sql.Close
            '
            Append = True
            '
            Q_run.NextSolution
          Loop
          Q_run.Close
        
          'save param_list
          If PL.Debug Then
            Pred = "param_list"
            PredFile = "param_list"
            Set Tv = Creator.GetObject(3, "TgsPLTermv", "")
            PL.SavePredicatesToFile Pred, Tv, PredFile
          End If
        
          'avg_wage(Variant) - calc result
          Q_main.OpenQuery
          If Q_main.EOF Then
            Exit Function
          End If
          Q_main.Close
        
          'avg_wage_out(EmplKey, FirstMoveKey, AvgWage, AvgWageVariant)
          P_out = "avg_wage_out"
          Set Tv_out = Creator.GetObject(4, "TgsPLTermv", "")
          Set Q_out = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_out.PredicateName = P_out
          Q_out.Termv = Tv_out
          'avg_wage_det(EmplKey, FirstMoveKey,
          '   Period, PeriodRule, Wage, ModernCoef, ModernWage,
          '   TabDays, NormDays, TabHoures, NormHoures)
          P_det = "avg_wage_det"
          Set Tv_det = Creator.GetObject(11, "TgsPLTermv", "")
          Set Q_det = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_det.PredicateName = P_det
          Q_det.Termv = Tv_det
          '
          Q_out.OpenQuery
          If Q_out.EOF Then
            Exit Function
          End If
          '
          Do Until Q_out.EOF
            EmplKey = Tv_out.ReadInteger(0)
            FirstMoveKey = Tv_out.ReadInteger(1)
            AvgWage = Tv_out.ReadFloat(2)
            AvgWageRule = Tv_out.ReadAtom(3)
            '
            Tv_det.Reset
            Tv_det.PutInteger 0, EmplKey
            Tv_det.PutInteger 1, FirstMoveKey
            Q_det.OpenQuery
            '
            Do Until Q_det.EOF
              Period = Tv_det.ReadDate(2)
              PeriodRule = Tv_det.ReadAtom(3)
              IsFull = _
                Abs( PeriodRule = "by_days_houres" _
                    Or PeriodRule = "by_houres" _
                    Or PeriodRule = "by_days" )
              IsCheck = Abs( Not (PeriodRule = "none") )
              '
              If AvgWageRule = "by_calc_month" Then
                Select Case PeriodRule
                  Case "by_days_houres"
                    PeriodRule = "табель равен графику по дням и часам"
                  Case "by_days"
                    PeriodRule = "табель покрывает график по дням"
                  Case "by_houres"
                    PeriodRule = "табель покрывает график по часам"
                  Case "by_month_wage_all"
                    PeriodRule = "по размеру заработка (не меньше всех полных)"
                  Case "by_month_wage_any"
                    PeriodRule = "по размеру заработка (не меньше любого полного)"
                  Case "by_month_no_bad_type"
                    PeriodRule = "виды начислений и типы часов в норме"
                  Case Else
                    PeriodRule = ""
                End Select
              ElseIf AvgWageRule = "by_avg_houre" Then
                PeriodRule = "по среднечасовому"
              End If
              '
              Wage = Tv_det.ReadFloat(4)
              ModernCoef = Tv_det.ReadFloat(5)
              ModernWage = Tv_det.ReadFloat(6)
              TabDays = Tv_det.ReadFloat(7)
              NormDays = Tv_det.ReadFloat(8)
              TabHoures = Tv_det.ReadFloat(9)
              NormHoures = Tv_det.ReadFloat(10)
              '
              gdcSalary.Append
              gdcSalary.FieldByName("USR$DATE").AsVariant = Period
              gdcSalary.FieldByName("USR$SALARY").AsVariant = Wage
              gdcSalary.FieldByName("USR$COEFF").AsVariant = ModernCoef
              gdcSalary.FieldByName("USR$MODERNSALARY").AsVariant = ModernWage
              gdcSalary.FieldByName("USR$DOW").AsVariant = TabDays
              gdcSalary.FieldByName("USR$HOW").AsVariant = TabHoures
              gdcSalary.FieldByName("USR$SCHEDULERDOW").AsVariant = NormDays
              gdcSalary.FieldByName("USR$SCHEDULERHOW").AsVariant = NormHoures
              gdcSalary.FieldByName("USR$ISCHECK").AsVariant = IsCheck
              gdcSalary.FieldByName("USR$ISFULL").AsVariant = IsFull
              gdcSalary.FieldByName("USR$DESCRIPTION").AsVariant = PeriodRule
              gdcSalary.Post
              '
              Q_det.NextSolution
            Loop
            Q_det.Close
            '
            Q_out.NextSolution
          Loop
          Q_out.Close
          '
        
          gdcSalary.First
          '
          Call wg_EnableFieldChange(gdcSalary, "AVGSALARYCALC")
          '
          If AvgWage > 0 Then
            gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency = AvgWage
            gdcObject.Post
          End If
          '
        
          wg_AvgSalaryStrGenerate_pl = True
          
          T2 = Timer
          T = T2 - T1
        '
        End function
        
      DISPLAYSCRIPT: | 
        WG_AVGSALARYSTRGENERATE_PL
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        UFJTVAgAAABDQUxDVFlQRQgAAABDQUxDVFlQRQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-21T11:30:08+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147019760_119619099 wg_WageSettings"
          - 
            ADDFUNCTIONKEY: "147016040_119619099 wg_EnableFieldChange"
          - 
            ADDFUNCTIONKEY: "151158419_5956463 pl_GetScriptIDByName"
          - 
            ADDFUNCTIONKEY: "156299481_119200397 wg_AvgSalary_CoefOption"
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 147063986_1439110857
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
    Fields: 
      PARENT: "990010_17 USER - Administrator"
      NAME: "gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2010-04-20T13:32:16+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 154648252_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063986_1439110857
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "WS"
      DATA_TYPE: "I"
      STR_DATA: ~
      INT_DATA: 2
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2013-08-12T19:08:11+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 154648251_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063986_1439110857
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "Width"
      DATA_TYPE: "I"
      STR_DATA: ~
      INT_DATA: 1382
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2014-03-11T10:17:26+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 154648250_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063986_1439110857
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "Left"
      DATA_TYPE: "I"
      STR_DATA: ~
      INT_DATA: -8
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2014-02-26T10:01:11+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 154648249_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063986_1439110857
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "Top"
      DATA_TYPE: "I"
      STR_DATA: ~
      INT_DATA: -8
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2014-02-26T10:01:11+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 154648248_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063986_1439110857
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "Height"
      DATA_TYPE: "I"
      STR_DATA: ~
      INT_DATA: 744
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2014-02-26T10:01:11+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 147063987_1439110857
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "ibgrDetail(TgsIBGrid)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2010-04-20T13:32:16+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 147123779_1439110857
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063987_1439110857
    Fields: 
      PARENT: "147063987_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)\\ibgrDetail(TgsIBGrid)"
      NAME: "data"
      DATA_TYPE: "B"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: !!binary > 
        VFBGMAYNR1JJRF9TVFJFQU1fNAEGBlRhaG9tYQYMY2xXaW5kb3dUZXh0AvUAAggAA8wAAAYIY2xX
        aW5kb3cBBgZUYWhvbWEGD2NsSGlnaGxpZ2h0VGV4dAL1AAIIAAPMAAAGC2NsSGlnaGxpZ2h0AQYG
        VGFob21hBgxjbFdpbmRvd1RleHQC9QACCAADzAAABgljbEJ0bkZhY2UJBgkkMDBFN0YzRjcGCSQw
        MEQ2RTdFNw4ACAgOAAgOAQhFeHBhbmRlZAgJRmllbGROYW1lBgtVU1IkQUNDREFURQ1UaXRsZS5D
        YXB0aW9uBg/E4PLgIO3g9+jx6+Xt6P8FV2lkdGgCbAdWaXNpYmxlCQABCEV4cGFuZGVkCAlGaWVs
        ZE5hbWUGD1VTUiRJTkNMVURFREFURQ1UaXRsZS5DYXB0aW9uBg/E4PLgIOfg9+jx6+Xt6P8FV2lk
        dGgCbAdWaXNpYmxlCQABCUFsaWdubWVudAcOdGFSaWdodEp1c3RpZnkIRXhwYW5kZWQICUZpZWxk
        TmFtZQYMVVNSJERVUkFUSU9ODVRpdGxlLkNhcHRpb24GA8Tt6AVXaWR0aAIkB1Zpc2libGUJCVRv
        dGFsVHlwZQcFdHRTdW0AAQlBbGlnbm1lbnQHDnRhUmlnaHRKdXN0aWZ5CEV4cGFuZGVkCAlGaWVs
        ZE5hbWUGCVVTUiRTVU1NQQ1UaXRsZS5DYXB0aW9uBgXR8+zs4AVXaWR0aAJIB1Zpc2libGUJDURp
        c3BsYXlGb3JtYXQGBCMuIyMJVG90YWxUeXBlBwV0dFN1bQABCEV4cGFuZGVkCAlGaWVsZE5hbWUG
        DVVTUiREQVRFQkVHSU4NVGl0bGUuQ2FwdGlvbgYLxODy4CDt4Pfg6+AFV2lkdGgCbAdWaXNpYmxl
        CQABCEV4cGFuZGVkCAlGaWVsZE5hbWUGC1VTUiREQVRFRU5EDVRpdGxlLkNhcHRpb24GDsTg8uAg
        7uru7ffg7ej/BVdpZHRoAmwHVmlzaWJsZQkAAQlBbGlnbm1lbnQHDnRhUmlnaHRKdXN0aWZ5CEV4
        cGFuZGVkCAlGaWVsZE5hbWUGBlNVTU5DVQ1UaXRsZS5DYXB0aW9uBgZzdW1uY3UFV2lkdGgC/wdW
        aXNpYmxlCAABCEV4cGFuZGVkCAlGaWVsZE5hbWUGDERPQ1VNRU5UREFURQ1UaXRsZS5DYXB0aW9u
        BgTE4PLgBVdpZHRoAv8HVmlzaWJsZQgAAQhFeHBhbmRlZAgJRmllbGROYW1lBgtERVNDUklQVElP
        Tg1UaXRsZS5DYXB0aW9uBgjO7+jx4O3o5QVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZp
        ZWxkTmFtZQYOVVNSJFNPUlROVU1CRVIIUmVhZE9ubHkIDVRpdGxlLkNhcHRpb24GFM3u7OXwIOTr
        /yDx7vDy6PDu4uroBVdpZHRoAv8HVmlzaWJsZQgAAQhFeHBhbmRlZAgJRmllbGROYW1lBgJJRA1U
        aXRsZS5DYXB0aW9uBgTK6/73BVdpZHRoAv8HVmlzaWJsZQgAAQhFeHBhbmRlZAgJRmllbGROYW1l
        BgZQQVJFTlQNVGl0bGUuQ2FwdGlvbgYI0O7k6PLl6/wFV2lkdGgC/wdWaXNpYmxlCAABCEV4cGFu
        ZGVkCAlGaWVsZE5hbWUGD0RPQ1VNRU5UVFlQRUtFWQ1UaXRsZS5DYXB0aW9uBg3S6O8g5O7q8+zl
        7fLgBVdpZHRoAv8HVmlzaWJsZQgAAQhFeHBhbmRlZAgJRmllbGROYW1lBglUUlRZUEVLRVkNVGl0
        bGUuQ2FwdGlvbgYO0ujvIPLw4O3n4Or26OgFV2lkdGgC/wdWaXNpYmxlCAABCEV4cGFuZGVkCAlG
        aWVsZE5hbWUGDlRSQU5TQUNUSU9OS0VZDVRpdGxlLkNhcHRpb24GCtLw4O3n4Or26P8FV2lkdGgC
        /wdWaXNpYmxlCAABCEV4cGFuZGVkCAlGaWVsZE5hbWUGBk5VTUJFUg1UaXRsZS5DYXB0aW9uBgXN
        7uzl8AVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZpZWxkTmFtZQYHU1VNQ1VSUg1UaXRs
        ZS5DYXB0aW9uBg7R8+zs4CDiIOLg6/7y5QVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZp
        ZWxkTmFtZQYHREVMQVlFRA1UaXRsZS5DYXB0aW9uBgrO8uvu5uXt7fvpBVdpZHRoAv8HVmlzaWJs
        ZQgAAQhFeHBhbmRlZAgJRmllbGROYW1lBgdDVVJSS0VZDVRpdGxlLkNhcHRpb24GBsLg6/7y4AVX
        aWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZpZWxkTmFtZQYKQ09NUEFOWUtFWQ1UaXRsZS5D
        YXB0aW9uBgjK7uzv4O3o/wVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZpZWxkTmFtZQYK
        Q1JFQVRPUktFWQ1UaXRsZS5DYXB0aW9uBgrK8u4g8e7n5ODrBVdpZHRoAv8HVmlzaWJsZQgAAQhF
        eHBhbmRlZAgJRmllbGROYW1lBgxDUkVBVElPTkRBVEUNVGl0bGUuQ2FwdGlvbgYNxODy4CDx7ufk
        4O3o/wVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZpZWxkTmFtZQYJRURJVE9SS0VZDVRp
        dGxlLkNhcHRpb24GDMry7iDo8e/w4OLo6wVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZp
        ZWxkTmFtZQYLRURJVElPTkRBVEUNVGl0bGUuQ2FwdGlvbgYOxODy4CDo5+zl7eXt6P8FV2lkdGgC
        /wdWaXNpYmxlCAABCEV4cGFuZGVkCAlGaWVsZE5hbWUGCVBSSU5UREFURQ1UaXRsZS5DYXB0aW9u
        BgvE4PLgIO/l9+Dy6AVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZpZWxkTmFtZQYIRElT
        QUJMRUQNVGl0bGUuQ2FwdGlvbgYJzvLq6/735e3uBVdpZHRoAv8HVmlzaWJsZQgAAQhFeHBhbmRl
        ZAgJRmllbGROYW1lBghSRVNFUlZFRA1UaXRsZS5DYXB0aW9uBg/H4PDl5+Xw4ujw7uLg7e4FV2lk
        dGgC/wdWaXNpYmxlCAABCEV4cGFuZGVkCAlGaWVsZE5hbWUGC0RPQ1VNRU5US0VZCFJlYWRPbmx5
        CQ1UaXRsZS5DYXB0aW9uBg7K6/73IOTu6vPs5e3y4AVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5k
        ZWQICUZpZWxkTmFtZQYJTUFTVEVSS0VZCFJlYWRPbmx5CQ1UaXRsZS5DYXB0aW9uBifQ7uTo8uXr
        /CAozeD36PHr5e3o5SDu8u/z8eru4ijv7ufo9uj/KSkFV2lkdGgC/wdWaXNpYmxlCAABCEV4cGFu
        ZGVkCAlGaWVsZE5hbWUGCVJFU0VSVkVEMQhSZWFkT25seQkNVGl0bGUuQ2FwdGlvbgYux+Dw5efl
        8OLo8O7i4O3uICjN4Pfo8evl7ejlIO7y7/Px6u7iKO/u5+j26P8pKQVXaWR0aAL/B1Zpc2libGUI
        AAEIRXhwYW5kZWQICUZpZWxkTmFtZQYFU1VNRVENVGl0bGUuQ2FwdGlvbgYT0fPs7OAg4iD96uLo
        4uDr5e3y5QVXaWR0aAL/B1Zpc2libGUIAAEIRXhwYW5kZWQICUZpZWxkTmFtZQYKVVNSJEVRUkFU
        RQ1UaXRsZS5DYXB0aW9uBgnK8/DxIP3q4i4FV2lkdGgC/wdWaXNpYmxlCAABCUFsaWdubWVudAcO
        dGFSaWdodEp1c3RpZnkIRXhwYW5kZWQICUZpZWxkTmFtZQYFQUZVTEwNVGl0bGUuQ2FwdGlvbgYN
        z+7r7fvpIOTu8fLz7wVXaWR0aAL/B1Zpc2libGUIAAEJQWxpZ25tZW50Bw50YVJpZ2h0SnVzdGlm
        eQhFeHBhbmRlZAgJRmllbGROYW1lBgVBQ0hBRw1UaXRsZS5DYXB0aW9uBhnP8O7x7O7y8CDoIPDl
        5ODq8ujw7uLg7ejlBVdpZHRoAv8HVmlzaWJsZQgAAQlBbGlnbm1lbnQHDnRhUmlnaHRKdXN0aWZ5
        CEV4cGFuZGVkCAlGaWVsZE5hbWUGBUFWSUVXDVRpdGxlLkNhcHRpb24GD9Lu6/zq7iDv8O7x7O7y
        8AVXaWR0aAL/B1Zpc2libGUIAAAICP0cCQg=
      EDITIONDATE: 2014-02-26T15:58:19+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 154648246_77029543
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "pnlMaster(TPanel)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2013-08-12T19:08:11+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 154648247_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 154648246_77029543
    Fields: 
      PARENT: "154648246_77029543 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)\\pnlMaster(TPanel)"
      NAME: "Height"
      DATA_TYPE: "I"
      STR_DATA: ~
      INT_DATA: 273
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2014-03-03T17:40:45+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 147063989_1439110857
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
    Fields: 
      PARENT: "147063986_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "usrg_grAvgSalaryStr(TgsIBGrid)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2010-04-20T13:32:16+03:00
  - 
    Properties: 
      Class: "TgdcStorageValue"
      RUID: 147123780_1439110857
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: True
      HeadObject: 147063989_1439110857
    Fields: 
      PARENT: "147063989_1439110857 USER - Administrator\\gdc_dlgUserComplexDocument147020774_119619099(Tgdc_dlgUserComplexDocument)\\usrg_grAvgSalaryStr(TgsIBGrid)"
      NAME: "data"
      DATA_TYPE: "B"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: !!binary > 
        VFBGMAYNR1JJRF9TVFJFQU1fNAEGBlRhaG9tYQYMY2xXaW5kb3dUZXh0AvUAAggAA8wAAAYIY2xX
        aW5kb3cBBgZUYWhvbWEGD2NsSGlnaGxpZ2h0VGV4dAL1AAIIAAPMAAAGC2NsSGlnaGxpZ2h0AQYG
        VGFob21hBgxjbFdpbmRvd1RleHQC9QACCAADzAAABgljbEJ0bkZhY2UJBgkkMDBFN0YzRjcGCSQw
        MEQ2RTdFNw4BDERpc3BsYXlGaWVsZAYHVVNSJERPVwlGaWVsZE5hbWUGB1VTUiRIT1cJTGluZUNv
        dW50AgEHT3B0aW9ucwsLY2VvQWRkRmllbGQAAAEMRGlzcGxheUZpZWxkBhBVU1IkU0NIRURVTEVS
        RE9XCUZpZWxkTmFtZQYQVVNSJFNDSEVEVUxFUkhPVwlMaW5lQ291bnQCAQdPcHRpb25zCwtjZW9B
        ZGRGaWVsZAAAAQxEaXNwbGF5RmllbGQGDVVTUiRORVdTQUxBUlkJRmllbGROYW1lBg1VU1IkT0xE
        U0FMQVJZCUxpbmVDb3VudAIBB09wdGlvbnMLC2Nlb0FkZEZpZWxkAAABDERpc3BsYXlGaWVsZAYK
        VVNSJFNBTEFSWQlGaWVsZE5hbWUGEFVTUiRNT0RFUk5TQUxBUlkJTGluZUNvdW50AgEHT3B0aW9u
        cwsLY2VvQWRkRmllbGQAAAAICA4ACA4BCUFsaWdubWVudAcNdGFMZWZ0SnVzdGlmeQhFeHBhbmRl
        ZAgJRmllbGROYW1lBgpVU1IkSVNGVUxMDVRpdGxlLkNhcHRpb24GDM/u6+376SDs5fH/9gVXaWR0
        aAIwB1Zpc2libGUJAAEJQWxpZ25tZW50Bw10YUxlZnRKdXN0aWZ5CEV4cGFuZGVkCAlGaWVsZE5h
        bWUGC1VTUiRJU0NIRUNLDVRpdGxlLkNhcHRpb24GBMLq6y4FV2lkdGgCMAdWaXNpYmxlCQlUb3Rh
        bFR5cGUHBXR0U3VtAAEJQWxpZ25tZW50Bw10YUxlZnRKdXN0aWZ5CEV4cGFuZGVkCAlGaWVsZE5h
        bWUGCFVTUiREQVRFDVRpdGxlLkNhcHRpb24GBMTg8uAFV2lkdGgCSAdWaXNpYmxlCQABCUFsaWdu
        bWVudAcOdGFSaWdodEp1c3RpZnkIRXhwYW5kZWQICUZpZWxkTmFtZQYKVVNSJFNBTEFSWQ1UaXRs
        ZS5DYXB0aW9uBgjH4PDv6+Dy4AVXaWR0aAJIB1Zpc2libGUJDURpc3BsYXlGb3JtYXQGBCMuIyMA
        AQlBbGlnbm1lbnQHDnRhUmlnaHRKdXN0aWZ5CEV4cGFuZGVkCAlGaWVsZE5hbWUGCVVTUiRDT0VG
        Rg1UaXRsZS5DYXB0aW9uBgbK7v30LfIFV2lkdGgCNAdWaXNpYmxlCQABCUFsaWdubWVudAcOdGFS
        aWdodEp1c3RpZnkIRXhwYW5kZWQICUZpZWxkTmFtZQYQVVNSJE1PREVSTlNBTEFSWQ1UaXRsZS5D
        YXB0aW9uBhTR7uLw5ezl7e3g/yDn4PDv6+Dy4AVXaWR0aAJUB1Zpc2libGUJDURpc3BsYXlGb3Jt
        YXQGBCMuIyMJVG90YWxUeXBlBwV0dFN1bQABCUFsaWdubWVudAcOdGFSaWdodEp1c3RpZnkIRXhw
        YW5kZWQICUZpZWxkTmFtZQYHVVNSJERPVw1UaXRsZS5DYXB0aW9uBgPE7egFV2lkdGgCJAdWaXNp
        YmxlCQlUb3RhbFR5cGUHBXR0U3VtAAEJQWxpZ25tZW50Bw10YUxlZnRKdXN0aWZ5CEV4cGFuZGVk
        CAlGaWVsZE5hbWUGEFVTUiRTQ0hFRFVMRVJET1cNVGl0bGUuQ2FwdGlvbgYLxO3l6SDv7iDj8C4F
        V2lkdGgCSAdWaXNpYmxlCQABCUFsaWdubWVudAcOdGFSaWdodEp1c3RpZnkIRXhwYW5kZWQICUZp
        ZWxkTmFtZQYHVVNSJEhPVw1UaXRsZS5DYXB0aW9uBgTX4PH7BVdpZHRoAisHVmlzaWJsZQkJVG90
        YWxUeXBlBwV0dFN1bQABCUFsaWdubWVudAcNdGFMZWZ0SnVzdGlmeQhFeHBhbmRlZAgJRmllbGRO
        YW1lBhBVU1IkU0NIRURVTEVSSE9XDVRpdGxlLkNhcHRpb24GDNfg8e7iIO/uIOPwLgVXaWR0aAJM
        B1Zpc2libGUJAAEJQWxpZ25tZW50Bw10YUxlZnRKdXN0aWZ5CEV4cGFuZGVkCAlGaWVsZE5hbWUG
        D1VTUiRERVNDUklQVElPTg1UaXRsZS5DYXB0aW9uBgjO7+jx4O3o5QVXaWR0aAPeAAdWaXNpYmxl
        CQABCUFsaWdubWVudAcNdGFMZWZ0SnVzdGlmeQhFeHBhbmRlZAgJRmllbGROYW1lBg1VU1IkT0xE
        U0FMQVJZDVRpdGxlLkNhcHRpb24GBc7q6+DkBVdpZHRoAv8HVmlzaWJsZQgAAQlBbGlnbm1lbnQH
        DXRhTGVmdEp1c3RpZnkIRXhwYW5kZWQICUZpZWxkTmFtZQYNVVNSJE5FV1NBTEFSWQ1UaXRsZS5D
        YXB0aW9uBg3S5erz+ejpIO7q6+DkBVdpZHRoAv8HVmlzaWJsZQgAAQlBbGlnbm1lbnQHDXRhTGVm
        dEp1c3RpZnkIRXhwYW5kZWQICUZpZWxkTmFtZQYCSUQIUmVhZE9ubHkJDVRpdGxlLkNhcHRpb24G
        Dcjk5e3y6PTo6uDy7vAFV2lkdGgC/wdWaXNpYmxlCAABCUFsaWdubWVudAcNdGFMZWZ0SnVzdGlm
        eQhFeHBhbmRlZAgJRmllbGROYW1lBg9VU1IkRE9DVU1FTlRLRVkNVGl0bGUuQ2FwdGlvbgYIxO7q
        8+zl7fIFV2lkdGgC/wdWaXNpYmxlCAABCUFsaWdubWVudAcNdGFMZWZ0SnVzdGlmeQhFeHBhbmRl
        ZAgJRmllbGROYW1lBhhaX1VTUiRET0NVTUVOVEtFWV9OVU1CRVINVGl0bGUuQ2FwdGlvbgYFze7s
        5fAFV2lkdGgC/wdWaXNpYmxlCAABCUFsaWdubWVudAcNdGFMZWZ0SnVzdGlmeQhFeHBhbmRlZAgJ
        RmllbGROYW1lBh5aX1VTUiRET0NVTUVOVEtFWV9ET0NVTUVOVERBVEUNVGl0bGUuQ2FwdGlvbgYE
        xODy4AVXaWR0aAL/B1Zpc2libGUIAAAICP0MCQg=
      EDITIONDATE: 2014-02-26T15:58:19+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151189469_18175251
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "lib"
      COMMENT: ~
      SCRIPT: | 
        % lib
        
        % подготовка SQL-строки
        prepare_sql(InSQL, [], InSQL) :-
            !.
        prepare_sql(InSQL,[Key-Value|Pairs], OutSQL) :-
            replace_all(InSQL, Key, Value, InSQL1),
            !,
            prepare_sql(InSQL1, Pairs, OutSQL).
        
        % to_currency(+NumIn, -NumOut)
        to_currency(NumIn, NumOut) :-
            to_currency(NumIn, NumOut, 4),
            !.
        % to_currency(+NumIn, -NumOut, +Round)
        to_currency(NumIn, NumOut, Round) :-
            number(NumIn), integer(Round),
            NumOut is float( round( NumIn * (10 ** Round) ) / (10 ** Round) ),
            !.
        
        % make_list(+Num, -List)
        make_list(Num, List) :-
            integer(Num),
            make_list(Num, List, 0),
            !.
        
        make_list(Num, [], Num) :-
            !.
        make_list(Num, [_|Tail], Zero) :-
            Num1 is Num - 1,
            !,
            make_list(Num1, Tail, Zero).
        
        % replace_all(+In, +Search, +Replace, -Out)
        replace_all(In, Search, Replace, Out) :-
            replace(In, Search, Replace, In1),
            \+ In = In1,
            !,
            replace_all(In1, Search, Replace, Out).
        replace_all(In, _, _, In).
        
        % replace(+In, +Search, +Replace, -Out)
        replace(In, Search, Replace, Out) :-
            text_list([In, Search, Replace], [InCodes, SearchCodes, ReplaceCodes]),
            replace_list(InCodes, SearchCodes, ReplaceCodes, OutCodes),
            text_in_out(In, OutCodes, Out),
            !.
        replace(In, _, _, In).
        
        %
        text_list([], []) :-
            !.
        text_list([Head|Teil], [Head1|Rest]) :-
            text_in_out(Head, Head1, Head),
            !,
            text_list(Teil, Rest).
        
        %
        text_in_out(In, OutCodes, Out) :-
            ( atom(In), atom_codes(Out, OutCodes)
            ; string(In), string_codes(Out, OutCodes)
            ; number(In), number_codes(Out, OutCodes)
            ; integer_list(In), Out = In ),
            !,
            \+ In = [].
        
        %
        integer_list([]).
        integer_list([Head|Tail]) :-
            integer(Head),
            integer_list(Tail).
        
        %
        replace_list([InHead1,InHead2,InHead3|InChars], [InHead1,InHead2,InHead3|SearchChars], ReplaceChars, OutChars) :-
            append([InHead1,InHead2,InHead3|SearchChars], RestChars, [InHead1,InHead2,InHead3|InChars]),
            append(ReplaceChars, RestChars, OutChars),
            !.
        replace_list([InHead|InChars], [InHead|SearchChars], ReplaceChars, OutChars) :-
            append([InHead|SearchChars], RestChars, [InHead|InChars]),
            append(ReplaceChars, RestChars, OutChars),
            !.
        replace_list([InHead|InTail], SearchChars, ReplaceChars, [InHead|OutChars]) :-
            !,
            replace_list(InTail, SearchChars, ReplaceChars, OutChars).
        
        %
        remove_list(_, [], []) :-
            !.
        remove_list([Elem|Elems], List, Rest) :-
            remove_list(Elem, List, List1),
            remove_list(Elems, List1, Rest),
            !.
        remove_list(Elem, [Elem|[]], []).
        remove_list(Elem, [Elem|Tail], Rest) :-
            remove_list(Elem, Tail, Rest),
            !.
        remove_list(Elem, [Head|Tail], [Head|Rest]) :-
            remove_list(Elem, Tail, Rest).
        
        %
        member_list([], _) :-
            !.
        member_list([Head|Tail], List) :-
            member(Head, List),
            !,
            member_list(Tail, List).
        
        %
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-03T10:42:26+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151189468_18175251
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "params"
      COMMENT: ~
      SCRIPT: | 
        % params
        
        %:- ensure_loaded(lib).
        /* remove_list, member_list */
        
        :-
            dynamic(param_list/3),
            multifile(param_list/3),
            discontiguous(param_list/3).
        
        % param_list(?Scope, ?Type, ?Pairs)
        %   Scope - name of context
        %   Type  - protocol support
        %       Client: in; data; got; restart; test; ...
        %       Server: run; query; temp; log; out; clean; error; ...
        %   Pairs - list of pairs Key-Value or mixed with other
        
        % new_param_list(+Scope, +Type, +Pairs)
        new_param_list(Scope, Type, Pairs) :-
            ground([Scope, Type, Pairs]),
            ( \+ param_list(Scope, Type, Pairs),
              assertz( param_list(Scope, Type, Pairs) ) ; true ),
            !.
        
        % dispose_param_list(?Scope, ?Type, ?Pairs)
        dispose_param_list(Scope, Type, Pairs) :-
            retractall( param_list(Scope, Type, Pairs) ),
            !.
        
        % get_param(?Scope, ?Type, ?Param)
        get_param(Scope, Type, Param) :-
            param_list(Scope, Type, Pairs),
            once( member(Param, Pairs) ).
        % get_param(?Scope, ?Type, ?Param, ?Pairs)
        get_param(Scope, Type, Param, Pairs) :-
            param_list(Scope, Type, Pairs),
            once( member(Param, Pairs) ).
        
        % get_param_list(?Scope, ?Type, ?Params)
        get_param_list(Scope, Type, Params) :-
            param_list(Scope, Type, Pairs),
            once( member_list(Params, Pairs) ).
        % get_param_list(?Scope, ?Type, ?Params, ?Pairs)
        get_param_list(Scope, Type, Params, Pairs) :-
            param_list(Scope, Type, Pairs),
            once( member_list(Params, Pairs) ).
        
        % find_param(+Scope, +Type, +Key1-Value1, ?Key2-Value2)
        find_param(Scope, Type, Key1-Value1, Key2-Value2) :-
            find_param_list(Scope, Type, Key1-Value1, Pairs),
            once( member(Key2-Value2, Pairs) ).
        % find_param(+Scope, +Type, +Pairs0, ?Key-Value)
        find_param(Scope, Type, Pairs0, Key-Value) :-
            find_param_list(Scope, Type, Pairs0, Pairs),
            once( member(Key-Value, Pairs) ).
        
        % find_param_list(+Scope, +Type, +Key-Value, ?Pairs)
        find_param_list(Scope, Type, Key-Value, Pairs) :-
            ground([Scope, Type, Key-Value]),
            param_list(Scope, Type, Pairs0),
            once( member(Key-Value, Pairs0) ),
            remove_list(Key-Value, Pairs0, Pairs).
        % find_param_list(+Scope, +Type, +Pairs0, ?Pairs)
        find_param_list(Scope, Type, Pairs0, Pairs) :-
            ground([Scope, Type, Pairs0]),
            Pairs0 = [Key-Value|Tail],
            find_param_list(Scope, Type, Key-Value, Pairs1),
            once( member_list(Tail, Pairs1) ),
            remove_list(Tail, Pairs1, Pairs).
        
        %
        get_scope(Scope) :-
            findall(Scope0, param_list(Scope0, _, _), ScopeList0),
            sort(ScopeList0, ScopeList),
            member(Scope, ScopeList).
        
        %
        get_scope_list(ScopeList) :-
            findall(Scope0, param_list(Scope0, _, _), ScopeList0),
            sort(ScopeList0, ScopeList),
            !.
        
        %
        get_type(Type) :-
            findall(Type0, param_list(_, Type0, _), TypeList0),
            sort(TypeList0, TypeList),
            member(Type, TypeList).
        
        %
        get_type_list(TypeList) :-
            findall(Type0, param_list(_, Type0, _), TypeList0),
            sort(TypeList0, TypeList),
            !.
        
        %
        get_scope_type(Scope-Type) :-
            findall(Scope0-Type0, param_list(Scope0, Type0, _), ScopeTypeList0),
            sort(ScopeTypeList0, ScopeTypeList),
            member(Scope-Type, ScopeTypeList).
        
        %
        get_scope_type_list(ScopeTypeList) :-
            findall(Scope0-Type0, param_list(Scope0, Type0, _), ScopeTypeList0),
            sort(ScopeTypeList0, ScopeTypeList),
            !.
        
        %
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-01-03T15:11:52+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151189470_18175251
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 151189370_18175251
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "twg_avg_wage_sql"
      COMMENT: ~
      SCRIPT: | 
        % twg_avg_wage_sql
        
        :-
            GetSQL = [gd_pl_ds/5, get_sql/5],
            %dynamic(GetSQL),
            multifile(GetSQL),
            discontiguous(GetSQL).
        
        %
        wg_valid_sql([
                    %  05. Начисление отпусков
                    usr_wg_DbfSums/6, % 05, 06
                    usr_wg_MovementLine/15, % 05, 06
                    usr_wg_FCRate/4,
                    usr_wg_TblDayNorm/8,
                    usr_wg_TblYearNorm/5,
                    usr_wg_TblCalLine/7, % 05, 06
                    usr_wg_TblCal_FlexLine/68, % 05, 06
                    usr_wg_HourType/12, % 05, 06
                    usr_wg_TblCharge/9, % 05, 06
                    usr_wg_FeeType/5, % 05, 06
                    usr_wg_FeeTypeNoCoef/4,
                    usr_wg_BadHourType/3,
                    usr_wg_BadFeeType/3,
                    %  06. Начисление больничных
                    usr_wg_FeeTypeProp/4,
                    wg_holiday/1,
                    usr_wg_ExclDays/5
                    ]).
        
        %
        is_valid_sql(Functor/Arity) :-
            wg_valid_sql(ValidSQL),
            member(Functor/Arity, ValidSQL),
            !.
        
        %  05. Начисление отпусков
        gd_pl_ds(wg_avg_wage_vacation, in, usr_wg_DbfSums, 6,
            [
            fEmplKey-integer, fInSum-float, fInHoures-float,
            fInYear-integer, fInMonth-integer, fDateBegin-date
            ]).
        % usr_wg_DbfSums(EmplKey, InSum, InHoures, InYear, InMonth, DateBegin)
        get_sql(wg_avg_wage_vacation, in, usr_wg_DbfSums/6,
        "SELECT \c
          Z.USR$EMPLKEY, \c
          COALESCE(Z.USR$SUM, 0) AS INSUM, \c
          COALESCE(Z.USR$MID_HOW, 0) AS INHOURES, \c
          EXTRACT(YEAR FROM IDK.USR$DATEBEGIN) AS InYear, \c
          EXTRACT(MONTH FROM IDK.USR$DATEBEGIN) AS InMonth, \c
          IDK.USR$DATEBEGIN \c
        FROM \c
          USR$GMK_SUMS Z \c
        JOIN \c
          USR$WG_TOTAL IDK \c
            ON IDK.DOCUMENTKEY  =  Z.USR$INDOCKEY \c
        WHERE \c
          Z.USR$EMPLKEY = pEmplKey \c
          AND \c
          IDK.USR$DATEBEGIN >= \'pDateCalcFrom\' \c
          AND \c
          IDK.USR$DATEBEGIN < \'pDateCalcTo\' \c
        ORDER BY \c
          Z.USR$EMPLKEY, \c
          IDK.USR$DATEBEGIN \c
        ",
        [pEmplKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ).
        
        gd_pl_ds(Scope, in, usr_wg_MovementLine, 15,
            [
            fEmplKey-integer, fDocumentKey-integer, fFirstMoveKey-integer,
            fMoveYear-integer, fMoveMonth-integer, fDateBegin-date,
            fScheduleKey-integer, fMovementType-integer,
            fRate-float, fListNumber-string, fMSalary-float,
            fPayFormKey-integer, fSalaryKey-integer, fTSalary-float, fAvgWageRate-float
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_MovementLine(EmplKey, DocumentKey, FirstMoveKey,
        %   MoveYear, MoveMonth, DateBegin,
        %   ScheduleKey, MovementType, Rate, ListNumber, MSalary,
        %   PayFormKey, SalaryKey, TSalary, AvgWageRate)
        get_sql(Scope, in, usr_wg_MovementLine/15,
        "SELECT \c
          ml.USR$EMPLKEY, \c
          ml.DOCUMENTKEY, \c
          ml.USR$FIRSTMOVE AS FirstMoveKey, \c
          EXTRACT(YEAR FROM ml.USR$DATEBEGIN) AS MoveYear, \c
          EXTRACT(MONTH FROM ml.USR$DATEBEGIN) AS MoveMonth, \c
          ml.USR$DATEBEGIN, \c
          ml.USR$SCHEDULEKEY, \c
          ml.USR$MOVEMENTTYPE, \c
          COALESCE(ml.USR$RATE, 0) AS Rate, \c
          ml.USR$LISTNUMBER, \c
          COALESCE(ml.USR$MSALARY, 0) AS MSalary, \c
          COALESCE(ml.USR$PAYFORMKEY, 0) AS PayFormKey, \c
          (SELECT id FROM gd_ruid WHERE xid = pPayFormSalary_xid AND dbid = pPayFormSalary_dbid) AS SalaryKey, \c
          COALESCE(ml.USR$TSALARY, 0) AS TSalary, \c
          8 * COALESCE(USR$THOURRATE, 0) AS AvgWageRate \c
        FROM \c
          USR$WG_MOVEMENTLINE ml \c
        WHERE \c
          ml.USR$EMPLKEY = pEmplKey \c
          AND \c
          ml.USR$FIRSTMOVE = pFirstMoveKey \c
        ORDER BY \c
          ml.USR$EMPLKEY, \c
          ml.USR$FIRSTMOVE, \c
          ml.USR$DATEBEGIN \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pPayFormSalary_xid-_, pPayFormSalary_dbid-_]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(wg_avg_wage_vacation, in, usr_wg_FCRate, 4,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fDate-date, fFCRateSum-float
            ]).
        % usr_wg_FCRate(EmplKey, FirstMoveKey, Date, FCRateSum)
        get_sql(wg_avg_wage_vacation, in, usr_wg_FCRate/4,
        "SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          fc.USR$WG_DATE, \c
          fc.USR$WG_FCRATESUM \c
        FROM \c
          USR$WG_FCRATE fc \c
        ORDER BY \c
          fc.USR$WG_DATE \c
        ",
        [pEmplKey-_, pFirstMoveKey-_]
            ).
        
        gd_pl_ds(Scope, in, usr_wg_TblDayNorm, 8,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fWYear-integer, fWMonth-integer, fTheDay-date, fWDay-integer,
            fWDuration-float, fWorkDay-integer
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_TblDayNorm(EmplKey, FirstMoveKey, WYear, WMonth, TheDay, WDay, WDuration, WorkDay)
        get_sql(Scope, in, usr_wg_TblDayNorm/8,
        "\c
        SELECT EmplKey, FirstMoveKey, WYear, WMonth, TheDay, WDay, WDuration, WorkDay \c
        FROM USR$WG_TBLCALDAY_P(pEmplKey, pFirstMoveKey, \'pDateCalcFrom\', \'pDateCalcTo\') \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(wg_avg_wage_vacation, in, usr_wg_TblYearNorm, 5,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fWYear-integer,
            fWHoures-float, fWDays-integer
            ]).
        % usr_wg_TblYearNorm(EmplKey, FirstMoveKey, WYear, WHoures, WDays)
        get_sql(wg_avg_wage_vacation, in, usr_wg_TblYearNorm/5,
        "\c
        SELECT EmplKey, FirstMoveKey, WYear, SUM(WDuration) AS WHoures, SUM(WorkDay) AS WDays \c
        FROM USR$WG_TBLCALDAY_P(pEmplKey, pFirstMoveKey, \'pDateNormFrom\', \'pDateNormTo\') \c
        GROUP BY EmplKey, FirstMoveKey, WYear \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateNormFrom-_, pDateNormTo-_]
            ).
        
        gd_pl_ds(Scope, in, usr_wg_TblCalLine, 7,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fCalYear-integer, fCalMonth-integer, fDate-date,
            fDuration-float, fHoureType-integer
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_TblCalLine(EmplKey, FirstMoveKey, CalYear, CalMonth, Date, Duration, HoureType)
        get_sql(Scope, in, usr_wg_TblCalLine/7,
        "SELECT \c
          tc.USR$EMPLKEY, \c
          tc.USR$FIRSTMOVEKEY, \c
          EXTRACT(YEAR FROM tcl.USR$DATE) AS CalYear, \c
          EXTRACT(MONTH FROM tcl.USR$DATE) AS CalMonth, \c
          tcl.USR$DATE, \c
          tcl.USR$DURATION, \c
          tcl.USR$HOURTYPE \c
        FROM \c
          USR$WG_TBLCAL tc \c
        JOIN \c
          USR$WG_TBLCALLINE tcl \c
            ON tcl.MASTERKEY = tc.DOCUMENTKEY \c
        WHERE \c
          tc.USR$EMPLKEY = pEmplKey \c
          AND \c
          tc.USR$FIRSTMOVEKEY = pFirstMoveKey \c
          AND \c
          tcl.USR$DATE >= \'pDateCalcFrom\' \c
          AND \c
          tcl.USR$DATE < \'pDateCalcTo\' \c
        ORDER BY \c
          tc.USR$EMPLKEY, \c
          tc.USR$FIRSTMOVEKEY, \c
          tcl.USR$DATE \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(Scope, in, usr_wg_TblCal_FlexLine, 68,
            [fFlexType-string,
            fEmplKey-integer, fFirstMoveKey-integer,
            fCalYear-integer, fCalMonth-integer, fDateBegin-date,
            fS1-variant, fH1-variant, fS2-variant, fH2-variant,
            fS3-variant, fH3-variant, fS4-variant, fH4-variant,
            fS5-variant, fH5-variant, fS6-variant, fH6-variant,
            fS7-variant, fH7-variant, fS8-variant, fH8-variant,
            fS9-variant, fH9-variant, fS10-variant, fH10-variant,
            fS11-variant, fH11-variant, fS12-variant, fH12-variant,
            fS13-variant, fH13-variant, fS14-variant, fH14-variant,
            fS15-variant, fH15-variant, fS16-variant, fH16-variant,
            fS17-variant, fH17-variant, fS18-variant, fH18-variant,
            fS19-variant, fH19-variant, fS20-variant, fH20-variant,
            fS21-variant, fH21-variant, fS22-variant, fH22-variant,
            fS23-variant, fH23-variant, fS24-variant, fH24-variant,
            fS25-variant, fH25-variant, fS26-variant, fH26-variant,
            fS27-variant, fH27-variant, fS28-variant, fH28-variant,
            fS29-variant, fH29-variant, fS30-variant, fH30-variant,
            fS31-variant, fH31-variant
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_TblCal_FlexLine(FlexType, EmplKey, FirstMoveKey, CalYear, CalMonth, DateBegin, S1, H1, ..., S31, H31)
        get_sql(Scope, in, usr_wg_TblCal_FlexLine/68,
        "SELECT \c
          CASE gd.DOCUMENTTYPEKEY \c
            WHEN \c
              (SELECT id FROM gd_ruid \c
              WHERE xid = pTblCal_DocType_Plan_xid AND dbid = pTblCal_DocType_Plan_dbid) \c
                THEN \'plan\' \c
            WHEN \c
              (SELECT id FROM gd_ruid \c
              WHERE xid = pTblCal_DocType_Fact_xid AND dbid = pTblCal_DocType_Fact_dbid) \c
                THEN \'fact\' \c
            ELSE \c
                \'unknown\' \c
          END \c
            AS FlexType, \c
          tcfl.USR$EMPLKEY, \c
          tcfl.USR$FIRSTMOVEKEY, \c
          EXTRACT(YEAR FROM t.USR$DATEBEGIN) AS CalYear, \c
          EXTRACT(MONTH FROM t.USR$DATEBEGIN) AS CalMonth, \c
          t.USR$DATEBEGIN, \c
          tcfl.USR$S1, tcfl.USR$H1, tcfl.USR$S2, tcfl.USR$H2, \c
          tcfl.USR$S3, tcfl.USR$H3, tcfl.USR$S4, tcfl.USR$H4, \c
          tcfl.USR$S5, tcfl.USR$H5, tcfl.USR$S6, tcfl.USR$H6, \c
          tcfl.USR$S7, tcfl.USR$H7, tcfl.USR$S8, tcfl.USR$H8, \c
          tcfl.USR$S9, tcfl.USR$H9, tcfl.USR$S10, tcfl.USR$H10, \c
          tcfl.USR$S11, tcfl.USR$H11, tcfl.USR$S12, tcfl.USR$H12, \c
          tcfl.USR$S13, tcfl.USR$H13, tcfl.USR$S14, tcfl.USR$H14, \c
          tcfl.USR$S15, tcfl.USR$H15, tcfl.USR$S16, tcfl.USR$H16, \c
          tcfl.USR$S17, tcfl.USR$H17, tcfl.USR$S18, tcfl.USR$H18, \c
          tcfl.USR$S19, tcfl.USR$H19, tcfl.USR$S20, tcfl.USR$H20, \c
          tcfl.USR$S21, tcfl.USR$H21, tcfl.USR$S22, tcfl.USR$H22, \c
          tcfl.USR$S23, tcfl.USR$H23, tcfl.USR$S24, tcfl.USR$H24, \c
          tcfl.USR$S25, tcfl.USR$H25, tcfl.USR$S26, tcfl.USR$H26, \c
          tcfl.USR$S27, tcfl.USR$H27, tcfl.USR$S28, tcfl.USR$H28, \c
          tcfl.USR$S29, tcfl.USR$H29, tcfl.USR$S30, tcfl.USR$H30, \c
          tcfl.USR$S31, tcfl.USR$H31 \c
        FROM \c
          GD_DOCUMENT gd \c
        JOIN \c
          USR$WG_TBLCAL_FLEXLINE tcfl \c
            ON gd.ID = tcfl.DOCUMENTKEY \c
        JOIN \c
          USR$WG_TBLCAL_FLEX tcf \c
            ON tcf.DOCUMENTKEY = tcfl.MASTERKEY \c
        JOIN \c
          USR$WG_TOTAL t \c
            ON t.DOCUMENTKEY = tcf.USR$TOTALDOCKEY \c
        WHERE \c
          tcfl.USR$EMPLKEY = pEmplKey \c
          AND \c
          tcfl.USR$FIRSTMOVEKEY = pFirstMoveKey \c
          AND \c
          t.USR$DATEBEGIN >= \'pDateCalcFrom\' \c
          AND \c
          t.USR$DATEBEGIN < \'pDateCalcTo\' \c
         ORDER BY \c
           tcfl.USR$EMPLKEY, \c
           tcfl.USR$FIRSTMOVEKEY, \c
           t.USR$DATEBEGIN \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateCalcFrom-_, pDateCalcTo-_,
        pTblCal_DocType_Plan_xid-_, pTblCal_DocType_Plan_dbid-_,
        pTblCal_DocType_Fact_xid-_, pTblCal_DocType_Fact_dbid-_
        ]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(Scope, in, usr_wg_HourType, 12,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fID-integer, fCode-string, fDigitCode-string,
            fDiscription-string, fIsWorked-integer, fShortName-string,
            fForCalFlex-integer, fForOverTime-integer, fForFlex-integer,
            fExcludeForSickList-integer
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_HourType(EmplKey, FirstMoveKey,
        %   ID, Code, DigitCode, Description, IsWorked, ShortName,
        %   ForCalFlex, ForOverTime, ForFlex, ExcludeForSickList)
        get_sql(Scope, in, usr_wg_HourType/12,
        "SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          ht.ID, \c
          ht.USR$CODE, \c
          ht.USR$DIGITCODE, \c
          ht.USR$DISCRIPTION \c,
          ht.USR$ISWORKED, \c
          ht.USR$SHORTNAME, \c
          ht.USR$FORCALFLEX, \c
          ht.USR$FOROVERTIME, \c
          ht.USR$FORFLEX, \c
          ht.USR$WG_EXCLUDEFORSICKLIST \c
        FROM \c
          USR$WG_HOURTYPE ht \c
        ",
        [pEmplKey-_, pFirstMoveKey-_]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(Scope, in, usr_wg_TblCharge, 9,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fCalYear-integer, fCalMonth-integer, fDateBegin-date,
            fDebit-float, fFeeTypeKey-integer, fDOW-float, fHOW-float
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_TblCharge(EmplKey, FirstMoveKey, CalYear, CalMonth, DateBegin,
        %   Debit, FeeTypeKey, DOW, HOW)
        get_sql(Scope, in, usr_wg_TblCharge/9,
        "SELECT \c
          tch.USR$EMPLKEY, \c
          tch.USR$FIRSTMOVEKEY, \c
          EXTRACT(YEAR FROM tch.USR$DATEBEGIN) AS CalYear, \c
          EXTRACT(MONTH FROM tch.USR$DATEBEGIN) AS CalMonth, \c
          tch.USR$DATEBEGIN, \c
          tch.USR$DEBIT, \c
          tch.USR$FEETYPEKEY, \c
          tch.USR$DOW, \c
          tch.USR$HOW \c
        FROM \c
          USR$WG_TBLCHARGE tch \c
        WHERE \c
          tch.USR$EMPLKEY = pEmplKey \c
          AND \c
          NOT tch.USR$DEBIT = 0 \c
          AND \c
          tch.USR$DATEBEGIN >= \'pDateCalcFrom\' \c
          AND \c
          tch.USR$DATEBEGIN < \'pDateCalcTo\' \c
        ORDER BY \c
          tch.USR$EMPLKEY, \c
          tch.USR$DATEBEGIN \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(Scope, in, usr_wg_FeeType, 5,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fFeeGroupKey-integer, fFeeTypeKey-integer, fAvgDayHOW-integer
            ]) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        % usr_wg_FeeType(EmplKey, FirstMoveKey, FeeGroupKey, FeeTypeKey, AvgDayHOW)
        get_sql(Scope, in, usr_wg_FeeType/5,
        "SELECT \c
          pEmplKey AS EmplKey,  \c
          pFirstMoveKey AS FirstMoveKey, \c
          ft.USR$WG_FEEGROUPKEY, \c
          ft.USR$WG_FEETYPEKEY, \c
          ft_avg.USR$AVGDAYHOW \c
        FROM \c
          USR$CROSS179_256548741 ft \c
        JOIN \c
          USR$WG_FEETYPE ft_avg \c
            ON ft_avg.ID = ft.USR$WG_FEETYPEKEY \c
        WHERE \c
          ft.USR$WG_FEEGROUPKEY IN \c
        (SELECT id FROM gd_ruid \c
        WHERE xid = pFeeGroupKey_xid \c
        AND dbid = pFeeGroupKey_dbid \c
        ) \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pFeeGroupKey_xid-_, pFeeGroupKey_dbid-_]
            ) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ).
        
        gd_pl_ds(wg_avg_wage_vacation, in, usr_wg_FeeTypeNoCoef, 4,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fFeeGroupKeyNoCoef-integer, fFeeTypeKeyNoCoef-integer
            ]).
        % usr_wg_FeeTypeNoCoef(EmplKey, FirstMoveKey, FeeGroupKeyNoCoef, FeeTypeKeyNoCoef)
        get_sql(wg_avg_wage_vacation, in, usr_wg_FeeTypeNoCoef/4,
        "SELECT \c
          pEmplKey AS EmplKey,  \c
          pFirstMoveKey AS FirstMoveKey, \c
          ft.USR$WG_FEEGROUPKEY, \c
          ft.USR$WG_FEETYPEKEY \c
        FROM \c
          USR$CROSS179_256548741 ft \c
        JOIN \c
          USR$WG_FEETYPE ft_avg \c
            ON ft_avg.ID = ft.USR$WG_FEETYPEKEY \c
        WHERE \c
          ft.USR$WG_FEEGROUPKEY IN \c
        (SELECT id FROM gd_ruid \c
        WHERE xid = pFeeGroupKeyNoCoef_xid \c
        AND dbid = pFeeGroupKeyNoCoef_dbid \c
        ) \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pFeeGroupKeyNoCoef_xid-_, pFeeGroupKeyNoCoef_dbid-_]
            ).
        
        gd_pl_ds(wg_avg_wage_vacation, in, usr_wg_BadHourType, 3,
            [
            fEmplKey-integer, fFirstMoveKey-integer, fID-integer
            ]).
        % usr_wg_BadHourType(EmplKey, FirstMoveKey, ID)
        get_sql(wg_avg_wage_vacation, in, usr_wg_BadHourType/3,
        "SELECT \c
          pEmplKey AS EmplKey, pFirstMoveKey AS FirstMoveKey, id \c
        FROM USR$WG_HOURTYPE \c
        WHERE id IN \c
        (SELECT id FROM gd_ruid \c
        WHERE xid IN (pBadHourType_xid_IN) \c
        AND dbid = pBadHourType_dbid \c
        ) \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pBadHourType_xid_IN-_, pBadHourType_dbid-_]
            ).
        
        gd_pl_ds(wg_avg_wage_vacation, in, usr_wg_BadFeeType, 3,
            [
            fEmplKey-integer, fFirstMoveKey-integer, fID-integer
            ]).
        % usr_wg_BadFeeType(EmplKey, FirstMoveKey, ID)
        get_sql(wg_avg_wage_vacation, in, usr_wg_BadFeeType/3,
        "SELECT \c
          pEmplKey AS EmplKey, pFirstMoveKey AS FirstMoveKey, id \c
        FROM USR$WG_FEETYPE \c
        WHERE id IN \c
        (SELECT id FROM gd_ruid \c
        WHERE xid IN (pBadFeeType_xid_IN) \c
        AND dbid = pBadFeeType_dbid \c
        ) \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pBadFeeType_xid_IN-_, pBadFeeType_dbid-_]
            ).
        
        %  06. Начисление больничных
        gd_pl_ds(wg_avg_wage_sick, in, usr_wg_DbfSums, 6,
            [
            fEmplKey-integer, fInSum-float, fInHoures-float,
            fInYear-integer, fInMonth-integer, fDateBegin-date
            ]).
        % usr_wg_DbfSums(EmplKey, InSum, InHoures, InYear, InMonth, DateBegin)
        get_sql(wg_avg_wage_sick, in, usr_wg_DbfSums/6,
        "SELECT \c
          Z.USR$EMPLKEY, \c
          COALESCE(Z.USR$SUMSICK, 0) AS INSUM, \c
          COALESCE(Z.USR$MID_HOW, 0) AS INHOURES, \c
          EXTRACT(YEAR FROM IDK.USR$DATEBEGIN) AS InYear, \c
          EXTRACT(MONTH FROM IDK.USR$DATEBEGIN) AS InMonth, \c
          IDK.USR$DATEBEGIN \c
        FROM \c
          USR$GMK_SUMS Z \c
        JOIN \c
          USR$WG_TOTAL IDK \c
            ON IDK.DOCUMENTKEY  =  Z.USR$INDOCKEY \c
        WHERE \c
          Z.USR$EMPLKEY = pEmplKey \c
          AND \c
          IDK.USR$DATEBEGIN >= \'pDateCalcFrom\' \c
          AND \c
          IDK.USR$DATEBEGIN < \'pDateCalcTo\' \c
        ORDER BY \c
          Z.USR$EMPLKEY, \c
          IDK.USR$DATEBEGIN \c
        ",
        [pEmplKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ).
        
        gd_pl_ds(wg_avg_wage_sick, in, usr_wg_FeeTypeProp, 4,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fFeeGroupKeyProp-integer, fFeeTypeKeyProp-integer
            ]).
        % usr_wg_FeeTypeProp(EmplKey, FirstMoveKey, FeeGroupKeyProp, FeeTypeKeyProp)
        get_sql(wg_avg_wage_sick, in, usr_wg_FeeTypeProp/4,
        "SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          ft.USR$WG_FEEGROUPKEY, \c
          ft.USR$WG_FEETYPEKEY \c
        FROM \c
          USR$CROSS179_256548741 ft \c
        JOIN \c
          USR$WG_FEETYPE ft_avg \c
            ON ft_avg.ID = ft.USR$WG_FEETYPEKEY \c
        WHERE \c
          ft.USR$WG_FEEGROUPKEY IN \c
        (SELECT id FROM gd_ruid \c
        WHERE xid = pFeeGroupKeyProp_xid \c
        AND dbid = pFeeGroupKeyProp_dbid \c
        ) \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pFeeGroupKeyProp_xid-_, pFeeGroupKeyProp_dbid-_]
            ).
        
        gd_pl_ds(wg_avg_wage_sick, in, wg_holiday, 1, [fHolidayDate-date]).
        % wg_holiday(HolidayDate)
        get_sql(wg_avg_wage_sick, in, wg_holiday/1,
        "SELECT \c
          h.holidaydate \c
        FROM \c
          wg_holiday h \c
        WHERE \c
          h.holidaydate BETWEEN \'pDateCalcFrom\' AND \'pDateCalcTo\' \c
          AND COALESCE(h.disabled, 0) = 0 \c
        ",
        [pDateCalcFrom-_, pDateCalcTo-_]
            ).
        
        gd_pl_ds(wg_avg_wage_sick, in, usr_wg_ExclDays, 5,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fExclType-string,
            fFromDate-date, fToDate-date
            ]).
        % usr_wg_FeeTypeProp(EmplKey, FirstMoveKey, ExclType, FromDate, ToDate)
        get_sql(wg_avg_wage_sick, in, usr_wg_ExclDays/5,
        "SELECT \c
          EmplKey, FirstMoveKey, ExclType, FromDate, ToDate \c
        FROM ( \c
        SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          \'LIGHTWORKLINE\' AS ExclType, \c
          CAST( IIF(lw.USR$DATEBEGIN < \'pDateCalcFrom\', \'pDateCalcFrom\', lw.USR$DATEBEGIN) AS DATE) AS FromDate, \c
          CAST( IIF(lw.USR$DATEEND IS NULL, \'pDateCalcTo\', IIF(lw.USR$DATEEND > \'pDateCalcTo\', \'pDateCalcTo\', lw.USR$DATEEND)) AS DATE) AS ToDate \c
        FROM USR$WG_LIGHTWORKLINE lw \c
        WHERE lw.USR$FIRSTMOVEKEY = pFirstMoveKey \c
          AND lw.USR$EMPLKEY = pEmplKey \c
          AND lw.USR$DATEBEGIN <= \'pDateCalcTo\' \c
          AND COALESCE(lw.USR$DATEEND, \'pDateCalcTo\') >= \'pDateCalcFrom\' \c
        UNION ALL \c
        SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          \'WG_LEAVEDOCLINE\' AS ExclType, \c
          CAST( IIF(ld.USR$DATEBEGIN < \'pDateCalcFrom\', \'pDateCalcFrom\', ld.USR$DATEBEGIN) AS DATE) AS FromDate, \c
          CAST( IIF(ld.USR$DATEEND IS NULL, \'pDateCalcTo\', IIF(ld.USR$DATEEND > \'pDateCalcTo\', \'pDateCalcTo\', ld.USR$DATEEND)) AS DATE) AS ToDate \c
        FROM USR$WG_LEAVEDOCLINE ld \c
        LEFT JOIN USR$WG_VACATIONTYPE t ON t.ID = ld.USR$VACATIONTYPEKEY \c
        WHERE ld.USR$FIRSTMOVEKEY = pFirstMoveKey \c
          AND ld.USR$EMPLKEY = pEmplKey \c
          AND ld.USR$DATEBEGIN <= \'pDateCalcTo\' \c
          AND COALESCE(ld.USR$DATEEND, \'pDateCalcTo\') >= \'pDateCalcFrom\' \c
          AND COALESCE(t.USR$EXCLUDEFORSICKLIST, 0) = 1 \c
        UNION ALL \c
        SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          \'SICKLISTJOURNAL\' AS ExclType, \c
          CAST( IIF(s.USR$DATEBEGIN < \'pDateCalcFrom\', \'pDateCalcFrom\', s.USR$DATEBEGIN) AS DATE) AS FromDate, \c
          CAST( IIF(s.USR$DATEEND IS NULL, \'pDateCalcTo\', IIF(s.USR$DATEEND > \'pDateCalcTo\', \'pDateCalcTo\', s.USR$DATEEND)) AS DATE) AS ToDate \c
        FROM USR$WG_SICKLISTJOURNAL s \c
        WHERE s.USR$EMPLKEY = pEmplKey \c
          AND s.USR$DATEBEGIN <= \'pDateCalcTo\' \c
          AND COALESCE(s.USR$DATEEND, \'pDateCalcTo\') >= \'pDateCalcFrom\' \c
        UNION ALL \c
        SELECT \c
          pEmplKey AS EmplKey, \c
          pFirstMoveKey AS FirstMoveKey, \c
          \'LEAVEEXTDOC\' AS ExclType, \c
          CAST( IIF(ext.USR$DATEBEGIN < \'pDateCalcFrom\', \'pDateCalcFrom\', ext.USR$DATEBEGIN) AS DATE) AS FromDate, \c
          CAST( IIF(ext.USR$DATEEND IS NULL, \'pDateCalcTo\', IIF(ext.USR$DATEEND > \'pDateCalcTo\', \'pDateCalcTo\', ext.USR$DATEEND)) AS DATE) AS ToDate \c
        FROM USR$WG_LEAVEEXTDOC ext \c
        WHERE ext.USR$EMPLKEY = pEmplKey \c
          AND ext.USR$DATEBEGIN <= \'pDateCalcTo\' \c
          AND COALESCE(ext.USR$DATEEND, \'pDateCalcTo\') >= \'pDateCalcFrom\' \c
        ) \c
        ORDER BY \c
          FromDate \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ).
        
        %
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-13T18:21:14+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151189471_18175251
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 151189370_18175251
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "twg_avg_wage_in_params"
      COMMENT: ~
      SCRIPT: | 
        % twg_avg_wage_in_params
        
        :- new_param_list(wg_avg_wage_vacation, in,
            [
            pMonthQty-12, pAvgDays-29.7,
            pFeeGroupKey_xid-147071456,
            pFeeGroupKey_dbid-274788016,
            pFeeGroupKeyNoCoef_xid-147757383,
            pFeeGroupKeyNoCoef_dbid-84733194,
            pBadHourType_xid_IN-'147650804, 147650786, 147650802',
            pBadHourType_dbid-119619099,
            pBadFeeType_xid_IN-'151000730',
            pBadFeeType_dbid-2109681374,
            pPayFormSalary_xid-147009181,
            pPayFormSalary_dbid-119619099,
            pTblCal_DocType_Plan_xid-147567935,
            pTblCal_DocType_Plan_dbid-1514418708,
            pTblCal_DocType_Fact_xid-187613422,
            pTblCal_DocType_Fact_dbid-1596169984
            ]).
        
        :- new_param_list(wg_avg_wage_sick, in,
            [
            pMonthQty-6, pBudgetPart-0.5,
            pFeeGroupKey_xid-147071457,
            pFeeGroupKey_dbid-274788016,
            pFeeGroupKeyProp_xid-147119175,
            pFeeGroupKeyProp_dbid-1354510846,
            pPayFormSalary_xid-147009181,
            pPayFormSalary_dbid-119619099,
            pTblCal_DocType_Plan-522933937,
            pTblCal_DocType_Fact-522791174,
            pTblCal_DocType_Plan_xid-147567935,
            pTblCal_DocType_Plan_dbid-1514418708,
            pTblCal_DocType_Fact_xid-187613422,
            pTblCal_DocType_Fact_dbid-1596169984
            ]).
        
        %
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-13T18:20:11+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151189370_18175251
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "twg_avg_wage"
      COMMENT: ~
      SCRIPT: | 
        % twg_avg_wage
        
        % среднедневной заработок
        % - для отпусков
        % - для больничных
        %
        
        :- retractall(debug_mode).
        
        % ! при использовании в ТП Гедымин
        % ! для begin & end debug mode section
        % ! убрать символ процента из первой позиции
        /* %%% begin debug mode section
        
        %% saved state
        :- ['../gd_pl_state/load_atom', '../gd_pl_state/date', '../gd_pl_state/dataset'].
        %%
        
        %% include
        %#INCLUDE lib
        :- [lib].
        %#INCLUDE params
        :- [params].
        %#INCLUDE twg_avg_wage_sql
        :- [twg_avg_wage_sql].
        %#INCLUDE twg_avg_wage_in_params
        %:- [twg_avg_wage_in_params].
        %%
        
        %% facts
        :-  init_data,
            [
            usr_wg_DbfSums,
            usr_wg_MovementLine,
            usr_wg_FCRate,
            usr_wg_TblDayNorm,
            usr_wg_TblYearNorm,
            usr_wg_TblCalLine,
            usr_wg_TblCal_FlexLine,
            usr_wg_HourType,
            usr_wg_TblCharge,
            usr_wg_FeeType,
            usr_wg_FeeTypeNoCoef,
            usr_wg_BadHourType,
            usr_wg_BadFeeType,
            usr_wg_FeeTypeProp,
            wg_holiday,
            usr_wg_ExclDays
            ].
        %%
        
        %% dynamic state
        :- [param_list].
        %%
        
        %% flag
        %:- assertz(debug_mode).
        %%
        
        % ! при использовании в ТП Гедымин
        % ! для begin & end debug mode section
        % ! убрать символ процента из первой позиции
        */ %%% end debug mode section
        
        :- ps32k_lgt(64, 128, 64).
        
        /* реализация */
        
        %% варианты правил расчета
        %  - для отпусков
        % [по расчетным месяцам, по среднечасовому]
        wg_valid_rules([by_calc_month, by_avg_houre]).
        %% варианты правил включения месяца в расчет
        % табель за месяц покрывает график [по дням и часам, по часам, по дням]
        wg_valid_rules([by_days_houres, by_houres, by_days]).
        %% дополнительные правила для включения месяца в расчет
        % [заработок за месяц не меньше каждого из полных месяцев]
        % (для одинаковых коэфициентов осовременивания)
        wg_valid_rules([-by_month_wage_all]).
        % [заработок за месяц не меньше любого из полных месяцев]
        % (для одинаковых коэфициентов осовременивания)
        wg_valid_rules([by_month_wage_any]).
        % [отсутствие в месяце плохих типов начислений и часов]
        wg_valid_rules([-by_month_no_bad_type]).
        
        %% варианты правил расчета
        %  - для больничных
        % [по расчетным дням, по расчетным дням со справкой]
        wg_valid_rules([by_calc_days, by_calc_days_doc]).
        % [от БПМ, от ставки, по не полным месяцам]
        wg_valid_rules([by_budget, by_rate, by_not_full]).
        %% варианты правил для исключения дней
        % [по табелю мастера, по табелю, по приказам]
        wg_valid_rules([by_cal_flex, by_cal, by_orders]).
        %% дополнительные правила для учета расчетных дней
        % [все месяцы полные, хотя бы один месяц полный]
        wg_valid_rules([by_calc_days_all, by_calc_days_any]).
        
        %% варианты правил полных месяцев
        %  - для отпусков
        % табель за месяц покрывает график [по дням и часам, по часам, по дням]
        wg_full_month_rules([by_days_houres, by_houres, by_days]).
        
        % правило действительно
        is_valid_rule(Rule) :-
            wg_valid_rules(ValidRules),
            member(Rule, ValidRules),
            !.
        
        % среднедневной заработок
        % - для отпусков
        avg_wage(Variant) :-
            % параметры контекста
            Scope = wg_avg_wage_vacation,
            % шаблон первичного ключа
            PK = [pEmplKey-_, pFirstMoveKey-_],
            % для каждого первичного ключа расчета из входных параметров
            get_param_list(Scope, in, PK),
            % запустить цикл механизма подготовки данных
            engine_loop(Scope, in, PK),
            % выполнить расчет
            eval_avg_wage(Scope, PK, Variant),
            % найти альтернативу
            fail.
        avg_wage(_) :-
            % больше альтернатив нет
            !.
        % - для больничных
        avg_wage_sick(Variant) :-
            % параметры контекста
            Scope = wg_avg_wage_sick,
            % шаблон первичного ключа
            PK = [pEmplKey-_, pFirstMoveKey-_],
            % для каждого первичного ключа расчета из входных параметров
            get_param_list(Scope, in, PK),
            % запустить цикл механизма подготовки данных
            engine_loop(Scope, in, PK),
            % выполнить расчет
            eval_avg_wage_sick(Scope, PK, Variant),
            % найти альтернативу
            fail.
        avg_wage_sick(_) :-
            % больше альтернатив нет
            !.
        
        % выполнить расчет
        % - для отпусков
        eval_avg_wage(Scope, PK, Variant) :-
            % взять локальное время
            get_local_date_time(DT1),
            % записать отладочную информацию
            new_param_list(Scope, debug, [begin-DT1|PK]),
            % удалить временные данные по расчету
            forall( get_param_list(Scope, temp, PK, Pairs),
                    dispose_param_list(Scope, temp, Pairs) ),
            % вычислить среднедневной заработок по сотруднику
            calc_avg_wage(Scope, PK, AvgWage, Variant),
            % записать результат
            ret_avg_wage(Scope, PK, AvgWage, Variant),
            % взять локальное время
            get_local_date_time(DT2),
            % записать отладочную информацию
            new_param_list(Scope, debug, [end-DT2|PK]),
            !.
        % - для больничных
        eval_avg_wage_sick(Scope, PK, Variant) :-
            % взять локальное время
            get_local_date_time(DT1),
            % записать отладочную информацию
            new_param_list(Scope, debug, [begin-DT1|PK]),
            % удалить временные данные по расчету
            forall( get_param_list(Scope, temp, PK, Pairs),
                    dispose_param_list(Scope, temp, Pairs) ),
            % вычислить среднедневной заработок по сотруднику
            calc_avg_wage_sick(Scope, PK, AvgWage, Variant),
            % записать результат
            ret_avg_wage_sick(Scope, PK, AvgWage, Variant),
            % взять локальное время
            get_local_date_time(DT2),
            % записать отладочную информацию
            new_param_list(Scope, debug, [end-DT2|PK]),
            !.
        
        % записать результат
        % - для отпусков
        ret_avg_wage(Scope, PK, AvgWage, Variant) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять дополнительные данные из первого движения
            get_data(Scope, in, usr_wg_MovementLine, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fMovementType-1, fListNumber-ListNumber]),
            % записать выходные данные
            append(PK, [pListNumber-ListNumber,
                        pAvgWage-AvgWage, pVariant-Variant],
                    OutPairs),
            new_param_list(Scope, out, OutPairs),
            !.
        % - для больничных
        ret_avg_wage_sick(Scope, PK, AvgWage, Variant) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять дополнительные данные из первого движения
            get_data(Scope, in, usr_wg_MovementLine, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fMovementType-1, fListNumber-ListNumber]),
            % записать выходные данные
            append(PK, [pListNumber-ListNumber,
                        pAvgWage-AvgWage, pVariant-Variant],
                    OutPairs),
            new_param_list(Scope, out, OutPairs),
            !.
        
        % среднедневной заработок по сотруднику (по расчетным месяцам)
        % - для отпусков
        calc_avg_wage(Scope, PK, AvgWage, Rule) :-
            Rule = by_calc_month,
            % правило действительно
            is_valid_rule(Rule),
            % подготовка временных данных для расчета
            prep_avg_wage(Scope, PK, Periods),
            % проверка по табелю
            check_month_tab(Scope, PK, Periods),
            % если есть хотя бы один расчетный месяц
            ( once( get_month_incl(Scope, PK, _, _, _) ),
            % то проверка по заработку
              check_month_wage(Scope, PK, Periods)
              ; true ),
            % проверка на отсутствие плохих типов начислений и часов
            check_month_no_bad_type(Scope, PK, Periods),
            % есть хотя бы один расчетный месяц
            once( get_month_incl(Scope, PK, _, _, _) ),
            % взять заработок
            findall( Wage,
                       % за каждый расчетный месяц
                     ( get_month_incl(Scope, PK, Y, M, _),
                       % взять данные по заработку
                       get_month_wage(Scope, PK, Y, M, _, Wage) ),
            % в список заработков
            Wages ),
            % итоговый заработок за расчетные месяцы
            sum_list(Wages, Amount),
            % количество расчетных месяцев
            length(Wages, Num),
            % среднемесячное количество календарных дней
            get_param(Scope, in, pAvgDays-AvgDays),
            % среднедневной заработок
            catch( AvgWage0 is Amount / Num / AvgDays, _, fail ),
            AvgWage is round(AvgWage0),
            !.
        % среднедневной заработок по сотруднику (по среднечасовому)
        % - для отпусков
        calc_avg_wage(Scope, PK, AvgWage, Rule) :-
            Rule = by_avg_houre,
            % правило действительно
            is_valid_rule(Rule),
            % подготовка временных данных для расчета
            prep_avg_wage(Scope, PK, Periods),
            % взять заработок
            findall( Wage,
                       % за каждый период проверки
                     ( member(Y1-M1, Periods),
                       % взять данные по заработку
                       get_month_wage(Scope, PK, Y1, M1, _, Wage) ),
            % в список заработков
            Wages ),
            % итоговый заработок
            sum_list(Wages, Amount),
            % взять часы
            findall( THoures,
                     % за период проверки
                     ( member(Y2-M2, Periods),
                     % взять данные по часам за месяц
                     get_month_norm_tab(Scope, PK, Y2-M2, _, _, _, THoures)
                     ),
            % в список часов
            Durations),
            % всего часов по табелю
            sum_list(Durations, TotalTab),
            % среднечасовой заработок
            catch( AvgHoureWage is Amount / TotalTab, _, fail ),
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % всего часов по графику за расчетный год
            get_data(Scope, in, usr_wg_TblYearNorm, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fWHoures-TotalNorm]),
            % среднемесячное количество расчетных рабочих часов
            AvgMonthNorm is TotalNorm / 12,
            % среднемесячное количество календарных дней
            get_param(Scope, in, pAvgDays-AvgDays),
            % среднедневной заработок
            catch( AvgWage0 is AvgHoureWage * AvgMonthNorm / AvgDays, _, fail ),
            AvgWage is round(AvgWage0),
            !.
        % среднедневной заработок по сотруднику (по расчетным дням / со справкой)
        % - для больничных
        calc_avg_wage_sick(Scope, PK, AvgWage, Rule) :-
            member(Rule, [by_calc_days, by_calc_days_doc]),
            % правило действительно
            is_valid_rule(Rule),
            % подготовка временных данных для расчета
            prep_avg_wage_sick(Scope, PK, Periods),
            % вариант по расчетным дням
            ( Rule = by_calc_days,
              % есть требуемое количество месяцев
              get_param(Scope, run, pMonthQty-MonthQty),
              length(Periods, MonthQty)
            ;
            % вариант по расчетным дням со справкой
              Rule = by_calc_days_doc,
              % есть признак Справка
              append(PK, [pIsAvgWageDoc-1], Pairs),
              get_param_list(Scope, run, Pairs)
            ),
            % если выполняется одно из правил
            rule_month_days_sick(Scope, PK, Periods),
            % то выполнить расчет
            % взять заработок
            findall( Wage,
                       % за каждый период проверки
                     ( member(Y1-M1, Periods),
                       % взять данные по заработку
                       get_month_wage_sick(Scope, PK, Y1, M1, Wage) ),
            % в список заработков
            Wages ),
            % итоговый заработок
            sum_list(Wages, Amount),
            % взять расчетные дни
            findall( CalcDays,
                       % за каждый период проверки
                     ( member(Y2-M2, Periods),
                       % взять данные по расчетным дням
                       get_month_days_sick(Scope, PK, Y2, M2, CalcDays, _) ),
            % в список расчетных дней
            CalcDaysList ),
            % всего расчетных дней
            sum_list(CalcDaysList, TotalCalcDays),
            % среднедневной заработок
            catch( AvgWage0 is Amount / TotalCalcDays, _, fail ),
            AvgWage is round(AvgWage0),
            !.
        % среднедневной заработок по сотруднику (от БПМ)
        % - для больничных
        calc_avg_wage_sick(Scope, PK, AvgWage, Rule) :-
            Rule = by_budget,
            % правило действительно
            is_valid_rule(Rule),
            % подготовка временных данных для расчета
            prep_avg_wage_sick(Scope, PK, Periods),
            % нет требуемого количества месяцев
            get_param(Scope, run, pMonthQty-MonthQty),
            \+ length(Periods, MonthQty),
            % расчет от БПМ при формировании структуры
            AvgWage is 0,
            !.
        % среднедневной заработок по сотруднику (от ставки / по не полным месяцам)
        % - для больничных
        calc_avg_wage_sick(Scope, PK, AvgWage, Rule) :-
            % подготовка временных данных для расчета
            prep_avg_wage_sick(Scope, PK, Periods),
            % расчет по разным вариантам
            once( ( version_avg_wage_sick(Scope, PK, Periods, AvgWage1, by_rate)
                  ; AvgWage1 = 0 )
                ),
            once( ( version_avg_wage_sick(Scope, PK, Periods, AvgWage2, by_not_full)
                  ; AvgWage2 = 0 )
                ),
            \+ [AvgWage1, AvgWage2] = [0, 0],
            % выбор варианта расчета
            ( AvgWage1 >= AvgWage2,
              Rule = by_rate,
              AvgWage = AvgWage1
            ;
              Rule = by_not_full,
              AvgWage = AvgWage2
            ),
            !.
        
        % выбор варианта расчета
        version_avg_wage_sick(Scope, PK, Periods, AvgWage, Rule) :-
            Rule = by_rate,
            % правило действительно
            is_valid_rule(Rule),
            % взять расчетную дату
            append(PK, [pDateCalc-DateCalc], Pairs),
            get_param_list(Scope, run, Pairs),
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные по ставке
            findall( PayFormKey0-SalaryKey0-TSalary0-AvgWageRate0,
                     % из данных по движению
                     ( get_data(Scope, in, usr_wg_MovementLine, [
                                 fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                                 fDateBegin-DateBegin,
                                 fPayFormKey-PayFormKey0, fSalaryKey-SalaryKey0,
                                 fTSalary-TSalary0, fAvgWageRate-AvgWageRate0 ]),
                     % где дата меньше или равна расчетной
                       DateBegin @=< DateCalc ),
            % в список ставок
            RateList ),
            % взять последние данные по ставке
            last(RateList, PayFormKey-SalaryKey-TSalary-AvgWageRate),
              % если форма оплаты оклад, то расчет по тарифному окладу
            ( PayFormKey = SalaryKey,
              % сформировать список заработков по тарифному окладу
              findall( TSalary, member(_-_, Periods), Wages ),
              % итоговый заработок
              sum_list(Wages, Amount),
              % сформировать список расчетных дней по календарным дням месяца
              findall( CalcDays,
                       ( member(Y-M, Periods), month_days(Y, M, CalcDays) ),
              CalcDaysList ),
              % всего расчетных дней
              sum_list(CalcDaysList, TotalCalcDays),
              % среднедневной заработок
              catch( AvgWage0 is Amount / TotalCalcDays, _, fail ),
              AvgWage is round(AvgWage0)
            ;
              % иначе, расчет от часовой тарифной ставки
              AvgWage is round(AvgWageRate)
            ),
            !.
        version_avg_wage_sick(Scope, PK, Periods, AvgWage, Rule) :-
            Rule = by_not_full,
            % правило действительно
            is_valid_rule(Rule),
            % если есть требуемое количество месяцев
            get_param(Scope, run, pMonthQty-MonthQty),
            length(Periods, MonthQty),
            % то выполнить расчет
            % взять заработок
            findall( Wage,
                       % за каждый период проверки
                     ( member(Y1-M1, Periods),
                       % взять данные по заработку
                       get_month_wage_sick(Scope, PK, Y1, M1, Wage) ),
            % в список заработков
            Wages ),
            % итоговый заработок
            sum_list(Wages, Amount),
            % взять расчетные дни
            findall( CalcDays,
                       % за каждый период проверки
                     ( member(Y2-M2, Periods),
                       % взять данные по расчетным дням
                       get_month_days_sick(Scope, PK, Y2, M2, CalcDays, _) ),
            % в список расчетных дней
            CalcDaysList ),
            % всего расчетных дней
            sum_list(CalcDaysList, TotalCalcDays),
            % среднедневной заработок
            catch( AvgWage0 is Amount / TotalCalcDays, _, fail ),
            AvgWage is round(AvgWage0),
            !.
        
        % правила для учета расчетных дней
        % - для больничных
        rule_month_days_sick(Scope, PK, Periods) :-
            Rule = by_calc_days_all,
            % правило действительно
            is_valid_rule(Rule),
            % все месяцы полные
            is_full_all_month_sick(Scope, PK, Periods),
            !.
        rule_month_days_sick(Scope, PK, Periods) :-
            Rule = by_calc_days_any,
            % правило действительно
            is_valid_rule(Rule),
            % есть хотя бы один полный месяц
            member(Y-M, Periods),
            get_month_days_sick(Scope, PK, Y, M, _, 1),
            !.
        
        % все месяцы полные
        % - для больничных
        is_full_all_month_sick(_, _, []):-
            % все месяцы проверены
            !.
        is_full_all_month_sick(Scope, PK, [Y-M|Periods]) :-
            % есть данные по расчетным дням для полного месяца
            get_month_days_sick(Scope, PK, Y, M, _, 1),
            !,
            % проверить остальные месяцы
            is_full_all_month_sick(Scope, PK, Periods).
        
        % подготовка временных данных для расчета
        % - для отпусков
        prep_avg_wage(Scope, PK, Periods) :-
            % периоды для проверки
            get_periods(Scope, PK, Periods),
            % добавление временных данных по расчету дней и часов
            add_month_norm_tab(Scope, PK, Periods),
            % добавление временных данных по расчету заработков
            add_month_wage(Scope, PK, Periods),
            !.
        % - для больничных
        prep_avg_wage_sick(Scope, PK, Periods) :-
            % периоды для проверки
            get_periods(Scope, PK, Periods),
            % добавление временных данных по расчету дней и часов
            add_month_norm_tab(Scope, PK, Periods),
            % добавление временных данных по расчету заработков
            add_month_wage_sick(Scope, PK, Periods),
            % добавление временных данных по расчетным дням
            add_month_days_sick(Scope, PK, Periods),
            !.
        
        % периоды для проверки
        get_periods(Scope, PK, Periods) :-
            append(PK, [pDateCalcFrom-DateFrom, pDateCalcTo-DateTo], Pairs),
            get_param_list(Scope, run, Pairs),
            make_periods(Scope, PK, DateFrom, DateTo, Periods),
            !.
        
        % создать список периодов
        make_periods(_, _, DateFrom, DateTo, []) :-
            DateFrom @>= DateTo,
            !.
        make_periods(Scope, PK, DateFrom, DateTo, [Y-M|Periods]) :-
            atom_date(DateFrom, date(Y, M, _)),
            % период является рабочим
            is_work_period(Scope, PK, Y-M),
            % добавить месяц
            date_add(DateFrom, 1, month, DateFrom1),
            !,
            make_periods(Scope, PK, DateFrom1, DateTo, Periods).
        make_periods(Scope, PK, DateFrom, DateTo, Periods) :-
            % добавить месяц
            date_add(DateFrom, 1, month, DateFrom1),
            !,
            make_periods(Scope, PK, DateFrom1, DateTo, Periods).
        
        % добавление временных данных по расчету дней и часов
        add_month_norm_tab(_, _, []):-
            % больше месяцев для проверки нет
            !.
        add_month_norm_tab(Scope, PK, [Y-M|Periods]) :-
            % проверить данные по графику и табелю за месяц
            get_month_norm_tab(Scope, PK, Y-M, _, _, _, _),
            !,
            % проверить остальные месяцы
            add_month_norm_tab(Scope, PK, Periods).
        add_month_norm_tab(Scope, PK, [_|Periods]) :-
            !,
            % проверить остальные месяцы
            add_month_norm_tab(Scope, PK, Periods).
        
        % добавление временных данных по расчету заработков
        % - для отпусков
        add_month_wage(_, _, []):-
            % больше месяцев для проверки нет
            !.
        add_month_wage(Scope, PK, [Y-M|Periods]) :-
            % проверить данные по заработку
            get_month_wage(Scope, PK, Y, M, _, _),
            !,
            % проверить остальные месяцы
            add_month_wage(Scope, PK, Periods).
        add_month_wage(Scope, PK, [_|Periods]) :-
            !,
            % проверить остальные месяцы
            add_month_wage(Scope, PK, Periods).
        
        % взять данные по заработку за месяц
        % - для отпусков
        get_month_wage(Scope, PK, Y, M, MonthModernCoef, ModernWage) :-
            % взять из временных параметров данные по заработку
            append(PK, [pYM-Y-M, pModernCoef-MonthModernCoef, pModernWage-ModernWage],
                    Pairs),
            get_param_list(Scope, temp, Pairs),
            !.
        get_month_wage(Scope, PK, Y, M, MonthModernCoef, ModernWage) :-
            % расчитать заработок за месяц
            cacl_month_wage(Scope, PK, Y, M, Wage, MonthModernCoef, ModernWage),
            % записать во временные параметры данные по заработку
            append(PK, [pYM-Y-M,
                        pWage-Wage, pModernCoef-MonthModernCoef, pModernWage-ModernWage],
                    Pairs),
            new_param_list(Scope, temp, Pairs),
            !.
        
        % расчитать заработок за месяц
        % - для отпусков
        cacl_month_wage(Scope, PK, Y, M, Wage, MonthModernCoef, ModernWage) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % параметры выбора начислений
            member(ChargeOption, [tbl_charge, dbf_sums]),
            % взять начисления
            findall( Debit-ModernCoef,
                  % для начисления по одному из параметров
                  % где дата совпадает с проверяемым месяцем
                  ( usr_wg_TblCharge_mix(Scope, in, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fCalYear-Y, fCalMonth-M, fDateBegin-TheDay,
                        fDebit-Debit, fFeeTypeKey-FeeTypeKey ],
                                            ChargeOption),
                  % и соответствующего типа
                  once( ( var(FeeTypeKey)
                        ; get_data(Scope, in, usr_wg_FeeType, [
                                    fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                                    fFeeTypeKey-FeeTypeKey ])
                        )
                      ),
                  % с коэффициентом осовременивания
                  get_modern_coef(Scope, PK, TheDay, FeeTypeKey, ModernCoef)
                  ),
            % в список начислений
            Debits ),
            % проверить список начислений
            \+ Debits = [],
            % всего за месяц
            sum_month_debit(Debits, Wage, ModernWage0),
            % средний за месяц коэффициент осовременивания
            catch( MonthModernCoef0 is ModernWage0 / Wage, _, fail),
            to_currency(MonthModernCoef0, MonthModernCoef, 2),
            % осовремененный заработок
            ModernWage is round(Wage * MonthModernCoef),
            !.
        
        % итого зарплата и осовремененная зарплата за месяц
        % - для отпусков
        sum_month_debit(Debits, Wage, ModernWage) :-
            sum_month_debit(Debits, Wage, ModernWage, 0, 0),
            !.
        %
        sum_month_debit([], Wage, ModernWage, Wage, ModernWage) :-
            !.
        sum_month_debit([Debit-ModernCoef | Debits], Wage, ModernWage, Wage0, ModernWage0) :-
            Wage1 is Wage0 + Debit,
            ModernWage1 is ModernWage0 + Debit*ModernCoef,
            !,
            sum_month_debit(Debits, Wage, ModernWage, Wage1, ModernWage1).
        
        % коэффициент осовременивания
        get_modern_coef(Scope, PK, _, FeeTypeKey, 1.0) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % проверить тип начисления на исключение для осовременивания
            get_data(Scope, in, usr_wg_FeeTypeNoCoef, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fFeeTypeKeyNoCoef-FeeTypeKey ]),
            !.
        get_modern_coef(Scope, PK, TheDay, _, ModernCoef) :-
            % взять параметр коэфициента и дату ограничения расчета
            append(PK, [pDateCalcTo-DateTo, pCoefOption-CoefOption], Pairs),
            get_param_list(Scope, run, Pairs),
            % сформировать список движений дата-сумма
            findall( Date-Amount,
                     get_modern_coef_data(PK, Scope, Date, Amount, CoefOption, DateTo),
            Movements ),
            % вычислить коэффициент
            calc_modern_coef(TheDay, Movements, ModernCoef),
            !.
        
        % взять данные для расчета коэфициента осовременивания
        %
        get_modern_coef_data(PK, Scope, Date, FCRateSum, CoefOption, DateTo) :-
            % справочник базовых величин - тарифная ставка 1-го разряда
            nonvar(CoefOption), CoefOption = fc_fcratesum,
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные из справочника по ставке
            get_data(Scope, in, usr_wg_FCRate, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fDate-Date, fFCRateSum-FCRateSum ]),
            % где дата меньше расчетной
            Date @< DateTo.
        %
        get_modern_coef_data(PK, Scope, DateBegin, Rate, CoefOption, DateTo) :-
            % движение - тарифная ставка 1-го разряда
            nonvar(CoefOption), CoefOption = ml_rate,
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные из движения по ставке
            get_data(Scope, in, usr_wg_MovementLine, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fDateBegin-DateBegin, fRate-Rate ]),
            % где дата меньше расчетной
            DateBegin @< DateTo.
        %
        get_modern_coef_data(PK, Scope, DateBegin, MSalary, CoefOption, DateTo) :-
            % движение - оклад
            nonvar(CoefOption), CoefOption = ml_msalary,
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные из движения по окладу
            get_data(Scope, in, usr_wg_MovementLine, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fDateBegin-DateBegin, fMSalary-MSalary ]),
            % где дата меньше расчетной
            DateBegin @< DateTo.
        
        % вычислить коэффициент
        calc_modern_coef(_, [ _ | [] ], 1.0) :-
            % если последнее движение, то коэффициент 1
            !.
        calc_modern_coef(TheDay, [ Date1-Rate1, Date2-Rate2 | Movements ], ModernCoef) :-
            % если проверяемая дата больше или равна даты текущего движения
            TheDay @>= Date1,
            % и меньше даты следующего движения
            TheDay @< Date2,
            % то взять последнюю ставку из следующего и всех оставшихся движений
            last([Date2-Rate2 | Movements], _-RateLast),
            % и вычислить коэффициент для текущего движения
            catch( ModernCoef0 is RateLast / Rate1, _, fail),
            ( ModernCoef0 < 1.0, ModernCoef = 1.0 ; ModernCoef = ModernCoef0 ),
            !.
        calc_modern_coef(TheDay, [ _ | Movements ], ModernCoef) :-
            % проверить для остальных движений
            !,
            calc_modern_coef(TheDay, Movements, ModernCoef).
        
        % добавление временных данных по расчету заработков
        % - для больничных
        add_month_wage_sick(_, _, []):-
            % больше месяцев для проверки нет
            !.
        add_month_wage_sick(Scope, PK, [Y-M|Periods]) :-
            % проверить данные по заработку
            get_month_wage_sick(Scope, PK, Y, M, _),
            !,
            % проверить остальные месяцы
            add_month_wage_sick(Scope, PK, Periods).
        add_month_wage_sick(Scope, PK, [_|Periods]) :-
            !,
            % проверить остальные месяцы
            add_month_wage_sick(Scope, PK, Periods).
        
        % взять данные по заработку за месяц
        % - для больничных
        get_month_wage_sick(Scope, PK, Y, M, Wage) :-
            % взять из временных параметров данные по заработку
            append(PK, [pYM-Y-M, pWage-Wage],
                    Pairs),
            get_param_list(Scope, temp, Pairs),
            !.
        get_month_wage_sick(Scope, PK, Y, M, Wage) :-
            % расчитать заработок за месяц
            cacl_month_wage_sick(Scope, PK, Y, M, Wage),
            % записать во временные параметры данные по заработку
            append(PK, [pYM-Y-M, pWage-Wage], Pairs),
            new_param_list(Scope, temp, Pairs),
            !.
        
        % расчитать заработок за месяц
        % - для больничных
        cacl_month_wage_sick(Scope, PK, Y, M, Wage) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % параметры выбора начислений
            member(ChargeOption, [tbl_charge, dbf_sums]),
            % взять начисления
            findall( Debit-FeeTypeKey,
                  % для начисления по одному из параметров
                  % где дата совпадает с проверяемым месяцем
                  ( usr_wg_TblCharge_mix(Scope, in, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fCalYear-Y, fCalMonth-M,
                        fDebit-Debit, fFeeTypeKey-FeeTypeKey ],
                                            ChargeOption),
                  % и соответствующего типа
                  once( ( var(FeeTypeKey)
                        ; get_data(Scope, in, usr_wg_FeeType, [
                                    fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                                    fFeeTypeKey-FeeTypeKey ])
                        )
                      )
                  ),
            % в список начислений
            Debits ),
            % проверить список начислений
            \+ Debits = [],
            % всего за месяц
            sum_month_debit_sick(Scope, PK, Y, M, Debits, Wage),
            !.
        cacl_month_wage_sick(_, _, _, _, 0.0) :-
            !.
        
        % итого зарплата за месяц
        % - для больничных
        sum_month_debit_sick(Scope, PK, Y, M, Debits, Wage) :-
            sum_month_debit_sick(Scope, PK, Y, M, Debits, Wage, 0.0),
            !.
        %
        sum_month_debit_sick(_, _, _, _, [], Wage, Wage) :-
            !.
        sum_month_debit_sick(Scope, PK, Y, M, [Debit-FeeTypeKey | Debits], Wage, Wage0) :-
            nonvar(FeeTypeKey),
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % тип начисления для пропорционального расчета
            once( get_data(Scope, in, usr_wg_FeeTypeProp, [
                            fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                            fFeeTypeKeyProp-FeeTypeKey ]) ),
            % взять коэфициент для пропорционального начисления
            get_prop_coef(Scope, PK, Y, M, PropCoef),
            % пропорциональный расчет
            Debit1 is round(Debit * PropCoef),
            Wage1 is Wage0 + Debit1,
            !,
            sum_month_debit_sick(Scope, PK, Y, M, Debits, Wage, Wage1).
        sum_month_debit_sick(Scope, PK, Y, M, [Debit-_ | Debits], Wage, Wage0) :-
            % обычный расчет
            Wage1 is Wage0 + Debit,
            !,
            sum_month_debit_sick(Scope, PK, Y, M, Debits, Wage, Wage1).
        
        % взять коэфициент для пропорционального начисления
        get_prop_coef(Scope, PK, Y, M, PropCoef) :-
            % взять данные по графику и табелю за месяц
            get_month_norm_tab(Scope, PK, Y-M, NDays, TDays, NHoures, THoures),
            % расчитать коэфициент для пропорционального начисления
            calc_prop_coef(TDays, NDays, THoures, NHoures, PropCoef),
            !.
        
        % расчитать коэфициент для пропорционального начисления
        calc_prop_coef(TabDays, NormDays, _, _, 1.0) :-
            TabDays >= NormDays,
            !.
        calc_prop_coef(_, _, TabHoures, NormHoures, 1.0) :-
            TabHoures >= NormHoures,
            !.
        calc_prop_coef(TabDays, NormDays, TabHoures, NormHoures, PropCoef) :-
            catch( PropCoef1 is TabDays / NormDays, _, fail ),
            catch( PropCoef2 is TabHoures / NormHoures, _, fail ),
            PropCoef is max(PropCoef1, PropCoef2),
            \+ PropCoef > 1.0,
            !.
        calc_prop_coef(_, _, _, _, 1.0) :-
            !.
        
        % добавление временных данных по расчетным дням
        % - для больничных
        add_month_days_sick(_, _, []):-
            % больше месяцев для проверки нет
            !.
        add_month_days_sick(Scope, PK, [Y-M|Periods]) :-
            % проверить данные по расчетным дням
            get_month_days_sick(Scope, PK, Y, M, _, _),
            !,
            % проверить остальные месяцы
            add_month_days_sick(Scope, PK, Periods).
        add_month_days_sick(Scope, PK, [_|Periods]) :-
            !,
            % проверить остальные месяцы
            add_month_wage_sick(Scope, PK, Periods).
        
        % взять данные по расчетным дням
        % - для больничных
        get_month_days_sick(Scope, PK, Y, M, CalcDays, IsFullMonth) :-
            % взять из временных параметров данные по расчетным дням
            append(PK, [pYM-Y-M, %pRule-Variant,
                        %pMonthDays-MonthDays, pExclDays-ExclDays,
                        pCalcDays-CalcDays, pIsFullMonth-IsFullMonth],
                    Pairs),
            get_param_list(Scope, temp, Pairs),
            !.
        get_month_days_sick(Scope, PK, Y, M, CalcDays, IsFullMonth) :-
            % календарных дней в месяце
            month_days(Y, M, MonthDays),
            % исключаемые из месяца дни по правилам
            excl_month_days_sick(Scope, PK, Y, M, ExclDays, Variant),
            % исключаемые из первого месяца работы дни
            excl_first_month_days_sick(Scope, PK, Y, M, ExclDays1),
            % расчетные дни
            CalcDays is MonthDays - ExclDays - ExclDays1,
            % полнота месяца
            ( CalcDays = MonthDays, IsFullMonth = 1 ; IsFullMonth = 0 ),
            % записать во временные параметры данные по расчетным дням
            append(PK, [pYM-Y-M, pRule-Variant,
                        pMonthDays-MonthDays, pExclDays-ExclDays,
                        pCalcDays-CalcDays, pIsFullMonth-IsFullMonth],
                    Pairs),
            new_param_list(Scope, temp, Pairs),
            !.
        
        %  период является рабочим
        is_work_period(Scope, PK, Y-M) :-
            % календарных дней в месяце
            month_days(Y, M, MonthDays),
            % последняя дата месяца
            atom_date(LastMonthDate, date(Y, M, MonthDays)),
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять даты
            findall( DateIn0,
                     % для первого движения по типу 1 (прием на работу)
                     get_data(Scope, in, usr_wg_MovementLine, [
                     fEmplKey-EmplKey, fDocumentKey-FirstMoveKey, fFirstMoveKey-FirstMoveKey,
                     fDateBegin-DateIn0, fMovementType-1 ]),
            % в список дат приема на работу
            DateInList ),
            % определить последнюю дату приема на работу
            last(DateInList, DateIn),
            % если дата приема на работу не больше последней даты месяца
            DateIn @=< LastMonthDate,
            % то период является рабочим
            !.
        
        % исключаемые из месяца дни
        % - для больничных
        excl_month_days_sick(Scope, PK, Y, M, ExclDays, Rule) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % параметры выбора табеля
            member(TabelOption-Rule, [tbl_cal_flex-by_cal_flex, tbl_cal-by_cal]),
            % есть данные в табеле
            usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, _, _, _, _, TabelOption),
            % правило действительно
            is_valid_rule(Rule),
            % взять данные из табеля
            findall( 1,
                      % для проверяемого месяца
                    ( usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, _, _, _, HoureType, TabelOption),
                      % с контролем наличия типа часов
                      HoureType > 0,
                      % по типу часов для исключения из расчета
                      once( get_data(Scope, in, usr_wg_HourType, [
                                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                                        fID-HoureType, fExcludeForSickList-1] ) )
                    ),
            % в список дней для исключения
            ExclDaysList),
            % проверить список дней для исключения
            \+ ExclDaysList = [],
            % всего дней для исключения
            sum_list(ExclDaysList, ExclDays),
            !.
        excl_month_days_sick(Scope, PK, Y, M, ExclDays, Rule) :-
            Rule = by_orders,
            % правило действительно
            is_valid_rule(Rule),
            % нет данных в табеле
            \+ usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, _, _, _, _, tbl_cal_flex),
            \+ usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, _, _, _, _, tbl_cal),
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные
            findall( FromDate-ToDate-ExclType,
                     get_data(Scope, in, usr_wg_ExclDays, [
                                fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                                fExclType-ExclType,
                                fFromDate-FromDate, fToDate-ToDate] ),
            % в список периодов для исключения
            ExclPeriods),
            sum_excl_periods(ExclPeriods, Y, M, 0, ExclDays, []),
            \+ ExclDays =:= 0,
            !.
        excl_month_days_sick(_, _, _, _, 0, none) :-
            !.
        
        %
        sum_excl_periods([], _, _, ExclDays, ExclDays, _) :-
            !.
        sum_excl_periods([ExclPeriod|ExclPeriods], Y, M, ExclDays0, ExclDays, LogDays0) :-
            calc_excl_period(ExclPeriod, Y, M, ExclDays0, ExclDays1, LogDays0, LogDays1),
            !,
            sum_excl_periods(ExclPeriods, Y, M, ExclDays1, ExclDays, LogDays1).
        
        %
        calc_excl_period(FromDate-ToDate-_, _, _, ExclDays, ExclDays, LogDays, LogDays) :-
            FromDate @> ToDate,
            !.
        calc_excl_period(FromDate0-ToDate-ExclType, Y, M, ExclDays0, ExclDays2, LogDays0, LogDays2) :-
            \+ atom_date(FromDate0, date(Y, M, _)),
            date_add(FromDate0, 1, day, FromDate1),
            !,
            calc_excl_period(FromDate1-ToDate-ExclType, Y, M, ExclDays0, ExclDays2, LogDays0, LogDays2).
        calc_excl_period(FromDate0-ToDate-ExclType, Y, M, ExclDays0, ExclDays2, LogDays0, LogDays2) :-
            ( ExclType = "WG_LEAVEDOCLINE", wg_holiday(FromDate0), ExclDays1 = ExclDays0
            ; member(FromDate0, LogDays0), ExclDays1 = ExclDays0
            ; ExclDays1 is ExclDays0 + 1
            ),
            date_add(FromDate0, 1, day, FromDate1),
            !,
            calc_excl_period(FromDate1-ToDate-ExclType, Y, M, ExclDays1, ExclDays2, [FromDate0|LogDays0], LogDays2).
        
        % исключаемые из первого месяца работы дни
        % - для больничных
        excl_first_month_days_sick(Scope, PK, Y, M, ExclDays) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % для первого движения по типу 1 (прием на работу)
            % где дата совпадает с проверяемым месяцем
            get_data(Scope, in, usr_wg_MovementLine, [
                fEmplKey-EmplKey, fDocumentKey-FirstMoveKey, fFirstMoveKey-FirstMoveKey,
                fMoveYear-Y, fMoveMonth-M, fDateBegin-DateBegin, fMovementType-1 ]),
            % исключить дни до принятия на работу
            atom_date(FirstMonthDate, date(Y, M, 1)),
            date_diff(FirstMonthDate, ExclDays, DateBegin),
            !.
        excl_first_month_days_sick(_, _, _, _, 0) :-
            !.
        
        % месяц работы полный
        is_full_month(Scope, PK, Y-M) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % если для первого движения по типу 1 (прием на работу)
            % где дата совпадает с проверяемым месяцем
            get_data(Scope, in, usr_wg_MovementLine, [
                fEmplKey-EmplKey, fDocumentKey-FirstMoveKey, fFirstMoveKey-FirstMoveKey,
                fMoveYear-Y, fMoveMonth-M, fDateBegin-DateBegin, fMovementType-1 ]),
            !,
            % параметры выбора графика
            member(NormOption, [tbl_cal_flex, tbl_day_norm]),
            % первый рабочий день по графику для проверяемого месяца
            once( usr_wg_TblDayNorm_mix(Scope, in, PK, Y-M, TheDay, _, 1, NormOption) ),
            !,
            % больше или равен дате первого движения
            TheDay @>= DateBegin,
            % то первый месяц работы полный
            !.
        is_full_month(_, _, _) :-
            % проверяемый месяц не является первым месяцем работы
            !.
        
        % в месяце есть отработанные дни или часы
        is_month_worked(Scope, PK, Y-M) :-
            % если есть хотя бы один рабочий день
            usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, _, DOW, HOW, _, _),
            % с контролем наличия дней или часов
            once( (DOW > 0 ; HOW > 0 ) ),
            % то в месяце есть отработанные дни или часы
            !.
        
        % в месяце есть оплата
        is_month_paid(Scope, PK, Y-M) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % если есть хотя бы одно начисление
            usr_wg_TblCharge_mix(Scope, in, [
                fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                fCalYear-Y, fCalMonth-M, fDebit-Debit, fFeeTypeKey-FeeTypeKey ],
                                    _),
            % с контролем суммы
            Debit > 0,
            % соответствующего типа
            ( var(FeeTypeKey)
            ; once( get_data(Scope, in, usr_wg_FeeType, [
                            fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                            fFeeTypeKey-FeeTypeKey ]) ) ),
            % то в месяце есть оплата
            !.
        
        % взять расчетный месяц
        get_month_incl(Scope, PK, Y, M, Variant) :-
            append(PK, [pMonthIncl-MonthInclList], Pairs),
            get_param_list(Scope, temp, Pairs),
            member(Y-M-Variant, MonthInclList).
        
        % принять месяц для исчисления
        take_month_incl(Scope, PK, Y, M, Variant) :-
            append(PK, [pMonthIncl-MonthInclList], Pairs),
            get_param_list(Scope, temp, Pairs),
            keysort([Y-M-Variant | MonthInclList], MonthInclList1),
            append(PK, [pMonthIncl-MonthInclList1], Pairs1),
            dispose_param_list(Scope, temp, Pairs),
            new_param_list(Scope, temp, Pairs1),
            !.
        take_month_incl(Scope, PK, Y, M, Variant) :-
            append(PK, [pMonthIncl-[Y-M-Variant]], Pairs),
            new_param_list(Scope, temp, Pairs),
            !.
        
        % проверка месяца по табелю
        % - для отпусков
        check_month_tab(_, _, []):-
            % больше месяцев для проверки нет
            !.
        check_month_tab(Scope, PK, [Y-M|Periods]) :-
            % месяц работы полный
            is_full_month(Scope, PK, Y-M),
            % в месяце есть отработанные дни или часы
            is_month_worked(Scope, PK, Y-M),
            % в месяце есть оплата
            is_month_paid(Scope, PK, Y-M),
            % и выполняется одно из правил
            rule_month_tab(Scope, PK, Y-M, Variant),
            % то принять месяц для исчисления
            take_month_incl(Scope, PK, Y, M, Variant),
            !,
            % проверить остальные месяцы
            check_month_tab(Scope, PK, Periods).
        check_month_tab(Scope, PK, [_|Periods]) :-
            !,
            % проверить остальные месяцы
            check_month_tab(Scope, PK, Periods).
        
        % правила включения месяца в расчет
        rule_month_tab(Scope, PK, Y-M, Rule) :-
            % по дням и часам за месяц
            Rule = by_days_houres,
            % правило действительно
            is_valid_rule(Rule),
            % взять данные по графику и табелю за месяц
            get_month_norm_tab(Scope, PK, Y-M, NDays, TDays, NHoures, THoures),
            % если табель равен графику по дням и часам
            TDays =:= NDays, THoures =:= NHoures,
            % то месяц включается в расчет
            !.
        rule_month_tab(Scope, PK, Y-M, Rule) :-
            % по часам за месяц
            Rule = by_houres,
            % правило действительно
            is_valid_rule(Rule),
            % взять данные по графику и табелю за месяц
            get_month_norm_tab(Scope, PK, Y-M, _, _, NHoures, THoures),
            % если табель покрывает график по часам
            THoures >= NHoures,
            % то месяц включается в расчет
            !.
        rule_month_tab(Scope, PK, Y-M, Rule) :-
            % по дням за месяц
            Rule = by_days,
            % правило действительно
            is_valid_rule(Rule),
            % взять данные по графику и табелю за месяц
            get_month_norm_tab(Scope, PK, Y-M, NDays, TDays, _, _),
            % если табель покрывает график по дням
            TDays >= NDays,
            % то месяц включается в расчет
            !.
        
        % взять данные по графику и табелю за месяц
        get_month_norm_tab(Scope, PK, Y-M, NDays, TDays, NHoures, THoures) :-
            % взять из временных параметров дни и часы
            append(PK, [pYM-Y-M,
                        pTDays-TDays, pTHoures-THoures,
                        pNDays-NDays, pNHoures-NHoures],
                        Pairs),
            get_param_list(Scope, temp, Pairs),
            !.
        get_month_norm_tab(Scope, PK, Y-M, NDays, TDays, NHoures, THoures) :-
            % расчитать график и табель за месяц
            calc_month_norm_tab(Scope, PK, Y-M, NDays, TDays, NHoures, THoures),
            % записать во временные параметры дни и часы
            append(PK, [pYM-Y-M,
                        pTDays-TDays, pTHoures-THoures,
                        pNDays-NDays, pNHoures-NHoures],
                        Pairs),
            new_param_list(Scope, temp, Pairs),
            !.
        
        % расчитать график и табель за месяц
        calc_month_norm_tab(Scope, PK, Y-M, NDays, TDays, NHoures, THoures) :-
            % расчитать график за месяц
            calc_month_norm(Scope, PK, Y-M, NormDays),
            % сумма дней и часов по графику
            sum_days_houres(NormDays, NDays, NHoures),
            % расчитать табель за месяц
            calc_month_tab(Scope, PK, Y-M, TabDays),
            % сумма дней и часов по табелю
            sum_days_houres(TabDays, TDays, THoures),
            !.
        
        % расчитать график за месяц по одному из параметров
        calc_month_norm(Scope, PK, Y-M, NormDays) :-
            % параметры выбора графика
            member(NormOption, [tbl_cal_flex, tbl_day_norm]),
            % взять дату/часы
            findall( TheDay-1-WDuration,
                    % для рабочего дня
                    ( usr_wg_TblDayNorm_mix(Scope, in, PK,
                        Y-M, TheDay, WDuration, 1, NormOption),
                    % с контролем наличия часов
                    WDuration > 0 ),
            % в список дата/часы графика
            NormDays),
            % проверить список графика
            \+ NormDays = [],
            !.
        calc_month_norm(_, _, _, []) :-
            !.
        
        % расчитать табель за месяц по одному из параметров
        calc_month_tab(Scope, PK, Y-M, TabDays) :-
            % параметры выбора табеля
            member(TabelOption, [tbl_cal_flex, tbl_cal, tbl_charge, dbf_sums]),
            % взять данные из табеля
            findall( Date-DOW-HOW,
                    % для проверяемого месяца
                    ( usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, Date, DOW, HOW, _, TabelOption),
                    % с контролем наличия дней или часов
                    once( (DOW > 0 ; HOW > 0 ) )
                    ),
            % в список дата-день-часы
            TabDays),
            % проверить список табеля
            \+ TabDays = [],
            !.
        calc_month_tab(_, _, _, []) :-
            !.
        
        % сумма дней и часов
        sum_days_houres(ListDays, Days, Houres) :-
            sum_days_houres(ListDays, Days, Houres, 0, 0),
            !.
        %
        sum_days_houres([], Days, Houres, Days, Houres).
        sum_days_houres([_-DOW-HOW|ListDays], Days, Houres, Days0, Houres0) :-
            Days1 is Days0 + DOW,
            Houres1 is Houres0 + HOW,
            !,
            sum_days_houres(ListDays, Days, Houres, Days1, Houres1).
        
        % проверка месяца по заработку
        % - для отпусков
        check_month_wage(_, _, []):-
            % больше месяцев для проверки нет
            !.
        check_month_wage(Scope, PK, [Y-M|Periods]) :-
            % если месяц еще не включен в расчет
            \+ get_month_incl(Scope, PK, Y, M, _),
            % и выполняется одно из правил
            rule_month_wage(Scope, PK, Y-M, Variant),
            % то принять месяц для исчисления
            take_month_incl(Scope, PK, Y, M, Variant),
            !,
            % проверить следующий месяц
            check_month_wage(Scope, PK, Periods).
        check_month_wage(Scope, PK, [_|Periods]) :-
            !,
            % проверить следующий месяц
            check_month_wage(Scope, PK, Periods).
        
        % заработок за месяц выше или на уровне каждого из полных месяцев
        rule_month_wage(Scope, PK, Y-M, Rule) :-
            Rule = by_month_wage_all,
            % правило действительно
            is_valid_rule(Rule),
            % варианты правил полных месяцев
            wg_full_month_rules(FullMonthRules),
            % взять заработок и коэффициент осовременивания за проверяемый месяц
            get_month_wage(Scope, PK, Y, M, ModernCoef, Wage),
            % взять заработок
            findall( Wage1,
                      % для расчетного месяца
                    ( get_month_incl(Scope, PK, Y1, M1, Variant1),
                      % который принят для исчисления по варианту полного месяца
                      once( member(Variant1, FullMonthRules) ),
                      % с заработком и коэффициентом осовременивания за месяц
                      get_month_wage(Scope, PK, Y1, M1, ModernCoef1, Wage1),
                      % где коэффициенты для проверяемого и расчетного равны
                      ModernCoef =:= ModernCoef1 ),
            % в список заработков
            Wages1 ),
            % если заработок проверяемого месяца покрывает все из расчетных
            wage_over_list(Wage, Wages1),
            % то месяц включается в расчет
            !.
        % заработок за месяц больше или равен любого из полных месяцев
        rule_month_wage(Scope, PK, Y-M, Rule) :-
            Rule = by_month_wage_any,
            % правило действительно
            is_valid_rule(Rule),
            % варианты правил полных месяцев
            wg_full_month_rules(FullMonthRules),
            % взять заработок и коэффициент осовременивания за проверяемый месяц
            get_month_wage(Scope, PK, Y, M, ModernCoef, Wage),
            % взять заработок
            findall( Wage1,
                      % для расчетного месяца
                    ( get_month_incl(Scope, PK, Y1, M1, Variant1),
                      % который принят для исчисления по варианту полного месяца
                      once( member(Variant1, FullMonthRules) ),
                      % с заработком и коэффициентом осовременивания за месяц
                      get_month_wage(Scope, PK, Y1, M1, ModernCoef1, Wage1),
                      % где коэффициенты для проверяемого и расчетного равны
                      ModernCoef =:= ModernCoef1 ),
            % в список заработков
            Wages1 ),
            % если заработок проверяемого месяца покрывает любой из расчетных
            wage_over_any(Wage, Wages1),
            % то месяц включается в расчет
            !.
        
        % заработок покрывает все значения из списка
        wage_over_list(Over, [Head|[]]) :-
            Over >= Head,
            !.
        wage_over_list(Over, [Head|Tail]) :-
            Over >= Head,
            !,
            wage_over_list(Over, Tail).
        
        % заработок покрывает любое значение из списка
        wage_over_any(Over, [Head|_]) :-
            Over >= Head,
            !.
        wage_over_any(Over, [_|Tail]) :-
            !,
            wage_over_any(Over, Tail).
        
        % проверка месяца по типу начислений и типу часов
        % - для отпусков
        check_month_no_bad_type(_, _, []):-
            % больше месяцев для проверки нет
            !.
        check_month_no_bad_type(Scope, PK, [Y-M|Periods]) :-
            % если месяц еще не включен в расчет
            \+ get_month_incl(Scope, PK, Y, M, _),
            % месяц работы полный
            is_full_month(Scope, PK, Y-M),
            % в месяце есть оплата
            is_month_paid(Scope, PK, Y-M),
            % и выполняется одно из правил
            rule_month_no_bad_type(Scope, PK, Y-M, Variant),
            % то принять месяц для исчисления
            take_month_incl(Scope, PK, Y, M, Variant),
            !,
            % проверить следующий месяц
            check_month_no_bad_type(Scope, PK, Periods).
        check_month_no_bad_type(Scope, PK, [_|Periods]) :-
            !,
            % проверить следующий месяц
            check_month_no_bad_type(Scope, PK, Periods).
        
        % отсутствие плохих типов начислений и часов
        rule_month_no_bad_type(Scope, PK, Y-M, Rule) :-
            Rule = by_month_no_bad_type,
            % правило действительно
            is_valid_rule(Rule),
            % если нет плохих типов начислений и часов
            \+ month_bad_type(Scope, PK, Y-M),
            % то месяц включается в расчет
            !.
        
        % есть плохой тип часов
        month_bad_type(Scope, PK, Y-M) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % если есть хотя бы один день по табелю
            usr_wg_TblCalLine_mix(Scope, in, PK, Y-M, _, _, _, HoureType, _),
            % с плохим типом часов
            nonvar(HoureType),
            HoureType > 0,
            once( get_data(Scope, in, usr_wg_BadHourType, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey, fID-HoureType]) ),
            !.
        % есть плохой тип начислений
        month_bad_type(Scope, PK, Y-M) :-
            % разложить первичный ключ
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % если есть хотя бы одно начисление
            % где дата совпадает с проверяемым месяцем
            usr_wg_TblCharge_mix(Scope, in, [
                fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                fCalYear-Y, fCalMonth-M, fFeeTypeKey-FeeTypeKey ],
                                    _),
            % с плохим типом начисления
            nonvar(FeeTypeKey),
            FeeTypeKey > 0,
            once( get_data(Scope, in, usr_wg_BadFeeType, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey, fID-FeeTypeKey]) ),
            !.
        
        %% взять данные по начислению
        % начисление из TblCharge
        usr_wg_TblCharge_mix(Scope, Type, ArgPairs, ChargeOption) :-
            ChargeOption = tbl_charge,
            get_data(Scope, Type, usr_wg_TblCharge, ArgPairs).
        % или начисление из dbf
        usr_wg_TblCharge_mix(Scope, Type, ArgPairs, ChargeOption) :-
            ChargeOption = dbf_sums,
            ValuePairs = [
                        fEmplKey-EmplKey, fFirstMoveKey-_,
                        fCalYear-CalYear, fCalMonth-CalMonth, fDateBegin-DateBegin,
                        fDebit-Debit, fFeeTypeKey-_
                        ],
            member_list(ArgPairs, ValuePairs),
            gd_pl_ds(Scope, Type, usr_wg_DbfSums, 6, _),
            catch( usr_wg_DbfSums(EmplKey, Debit, _, CalYear, CalMonth, DateBegin), _, fail).
        
        %% взять данные по графику
        % день месяца по календарному графику
        usr_wg_TblDayNorm_mix(Scope, Type, PK, Y-M, Date, Duration, WorkDay, NormOption) :-
            NormOption = tbl_cal_flex,
            get_Flex_by_type(Scope, Type, PK, Y-M, Date, WorkDay, Duration, _, "plan").
        % или день месяца по справочнику графика рабочего времени
        usr_wg_TblDayNorm_mix(Scope, Type, PK, Y-M, TheDay, WDuration, WorkDay, NormOption) :-
            NormOption = tbl_day_norm,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            get_data(Scope, Type, usr_wg_TblDayNorm, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fWYear-Y, fWMonth-M, fTheDay-TheDay,
                        fWDuration-WDuration, fWorkDay-WorkDay ]).
        
        %% взять данные по табелю
        % день месяца по табелю мастера
        usr_wg_TblCalLine_mix(Scope, Type, PK, Y-M, Date, Days, Duration, HoureType, TabelOption) :-
            TabelOption = tbl_cal_flex,
            get_Flex_by_type(Scope, Type, PK, Y-M, Date, Days, Duration, HoureType, "fact").
        % или день месяца по табелю
        usr_wg_TblCalLine_mix(Scope, Type, PK, Y-M, Date, Days, Duration, HoureType, TabelOption) :-
            TabelOption = tbl_cal,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            get_data(Scope, Type, usr_wg_TblCalLine, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fCalYear-Y, fCalMonth-M, fDate-Date,
                        fDuration-Duration, fHoureType-HoureType]),
            once( (Duration > 0, Days = 1 ; Days = 0) ).
        % или табель дни-часы из начислений
        usr_wg_TblCalLine_mix(Scope, Type, PK, Y-M, Date, DOW, HOW, 0, TabelOption) :-
            TabelOption = tbl_charge,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            ArgPairs = [fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fCalYear-Y, fCalMonth-M, fDateBegin-Date,
                        fFeeTypeKey-FeeTypeKey, fDOW-DOW, fHOW-HOW],
            get_data(Scope, Type, usr_wg_TblCharge, ArgPairs),
            once( get_data(Scope, Type, usr_wg_FeeType, [
                            fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                            fFeeTypeKey-FeeTypeKey, fAvgDayHOW-1]) ).
        % или день месяца из dbf
        usr_wg_TblCalLine_mix(Scope, Type, PK, Y-M, Date, Days, InHoures, 0, TabelOption) :-
            TabelOption = dbf_sums,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-_],
            get_data(Scope, Type, usr_wg_DbfSums, [
                        fEmplKey-EmplKey, fInHoures-InHoures,
                        fInYear-Y, fInMonth-M, fDateBegin-Date]),
            once( (InHoures > 0, Days = 1 ; Days = 0) ).
        
        % день месяца по календарному графику или табелю мастера
        % FlexType: "plan" ; "fact"
        get_Flex_by_type(Scope, Type, PK, Y-M, Date, Days, Duration, HoureType, FlexType) :-
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            gd_pl_ds(Scope, Type, usr_wg_TblCal_FlexLine, 68, _),
            make_list(62, TeilArgs),
            Term =..[ usr_wg_TblCal_FlexLine, FlexType, EmplKey, FirstMoveKey, Y, M, _ | TeilArgs ],
            catch( call( Term ), _, fail),
            member(D, [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16,
                        17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]),
            atom_date(Date, date(Y, M, D)),
            S is (D - 1) * 2 + 6 + 1,
            H is S + 1,
            arg(S, Term, Duration0),
            once( ( number(Duration0), Duration = Duration0
                    ; atom_number(Duration0, Duration)
                    ; Duration = 0 ) ),
            arg(H, Term, HoureType0),
            once( ( number(HoureType0), HoureType = HoureType0
                    ; atom_number(HoureType0, HoureType)
                    ; HoureType = 0 ) ),
            once( (Duration > 0, Days = 1 ; Days = 0) ).
        
        %% engine_loop(+Scope, +Type, +PK)
        %
        
        % args handler
        engine_loop(Scope, Type, PK) :-
            \+ ground([Scope, Type, PK]),
            !,
            fail.
        % fail handler
        engine_loop(Scope, _, PK) :-
            engine_fail_step(Type),
            get_param_list(Scope, Type, PK),
            !,
            fail.
        % deal handler
        engine_loop(Scope, Type, PK) :-
            engine_deal_step(Type),
            !,
            get_param_list(Scope, Type, PK),
            !.
        % data handler
        engine_loop(Scope, Type, PK) :-
            engine_data_step(Type, TypeNextStep),
            get_param_list(Scope, Type, PK),
            \+ get_param_list(Scope, TypeNextStep, PK),
            prepare_data(Scope, Type, PK, TypeNextStep),
            !,
            engine_loop(Scope, TypeNextStep, PK).
        engine_loop(Scope, Type, PK) :-
            engine_data_step(Type, TypeNextStep),
            !,
            engine_loop(Scope, TypeNextStep, PK).
        % restart handler
        engine_loop(Scope, Type, PK) :-
            engine_restart_step(Type, TypeNextStep),
            forall( ( get_param_list(Scope, ParamType, PK, Pairs),
                      \+ ParamType = TypeNextStep ),
                    dispose_param_list(Scope, ParamType, Pairs)
                  ),
            !,
            engine_loop(Scope, TypeNextStep, PK).
        % clean handler
        engine_loop(Scope, Type, PK) :-
            engine_clean_step(Type, CleanType),
            forall( ( get_param_list(Scope, ParamType, PK, Pairs),
                      ParamType = CleanType ),
                    dispose_param_list(Scope, ParamType, Pairs)
                  ),
            forall( ( get_sql(Scope, _, Query/Arity, _, _),
                      current_functor(Query, Arity),
                      is_valid_sql(Query/Arity) ),
                    ( length(PK, Len),
                      Arity1 is Arity - Len,
                      make_list(Arity1, TeilArgs),
                      PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
                      append([EmplKey, FirstMoveKey], TeilArgs, Args),
                      Term =.. [Query | Args ],
                      retractall( Term ) )
                    ),
            !.
        % error handler
        engine_loop(Scope, Type, PK) :-
            engine_error_step(TypeNextStep),
            \+ get_param_list(Scope, TypeNextStep, PK),
            get_local_date_time(DT),
            append(PK, [Type, DT], PairsNextStep),
            new_param_list(Scope, TypeNextStep, PairsNextStep),
            !,
            fail.
        
        %
        engine_data_step(in, run).
        engine_data_step(run, query).
        engine_data_step(query, data).
        %
        engine_deal_step(run) :-
            debug_mode,
            !.
        engine_deal_step(data).
        %
        engine_fail_step(out).
        engine_fail_step(error).
        %
        engine_restart_step(restart, in).
        %
        engine_clean_step(clean, data).
        %
        engine_error_step(error).
        
         %
        %%
        
        %% prepare_data(+Scope, +Type, +PK, +TypeNextStep)
        %  05. Начисление отпусков
        % wg_avg_wage_vacation-in-run
        prepare_data(Scope, Type, PK, TypeNextStep) :-
            Scope = wg_avg_wage_vacation, Type = in, TypeNextStep = run,
            get_param_list(Scope, Type, [pMonthQty-MonthQty], Pairs0),
            get_param_list(Scope, Type, PK, Pairs),
            member_list([pDateCalc-DateCalc, pMonthOffset-MonthOffset], Pairs),
            %
            atom_date(DateCalc, date(Y0, M0, _)),
            atom_date(DateCalcTo0, date(Y0, M0, 1)),
            MonthOffset1 is (- MonthOffset),
            date_add(DateCalcTo0, MonthOffset1, month, DateCalcTo),
            MonthAdd is (- MonthQty),
            date_add(DateCalcTo, MonthAdd, month, DateCalcFrom),
            date_add(DateCalcTo, -1, day, DateCalcTo1),
            atom_date(DateCalcTo1, date(Y, _, _)),
            atom_date(DateNormFrom, date(Y, 1, 1)),
            Y1 is Y + 1,
            atom_date(DateNormTo, date(Y1, 1, 1)),
            %
            append(Pairs,
                    [pDateCalcFrom-DateCalcFrom, pDateCalcTo-DateCalcTo,
                    pDateNormFrom-DateNormFrom, pDateNormTo-DateNormTo
                    |Pairs0],
                PairsNextStep),
            new_param_list(Scope, TypeNextStep, PairsNextStep),
            !.
        
        % wg_avg_wage_*-run-query
        prepare_data(Scope, Type, PK, TypeNextStep) :-
            once( member(Scope, [wg_avg_wage_vacation, wg_avg_wage_sick]) ),
            Type = run, TypeNextStep = query,
            get_param_list(Scope, Type, PK, Pairs),
            forall( ( gd_pl_ds(Scope, in, PredicateName, Arity, _),
                      Query = PredicateName/Arity,
                      is_valid_sql(Query),
                      get_sql(Scope, in, Query, SQL, Params),
                      member_list(Params, Pairs),
                      prepare_sql(SQL, Params, PrepSQL),
                      \+ find_param_list(Scope, TypeNextStep, PK, [pQuery-Query, pSQL-PrepSQL])
                    ),
                    ( append(PK, [pQuery-Query, pSQL-PrepSQL], PairsNextStep),
                      new_param_list(Scope, TypeNextStep, PairsNextStep)
                    )
                  ),
            !.
        
        %  06. Начисление больничных
        % wg_avg_wage_sick-in-run
        prepare_data(Scope, Type, PK, TypeNextStep) :-
            Scope = wg_avg_wage_sick, Type = in, TypeNextStep = run,
            get_param_list(Scope, Type, [pMonthQty-MonthQty], Pairs0),
            get_param_list(Scope, Type, PK, Pairs),
            member_list([pDateCalc-DateCalc], Pairs),
            %
            atom_date(DateCalc, date(Y, M, _)),
            atom_date(DateCalcTo, date(Y, M, 1)),
            MonthAdd is (- MonthQty),
            date_add(DateCalcTo, MonthAdd, month, DateCalcFrom),
            %
            append(Pairs,
                    [pDateCalcFrom-DateCalcFrom, pDateCalcTo-DateCalcTo | Pairs0],
                PairsNextStep),
            new_param_list(Scope, TypeNextStep, PairsNextStep),
            !.
        
        %%
        
        %% расширение для клиента
        %  05. Начисление отпусков
        
        % загрузка входных данных по сотруднику
        % CoefOption: fc_fcratesum ; ml_rate ; ml_msalary
        avg_wage_in(EmplKey, FirstMoveKey, DateCalc, MonthOffset, CoefOption) :-
            Scope = wg_avg_wage_vacation, Type = in,
            new_param_list(Scope, Type,
                [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey,
                 pDateCalc-DateCalc, pMonthOffset-MonthOffset,
                 pCoefOption-CoefOption]),
            !.
        
        % выгрузка данных выполнения по сотруднику
        avg_wage_run(EmplKey, FirstMoveKey, DateCalcFrom, DateCalcTo) :-
            Scope = wg_avg_wage_vacation, Type = run,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            append(PK, [pDateCalcFrom-DateCalcFrom, pDateCalcTo-DateCalcTo], Pairs),
            get_param_list(Scope, Type, Pairs).
        
        % выгрузка SQL-запросов по сотруднику
        avg_wage_sql(EmplKey, FirstMoveKey, PredicateName, Arity, SQL) :-
            Scope = wg_avg_wage_vacation, Type = query, TypeNextStep = data,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            Query = PredicateName/Arity,
            find_param_list(Scope, Type, PK, [pQuery-Query, pSQL-SQL]),
            \+ find_param_list(Scope, TypeNextStep, PK, [pQuery-Query, pSQL-SQL]).
        
        % подтвеждение формирования фактов по сотруднику
        avg_wage_kb(EmplKey, FirstMoveKey, PredicateName, Arity, SQL) :-
            Scope = wg_avg_wage_vacation, Type = query, TypeNextStep = data,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            Query = PredicateName/Arity,
            find_param_list(Scope, Type, PK, [pQuery-Query, pSQL-SQL]),
            \+ find_param_list(Scope, TypeNextStep, PK, [pQuery-Query, pSQL-SQL]),
            append(PK, [pQuery-Query, pSQL-SQL], PairsNextStep),
            new_param_list(Scope, TypeNextStep, PairsNextStep),
            !.
        
        % выгрузка выходных данных по сотруднику
        avg_wage_out(EmplKey, FirstMoveKey, AvgWage, Variant) :-
            % параметры контекста
            Scope = wg_avg_wage_vacation, Type = out,
            % шаблон первичного ключа
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные по результатам расчета
            append(PK, [pAvgWage-AvgWage, pVariant-Variant], Pairs),
            get_param_list(Scope, Type, Pairs).
        
        % выгрузка детальных выходных данных по сотруднику
        avg_wage_det(EmplKey, FirstMoveKey,
                        Period, Rule, Wage, ModernCoef, ModernWage,
                        TabDays, NormDays, TabHoures, NormHoures) :-
            % параметры контекста
            Scope = wg_avg_wage_vacation, Type = temp,
            % шаблон первичного ключа
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % для каждого периода
            % взять данные по табелю и графику
            append(PK, [pYM-Y-M,
                            pTDays-TabDays, pTHoures-TabHoures,
                            pNDays-NormDays, pNHoures-NormHoures],
                    Pairs),
            get_param_list(Scope, Type, Pairs),
            % если для первого движения по типу 1 (прием на работу)
            % дата совпадает с проверяемым месяцем, то период есть дата начала работы
            once( (
                get_data(Scope, in, usr_wg_MovementLine, [
                fEmplKey-EmplKey, fDocumentKey-FirstMoveKey, fFirstMoveKey-FirstMoveKey,
                fMoveYear-Y, fMoveMonth-M, fDateBegin-Period, fMovementType-1 ])
                ;
            % иначе сформировать дату периода, как первый день месяца
                atom_date(Period, date(Y, M, 1))
                ) ),
            % взять данные по правилам расчета
            append(PK, [pMonthIncl-MonthIncl], Pairs1),
            once( ( get_param_list(Scope, Type, Pairs1) ; MonthIncl = [] ) ),
            once( ( member(Y-M-Rule, MonthIncl) ; Rule = none ) ),
            % взять данные по заработку
            once( ( ( append(PK, [pYM-Y-M,
                                    pWage-Wage, pModernCoef-ModernCoef,
                                    pModernWage-ModernWage],
                                Pairs2),
                      get_param_list(Scope, Type, Pairs2) )
                      ; [Wage, ModernCoef, ModernWage] = [0, 1, 0] ) ),
            %
            % есть отработанные часы или заработок
            once( ( TabHoures > 0 ; ModernWage > 0 ) ).
        
        % удаление данных по сотруднику
        avg_wage_clean(EmplKey, FirstMoveKey) :-
            Scope = wg_avg_wage_vacation,
            get_type_list(TypeList),
            member(Type, TypeList),
            gd_pl_ds(Scope, Type, Name, _, _),
            del_data(Scope, Type, Name, [fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey]),
            fail.
        avg_wage_clean(EmplKey, FirstMoveKey) :-
            Scope = wg_avg_wage_vacation,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            get_param_list(Scope, Type, PK, Pairs),
            dispose_param_list(Scope, Type, Pairs),
            fail.
        avg_wage_clean(_, _) :-
            !.
        
        %% расширение для клиента
        %  06. Начисление больничных
        
        % загрузка входных данных по сотруднику
        avg_wage_sick_in(EmplKey, FirstMoveKey, DateCalc, IsAvgWageDoc) :-
            Scope = wg_avg_wage_sick, Type = in,
            new_param_list(Scope, Type,
                [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey,
                 pDateCalc-DateCalc, pIsAvgWageDoc-IsAvgWageDoc]),
            !.
        
        % выгрузка данных выполнения по сотруднику
        avg_wage_sick_run(EmplKey, FirstMoveKey, DateCalcFrom, DateCalcTo) :-
            Scope = wg_avg_wage_sick, Type = run,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            append(PK, [pDateCalcFrom-DateCalcFrom, pDateCalcTo-DateCalcTo], Pairs),
            get_param_list(Scope, Type, Pairs).
        
        % выгрузка SQL-запросов по сотруднику
        avg_wage_sick_sql(EmplKey, FirstMoveKey, PredicateName, Arity, SQL) :-
            Scope = wg_avg_wage_sick, Type = query, TypeNextStep = data,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            Query = PredicateName/Arity,
            find_param_list(Scope, Type, PK, [pQuery-Query, pSQL-SQL]),
            \+ find_param_list(Scope, TypeNextStep, PK, [pQuery-Query, pSQL-SQL]).
        
        % подтвеждение формирования фактов по сотруднику
        avg_wage_sick_kb(EmplKey, FirstMoveKey, PredicateName, Arity, SQL) :-
            Scope = wg_avg_wage_sick, Type = query, TypeNextStep = data,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            Query = PredicateName/Arity,
            find_param_list(Scope, Type, PK, [pQuery-Query, pSQL-SQL]),
            \+ find_param_list(Scope, TypeNextStep, PK, [pQuery-Query, pSQL-SQL]),
            append(PK, [pQuery-Query, pSQL-SQL], PairsNextStep),
            new_param_list(Scope, TypeNextStep, PairsNextStep),
            !.
        
        % выгрузка выходных данных по сотруднику
        avg_wage_sick_out(EmplKey, FirstMoveKey, AvgWage, Variant) :-
            % параметры контекста
            Scope = wg_avg_wage_sick, Type = out,
            % шаблон первичного ключа
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % взять данные по результатам расчета
            append(PK, [pAvgWage-AvgWage, pVariant-Variant], Pairs),
            get_param_list(Scope, Type, Pairs).
        
        % выгрузка детальных выходных данных по сотруднику
        avg_wage_sick_det(EmplKey, FirstMoveKey,
                        Period, Rule,
                        MonthDays, ExclDays, CalcDays, IsFullMonth,
                        Wage,
                        TabDays, NormDays, TabHoures, NormHoures) :-
            % параметры контекста
            Scope = wg_avg_wage_sick, Type = temp,
            % шаблон первичного ключа
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            % для каждого периода
            % взять данные по расчетным дням
            append(PK, [pYM-Y-M, pRule-Rule,
                        pMonthDays-MonthDays, pExclDays-ExclDays,
                        pCalcDays-CalcDays, pIsFullMonth-IsFullMonth],
                    Pairs),
            get_param_list(Scope, temp, Pairs),
            % взять данные по заработку
            append(PK, [pYM-Y-M, pWage-Wage], Pairs1),
            get_param_list(Scope, Type, Pairs1),
            % взять данные по табелю и графику
            append(PK, [pYM-Y-M,
                            pTDays-TabDays, pTHoures-TabHoures,
                            pNDays-NormDays, pNHoures-NormHoures],
                    Pairs2),
            get_param_list(Scope, Type, Pairs2),
            % если для первого движения по типу 1 (прием на работу)
            % дата совпадает с проверяемым месяцем, то период есть дата начала работы
            once( (
                get_data(Scope, in, usr_wg_MovementLine, [
                fEmplKey-EmplKey, fDocumentKey-FirstMoveKey, fFirstMoveKey-FirstMoveKey,
                fMoveYear-Y, fMoveMonth-M, fDateBegin-Period, fMovementType-1 ])
                ;
            % иначе сформировать дату периода, как первый день месяца
                atom_date(Period, date(Y, M, 1))
                ) ),
            true.
        
        % удаление данных по сотруднику
        avg_wage_sick_clean(EmplKey, FirstMoveKey) :-
            Scope = wg_avg_wage_sick,
            get_type_list(TypeList),
            member(Type, TypeList),
            gd_pl_ds(Scope, Type, Name, _, _),
            del_data(Scope, Type, Name, [fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey]),
            fail.
        avg_wage_sick_clean(EmplKey, FirstMoveKey) :-
            Scope = wg_avg_wage_sick,
            PK = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            get_param_list(Scope, Type, PK, Pairs),
            dispose_param_list(Scope, Type, Pairs),
            fail.
        avg_wage_sick_clean(_, _) :-
            !.
        
         %
        %%
        
        /**/
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-14T09:42:22+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "151189469_18175251 lib"
          - 
            ADDFUNCTIONKEY: "151189468_18175251 params"
          - 
            ADDFUNCTIONKEY: "151189470_18175251 twg_avg_wage_sql"
          - 
            ADDFUNCTIONKEY: "151189471_18175251 twg_avg_wage_in_params"
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 156300302_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 156300135_119200397
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "twg_struct_sql"
      COMMENT: ~
      SCRIPT: | 
        % twg_struct_sql
        
        :-
            GetSQL = [gd_pl_ds/5, get_sql/5],
            %dynamic(GetSQL),
            multifile(GetSQL),
            discontiguous(GetSQL).
        
        %
        wg_valid_sql(
                    [
                    wg_holiday/1,
                    wg_vacation_slice/2,
                    gd_const_budget/2,
                    usr_wg_TblDayNorm/8
                    ]).
        
        %
        is_valid_sql(Functor/Arity) :-
            wg_valid_sql(ValidSQL),
            member(Functor/Arity, ValidSQL),
            !.
        
        gd_pl_ds(wg_struct_vacation, in, wg_holiday, 1, [fHolidayDate-date]).
        % wg_holiday(HolidayDate)
        get_sql(wg_struct_vacation, in, wg_holiday/1,
        "SELECT \c
          h.holidaydate \c
        FROM \c
          wg_holiday h \c
        WHERE \c
          h.holidaydate BETWEEN \'pDateBegin\' AND \'pDateEnd\' \c
          AND COALESCE(h.disabled, 0) = 0 \c
        ",
        [pDateBegin-_, pDateEnd-_]
            ).
        
        gd_pl_ds(wg_struct_vacation, in, wg_vacation_slice, 2,
            [
            fVcType-integer, fSlice-float
            ]).
        % wg_vacation_slice(VcType, Slice)
        get_sql(wg_struct_vacation, in, wg_vacation_slice/2,
        "SELECT \c
          0 AS VcType, COALESCE(USR$DURATION,0) AS Slice \c
        FROM \c
          USR$WG_VACATION \c
        WHERE \c
          DOCUMENTKEY = pDocKey \c
        UNION ALL \c
        SELECT \c
          1 AS VcType, COALESCE(USR$EXTRADURATION,0) AS Slice \c
        FROM \c
          USR$WG_VACATION \c
        WHERE \c
          DOCUMENTKEY = pDocKey \c
        --UNION ALL \c
        SELECT \c
          2 AS VcType, COALESCE(USR$UNHEALTHY,0) AS Slice \c
        FROM \c
          USR$WG_VACATION \c
        WHERE \c
          DOCUMENTKEY = pDocKey \c
        UNION ALL \c
        SELECT \c
          3 AS VcType, COALESCE(USR$UNFIXED,0) AS Slice \c
        FROM \c
          USR$WG_VACATION \c
        WHERE \c
          DOCUMENTKEY = pDocKey \c
        UNION ALL \c
        SELECT \c
          4 AS VcType, COALESCE(USR$COMPENSATIONDAY,0) AS Slice \c
        FROM \c
          USR$WG_VACATION \c
        WHERE \c
          DOCUMENTKEY = pDocKey \c
        ",
        [pDocKey-_]
            ).
        
        gd_pl_ds(wg_struct_sick, in, gd_const_budget, 2, [fConstDate-date, fBudget-float]).
        % gd_const_budget(ConstDate, Budget)
        get_sql(wg_struct_sick, in, gd_const_budget/2,
        "SELECT \c
          cv.CONSTDATE, \c
          CAST(cv.CONSTVALUE AS DECIMAL(15,4)) AS Budget \c
        FROM \c
          GD_CONSTVALUE cv \c
        JOIN \c
          GD_CONST c \c
            ON c.ID  =  cv.CONSTKEY \c
        WHERE \c
          cv.CONSTKEY = \c
          (SELECT id FROM gd_ruid WHERE xid = pBudget_xid AND dbid = pBudget_dbid) \c
        ORDER BY \c
          cv.CONSTDATE \c
        ",
        [pBudget_xid-_, pBudget_dbid-_]
            ).
        
        gd_pl_ds(wg_struct_sick, in, usr_wg_TblDayNorm, 8,
            [
            fEmplKey-integer, fFirstMoveKey-integer,
            fWYear-integer, fWMonth-integer, fTheDay-date, fWDay-integer,
            fWDuration-float, fWorkDay-integer
            ]).
        % usr_wg_TblDayNorm(EmplKey, FirstMoveKey, WYear, WMonth, TheDay, WDay, WDuration, WorkDay)
        get_sql(wg_struct_sick, in, usr_wg_TblDayNorm/8,
        "\c
        SELECT EmplKey, FirstMoveKey, WYear, WMonth, TheDay, WDay, WDuration, WorkDay \c
        FROM USR$WG_TBLCALDAY_P(pEmplKey, pFirstMoveKey, \'pDateCalcFrom\', \'pDateCalcTo\') \c
        ",
        [pEmplKey-_, pFirstMoveKey-_, pDateCalcFrom-_, pDateCalcTo-_]
            ).
        
        %
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-21T12:22:42+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 156300135_119200397
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "twg_struct"
      COMMENT: ~
      SCRIPT: | 
        % twg_struct
        
        % расчет структуры
        % - для отпусков
        %
        
        :- retractall(debug_mode).
        
        % ! при использовании в ТП Гедымин
        % ! для begin & end debug mode section
        % ! убрать символ процента из первой позиции
        /* %%% begin debug mode section
        
        %% saved state
        :- ['../gd_pl_state/load_atom', '../gd_pl_state/date', '../gd_pl_state/dataset'].
        %%
        
        %% include
        %#INCLUDE lib
        :- [lib].
        %#INCLUDE params
        :- [params].
        %%
        %#INCLUDE twg_struct_sql
        :- [twg_struct_sql].
        %#INCLUDE twg_struct_in_params
        %:- [twg_struct_in_params].
        
        %% facts
        :-  init_data,
            [
            wg_holiday,
            wg_vacation_slice,
            gd_const_budget,
            usr_wg_TblDayNorm
            ].
        %%
        %% dynamic state
        :- [param_list].
        %%
        
        %% flag
        :- assertz(debug_mode).
        %%
        
        % ! при использовании в ТП Гедымин
        % ! для begin & end debug mode section
        % ! убрать символ процента из первой позиции
        */ %%% end debug mode section
        
        :- ps32k_lgt(64, 128, 64).
        
        :- init_data.
        
        /* реализация */
        
        struct_vacation_sql(DocKey, DateBegin, DateEnd, PredicateName, Arity, SQL) :-
            Pairs = [pDocKey-DocKey, pDateBegin-DateBegin, pDateEnd-DateEnd],
            get_sql(wg_struct_vacation, in, Query, SQL0, Params),
            is_valid_sql(Query),
            Query = PredicateName/Arity,
            member_list(Params, Pairs),
            prepare_sql(SQL0, Params, SQL),
            Pairs1 = [pDocKey-DocKey,
                      pQuery-Query, pSQL-SQL],
            new_param_list(wg_struct_vacation, run, Pairs1).
        
        struct_sick_sql(EmplKey, FirstMoveKey, DateBegin, DateEnd, PredicateName, Arity, SQL) :-
            DateCalcFrom = DateBegin,
            date_add(DateEnd, 1, day, DateCalcTo),
            Pairs0 = [pBudget_xid-147073065, pBudget_dbid-1224850260],
            get_param_list(wg_struct_sick, in, Pairs0),
            append(Pairs0,
                        [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey,
                         pDateCalcFrom-DateCalcFrom, pDateCalcTo-DateCalcTo],
                    Pairs),
            new_param_list(wg_struct_sick, run, Pairs),
            get_sql(wg_struct_sick, in, Query, SQL0, Params),
            is_valid_sql(Query),
            Query = PredicateName/Arity,
            member_list(Params, Pairs),
            prepare_sql(SQL0, Params, SQL),
            Pairs1 = [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey,
                      pQuery-Query, pSQL-SQL],
            new_param_list(wg_struct_sick, run, Pairs1).
        
        struct_vacation_in(DateCalc, DateBegin, DateEnd, AvgWage, SliceOption) :-
            atom_date(DateCalc, date(Year, Month, _)),
            month_days(Year, Month, Days),
            atom_date(AccDate, date(Year, Month, Days)),
            once( (SliceOption = 0, FilterVcType = 0 ; true) ),
            findall( VcType-Slice,
                        ( wg_vacation_slice(VcType, Slice), VcType = FilterVcType ),
                     SliceList0 ),
            keysort(SliceList0, [Slice0|SliceList1]),
            append(SliceList1, [Slice0], SliceList),
            struct_vacation_calc(SliceList, _-0, AccDate, DateBegin, DateEnd, AvgWage),
            !.
        
        struct_sick_in(DateCalc, DateBegin, DateEnd, AvgWage, CalcType, BudgetOption) :-
            atom_date(DateCalc, date(Year, Month, _)),
            month_days(Year, Month, Days),
            atom_date(AccDate, date(Year, Month, Days)),
            Pairs = [pFirstCalcType-FirstCalcType,
                     pFirstDuration-FirstDuration, pFirstPart-FirstPart],
            get_param_list(wg_struct_sick, in, Pairs),
            date_diff(DateBegin, Duration0, DateEnd),
            Duration is Duration0 + 1,
            ( CalcType = FirstCalcType,
              SliceList0 = [FirstPart-FirstDuration]
            ;
              SliceList0 = []
            ),
            append(SliceList0, [1.0-Duration], SliceList),
            struct_sick_calc(SliceList, _-0, AccDate, DateBegin, DateEnd, AvgWage, BudgetOption),
            !.
        
        struct_vacation_calc([Slice|SliceList], _-Slice0, AccDate, DateBegin, DateEnd, AvgWage) :-
            Slice0 =:= 0,
            !,
            struct_vacation_calc(SliceList, Slice, AccDate, DateBegin, DateEnd, AvgWage).
        struct_vacation_calc(_, _, _, '', '', _) :-
            !.
        struct_vacation_calc([], _-Slice, _, _, _, _) :-
            Slice =:= 0,
            !.
        struct_vacation_calc(SliceList, VcType-Slice, AccDate, DateBegin, DateEnd, AvgWage) :-
            make_period(DateBegin, DateEnd, DateBegin1, DateEnd1, DateBegin2, DateEnd2, Slice, Slice2),
            atom_date(DateBegin1, date(Y, M, _)),
            atom_date(IncludeDate, date(Y, M, 1)),
            sum_vacation_days(DateBegin1, DateEnd1, 1, Duration),
            Summa is Duration * AvgWage,
            OutPairs = [
                        pAccDate-AccDate, pIncludeDate-IncludeDate,
                        pDuration-Duration, pSumma-Summa,
                        pDateBegin-DateBegin1, pDateEnd-DateEnd1,
                        pVcType-VcType
                        ],
            new_param_list(struct_vacation, out, OutPairs),
            !,
            struct_vacation_calc(SliceList, VcType-Slice2, AccDate, DateBegin2, DateEnd2, AvgWage).
        
        struct_sick_calc([Slice|SliceList], _-Slice0, AccDate, DateBegin, DateEnd, AvgWage, BudgetOption) :-
            Slice0 =:= 0,
            !,
            struct_sick_calc(SliceList, Slice, AccDate, DateBegin, DateEnd, AvgWage, BudgetOption).
        struct_sick_calc(_, _, _, '', '', _, _) :-
            !.
        struct_sick_calc([], _-Slice, _, _, _, _, _) :-
            Slice =:= 0,
            !.
        struct_sick_calc(SliceList, SickPart-Slice, AccDate, DateBegin, DateEnd, AvgWage0, BudgetOption) :-
            make_period(DateBegin, DateEnd, DateBegin1, DateEnd1, DateBegin2, DateEnd2, Slice, Slice2),
            atom_date(DateBegin1, date(Y, M, _)),
            atom_date(IncludeDate, date(Y, M, 1)),
            Percent is SickPart * 100,
            sum_sick_days(DateBegin1, DateEnd1, 1, DOI, 0, HOI),
            ( BudgetOption = 1,
              get_avg_wage_budget(wg_struct_sick, in, Y, M, AvgWage)
            ;
              AvgWage = AvgWage0
            ),
            Summa is DOI * AvgWage,
            OutPairs = [
                        pAccDate-AccDate, pIncludeDate-IncludeDate,
                        pPercent-Percent, pDOI-DOI, pHOI-HOI, pSumma-Summa,
                        pDateBegin-DateBegin1, pDateEnd-DateEnd1
                        ],
            new_param_list(struct_sick, out, OutPairs),
            !,
            struct_sick_calc(SliceList, SickPart-Slice2, AccDate, DateBegin2, DateEnd2, AvgWage0, BudgetOption).
        
        make_period(DateBegin, DateEnd, DateBegin, DateEnd1, DateBegin2, DateEnd2, Slice, Slice2) :-
            head_period(DateBegin, DateEnd, DateEnd1, Slice, Slice2),
            teil_period(DateEnd, DateEnd1, DateBegin2, DateEnd2),
            !.
        
        head_period(DateBegin, DateEnd, DateBegin, Slice, Slice2) :-
           date_add(DateBegin, 1, day, DateBegin1),
           atom_date(DateBegin, date(Y, M, _)),
           ( \+ atom_date(DateBegin1, date(Y, M, _)), next_slice(DateBegin, Slice, Slice2)
           ; DateBegin1 @> DateEnd, Slice2 = 0
           ; Slice =:= 1, next_slice(DateBegin, Slice, Slice2)
           ),
           !.
        head_period(DateBegin, DateEnd, DateEnd1, Slice0, Slice2) :-
           date_add(DateBegin, 1, day, DateBegin1),
           next_slice(DateBegin, Slice0, Slice1),
           !,
           head_period(DateBegin1, DateEnd, DateEnd1, Slice1, Slice2).
        
        next_slice(DateBegin, Slice, Slice) :-
           wg_holiday(DateBegin),
           !.
        next_slice(_, Slice, Slice2) :-
           Slice2 is Slice - 1,
           !.
        
        teil_period(DateEnd, DateEnd, '', '') :-
            !.
        teil_period(DateEnd, DateEnd1, DateBegin2, DateEnd) :-
            date_add(DateEnd1, 1, day, DateBegin2),
            !.
        
        sum_vacation_days(DateBegin, DateBegin, Duration0, Duration1) :-
            ( wg_holiday(DateBegin), Duration1 is Duration0 - 1
            ; Duration1 = Duration0 ),
            !.
        sum_vacation_days(DateBegin, DateEnd, Duration0, Duration) :-
            date_add(DateBegin, 1, day, DateBegin1),
            ( wg_holiday(DateBegin), Duration1 = Duration0
            ; Duration1 is Duration0 + 1 ),
            !,
            sum_vacation_days(DateBegin1, DateEnd, Duration1, Duration).
        
        sum_sick_days(DateBegin, DateBegin, DOI, DOI, HOI0, HOI) :-
            get_sick_how(DateBegin, HOW),
            HOI is HOI0 + HOW,
            !.
        sum_sick_days(DateBegin, DateEnd, DOI0, DOI, HOI0, HOI) :-
            date_add(DateBegin, 1, day, DateBegin1),
            DOI1 is DOI0 + 1,
            get_sick_how(DateBegin, HOW),
            HOI1 is HOI0 + HOW,
            !,
            sum_sick_days(DateBegin1, DateEnd, DOI1, DOI, HOI1, HOI).
        
        
        get_sick_how(TheDay, WDuration) :-
            Pairs =  [pEmplKey-EmplKey, pFirstMoveKey-FirstMoveKey],
            get_param_list(wg_struct_sick, run, Pairs),
            get_data(wg_struct_sick, in, usr_wg_TblDayNorm, [
                        fEmplKey-EmplKey, fFirstMoveKey-FirstMoveKey,
                        fTheDay-TheDay, fWDuration-WDuration ]),
            !.
        get_sick_how(_, 0) :-
            !.
        
        struct_vacation_out(AccDate, IncludeDate, Duration, Summa, DateBegin, DateEnd, VcType) :-
            OutPairs = [
                        pAccDate-AccDate, pIncludeDate-IncludeDate,
                        pDuration-Duration, pSumma-Summa,
                        pDateBegin-DateBegin, pDateEnd-DateEnd,
                        pVcType-VcType
                        ],
            get_param_list(struct_vacation, out, OutPairs).
        
        struct_sick_out(AccDate, IncludeDate, Percent, DOI, HOI, Summa, DateBegin, DateEnd) :-
            OutPairs = [
                        pAccDate-AccDate, pIncludeDate-IncludeDate,
                        pPercent-Percent, pDOI-DOI, pHOI-HOI, pSumma-Summa,
                        pDateBegin-DateBegin, pDateEnd-DateEnd
                        ],
            get_param_list(struct_sick, out, OutPairs).
        
        % взять среднедневной БПМ на текущий месяц
        get_avg_wage_budget(Scope, Type, Y, M, AvgWageBudget) :-
            % первая дата месяца
            atom_date(FirstMonthDate, date(Y, M, 1)),
            % взять БПМ
            findall( Budget0,
                          % взять данные по БПМ
                        ( get_data(Scope, Type, gd_const_budget, 2, [
                                    fConstDate-ConstDate, fBudget-Budget0]),
                          % где дата константы меньше первой даты месяца
                          ConstDate @< FirstMonthDate
                        ),
            % в список БПМ
            BudgetList),
            % проверить список БПМ
            \+ BudgetList = [],
            % последние данные по БПМ за месяц
            last(BudgetList, MonthBudget),
            % календарных дней в месяце
            month_days(Y, M, MonthDays),
            % среднедневной БПМ
            AvgWageBudget is round(MonthBudget / MonthDays),
            !.
        get_avg_wage_budget(_, _, _, _, 0) :-
            !.
        
        /**/
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-21T12:44:13+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "151189469_18175251 lib"
          - 
            ADDFUNCTIONKEY: "151189468_18175251 params"
          - 
            ADDFUNCTIONKEY: "156300302_119200397 twg_struct_sql"
          - 
            ADDFUNCTIONKEY: "528604221_99701464 twg_struct_in_params"
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 151158415_5956463
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "CONST"
      LANGUAGE: "VBScript"
      NAME: "pl_Const"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        'Константы и переменные Prolog
        
        Public Const scrPrologModuleName = "PROLOG"
        
        'TERM-TYPE CONSTANTS
        Public Const PL_VARIABLE = 1
        Public Const PL_ATOM = 2
        Public Const PL_INTEGER = 3
        Public Const PL_FLOAT = 4
        Public Const PL_STRING = 5
        Public Const PL_TERM = 6
        '
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2013-10-11T12:23:43+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147488905_336327731
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_actAvgGenerateOnExecute"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_AvgSalaryStrGenerate_pl
        option explicit
        sub usrg_actAvgGenerateOnExecute(ByVal Sender)
          'Сбрасываем кэш для Переменных
          set wg_Variable_ = Nothing
        
          Dim Ret
          Ret = wg_AvgSalaryStrGenerate_pl(Sender.OwnerForm, 0)
        
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_ACTAVGGENERATEONEXECUTE
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONEXECUTE"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-01-10T16:18:57+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "151163587_5956463 wg_AvgSalaryStrGenerate_pl"
  - 
    Properties: 
      Class: "TgdcMacrosGroup"
      RUID: 147021904_119619099
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147488961_336327731
    Fields: 
      HASCHILDREN: 1
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTPARENT: ~
      CLASSNAME: ""
      SUBTYPE: ""
      PARENT: ~
      NAME: "Локальные макросы"
      ISGLOBAL: 0
      DESCRIPTION: ~
      EDITIONDATE: 2004-05-05T14:36:35+03:00
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147022538_119619099
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147488961_336327731
    Fields: 
      NAME: "usrg_gdcAvgSalaryStr"
      DESCRIPTION: ~
      PARENT: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTTYPE: 0
      MACROSGROUPKEY: ~
      REPORTGROUPKEY: ~
      CLASSNAME: ""
      OBJECTNAME: "usrg_gdcAvgSalaryStr"
      SUBTYPE: ""
      EDITIONDATE: 2004-05-06T14:29:07+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147488963_336327731
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147488961_336327731
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_gdcAvgSalaryStrAfterDelete"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_GetAvgSalarySum
        '#include wg_EnableFieldChange
        option explicit
        sub usrg_gdcAvgSalaryStrAfterDelete(ByVal DataSet)
          exit sub ' отключаем - работает пролог-скрипт
        ' пересчитываем сумму среднего заработка
        
        '  if not DataSet.OwnerForm.gdcObject.Variables("AvgAutoFill") then
            if wg_EnabledFieldChange(DataSet, "AVGSALARYCALC") then
              wg_GetAvgSalarySum(DataSet)
          '    wg_AvgSalaryCalc(DataSet)
            end if
        '  end if
        
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_GDCAVGSALARYSTRAFTERDELETE
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "AFTERDELETE"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QHAAAAREFUQVNFVAcAAABEQVRBU0VUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZO
        U1RGTFBS
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-03T15:41:03+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147368587_274788016 wg_GetAvgSalarySum"
          - 
            ADDFUNCTIONKEY: "147016040_119619099 wg_EnableFieldChange"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147488961_336327731
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_gdcAvgSalaryStr"
      PARENTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTKEY: "147022538_119619099 gdc_dlgUserComplexDocument147020774_119619099\\usrg_gdcAvgSalaryStr"
      EVENTNAME: "AFTERDELETE"
      FUNCTIONKEY: "147488963_336327731 usrg_gdcAvgSalaryStrAfterDelete"
      DISABLE: 1
      EDITIONDATE: 2014-03-03T15:41:03+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147022541_119619099
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147022539_119619099
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_gdcAvgSalaryStrAfterPost"
      COMMENT: ~
      SCRIPT: | 
        '# include wg_AvgSalaryCalc
        '#include wg_GetAvgSalarySum
        '#include wg_EnableFieldChange
        option explicit
        sub usrg_gdcAvgSalaryStrAfterPost(ByVal DataSet)
          exit sub ' отключаем - работает пролог-скрипт
        ' пересчитываем сумму среднего заработка
        
          if wg_EnabledFieldChange(DataSet, "AVGSALARYCALC") then
            wg_GetAvgSalarySum(DataSet)
        '    wg_AvgSalaryCalc(DataSet)
          end if
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_GDCAVGSALARYSTRAFTERPOST
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "AFTERPOST"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QHAAAAREFUQVNFVAcAAABEQVRBU0VUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZO
        U1RGTFBS
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-03T15:41:03+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147368587_274788016 wg_GetAvgSalarySum"
          - 
            ADDFUNCTIONKEY: "147016040_119619099 wg_EnableFieldChange"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147022539_119619099
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_gdcAvgSalaryStr"
      PARENTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTKEY: "147022538_119619099 gdc_dlgUserComplexDocument147020774_119619099\\usrg_gdcAvgSalaryStr"
      EVENTNAME: "AFTERPOST"
      FUNCTIONKEY: "147022541_119619099 usrg_gdcAvgSalaryStrAfterPost"
      DISABLE: 1
      EDITIONDATE: 2014-03-03T15:41:03+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147107645_584838465
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147107643_584838465
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "gdc_dlgUserComplexDocument147020774_119619099OnLoadSettingsAfterCreate"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_WageSettings
        '#include wg_AvgSalary_CoefOption
        
        sub gdc_dlgUserComplexDocument147020774_119619099OnLoadSettingsAfterCreate(ByVal Sender)
        '*** Данный код необходим для вызова встроенного обработчика ***
        '*** В случае его удаления возможно нарушение работы системы ***
          call   Inherited(Sender, "OnLoadSettingsAfterCreate", Array(Sender))
        '*** конец кода поддержки встроенного обработчика            ***
          set S = wg_WageSettings
          'оключено
          'set chboxCoefInflation = Sender.GetComponent("usrg_chboxCoefInflation")
          'chboxCoefInflation.Checked = S.Wage.CoefInflation
          'сейчас используется
          wg_AvgSalary_CoefOption(Sender)
        
          'Устарело
          if not Sender.VariableExists("Coeff") then
           Sender.AddVariableItem("Coeff")
          end if
          Sender.Variables("Coeff") = S.Wage.CoefInflation
          'Новые
          set rbSalaryInf = Sender.GetComponent("usrg_rbSalaryInf")
          set rbRateInf = Sender.GetComponent("usrg_rbRateInf")
          set rbPersCoeffInf = Sender.GetComponent("usrg_rbPersCoeffInf")
          select case S.Inflation.InflType
            case 0
              Sender.GetComponent("usrg_rbSalaryInf").Checked = True
            case 1
              Sender.GetComponent("usrg_rbRateInf").Checked = True
            case 2
              Sender.GetComponent("usrg_rbPersCoeffInf").Checked = True
          end select
          if not Sender.VariableExists("NewCoeff") then
            Sender.AddVariableItem("NewCoeff")
          end if
          Sender.Variables("NewCoeff") = S.Inflation.InflType
        end sub
        
      DISPLAYSCRIPT: | 
        GDC_DLGUSERCOMPLEXDOCUMENT147020774_119619099ONLOADSETTINGSAFTERCREATE
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONLOADSETTINGSAFTERCREATE"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-12T16:38:35+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147019760_119619099 wg_WageSettings"
          - 
            ADDFUNCTIONKEY: "156299481_119200397 wg_AvgSalary_CoefOption"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147107643_584838465
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      PARENTNAME: ~
      OBJECTKEY: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      EVENTNAME: "ONLOADSETTINGSAFTERCREATE"
      FUNCTIONKEY: "147107645_584838465 gdc_dlgUserComplexDocument147020774_119619099OnLoadSettingsAfterCreate"
      DISABLE: ~
      EDITIONDATE: 2014-03-12T16:38:37+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147352483_274788016
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_actGenerateOnExecute"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#wg_LastDayInMonth
        '#include wg_AvgSalaryDetailGenerate_pl
        
        sub usrg_actGenerateOnExecute(ByVal Sender)
          'Сбрасываем кэш для Переменных
          set wg_Variable_ = Nothing
        
          Dim Ret
          Ret = wg_AvgSalaryDetailGenerate_pl(Sender.OwnerForm)
        
          'Sender.OwnerForm.GetComponent("ibgrDetail").SetFocus
          'set wg_Structure = Sender.OwnerForm.Objects("Structure")
          'call wg_Structure.CreateHolidayStructure(Sender.OwnerForm)
        
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_ACTGENERATEONEXECUTE
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONEXECUTE"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-13T18:35:55+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "156300136_119200397 wg_AvgSalaryDetailGenerate_pl"
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147107754_584838465
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147107903_584838465
    Fields: 
      NAME: "usrg_chboxCoefInflation"
      DESCRIPTION: ~
      PARENT: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTTYPE: 0
      MACROSGROUPKEY: ~
      REPORTGROUPKEY: ~
      CLASSNAME: ""
      OBJECTNAME: "usrg_chboxCoefInflation"
      SUBTYPE: ""
      EDITIONDATE: 2006-06-15T10:53:41+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147107905_584838465
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147107903_584838465
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_chboxCoefInflationOnClick"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_WageSettings
        sub usrg_chboxCoefInflationOnClick(ByVal Sender)
          Exit Sub 'работает OnLoadSettingsAfterCreate
          set S = wg_WageSettings
          set chboxCoefInflation = Sender
          S.Wage.CoefInflation = chboxCoefInflation.Checked
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_CHBOXCOEFINFLATIONONCLICK
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONCLICK"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-03T15:26:40+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147019760_119619099 wg_WageSettings"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147107903_584838465
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_chboxCoefInflation"
      PARENTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTKEY: "147107754_584838465 gdc_dlgUserComplexDocument147020774_119619099\\usrg_chboxCoefInflation"
      EVENTNAME: "ONCLICK"
      FUNCTIONKEY: "147107905_584838465 usrg_chboxCoefInflationOnClick"
      DISABLE: 1
      EDITIONDATE: 2014-03-03T15:26:41+03:00
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147036259_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147036260_781744915
    Fields: 
      NAME: "usrg_rbPersCoeffInf"
      DESCRIPTION: ~
      PARENT: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTTYPE: 0
      MACROSGROUPKEY: ~
      REPORTGROUPKEY: ~
      CLASSNAME: ""
      OBJECTNAME: "usrg_rbPersCoeffInf"
      SUBTYPE: ""
      EDITIONDATE: 2007-04-02T14:55:25+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147036262_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147036260_781744915
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_rbPersCoeffInfOnClick"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_WageSettings
        option explicit
        sub usrg_rbPersCoeffInfOnClick(ByVal Sender)
          Exit Sub 'работает OnLoadSettingsAfterCreate
          dim S
          set S = wg_WageSettings
          if Sender.Checked then
            S.Inflation.InflType = 2
          end if
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_RBPERSCOEFFINFONCLICK
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONCLICK"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-03T15:06:09+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147019760_119619099 wg_WageSettings"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147036260_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_rbPersCoeffInf"
      PARENTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTKEY: "147036259_781744915 gdc_dlgUserComplexDocument147020774_119619099\\usrg_rbPersCoeffInf"
      EVENTNAME: "ONCLICK"
      FUNCTIONKEY: "147036262_781744915 usrg_rbPersCoeffInfOnClick"
      DISABLE: 1
      EDITIONDATE: 2014-03-03T15:06:09+03:00
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147036255_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147036256_781744915
    Fields: 
      NAME: "usrg_rbRateInf"
      DESCRIPTION: ~
      PARENT: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTTYPE: 0
      MACROSGROUPKEY: ~
      REPORTGROUPKEY: ~
      CLASSNAME: ""
      OBJECTNAME: "usrg_rbRateInf"
      SUBTYPE: ""
      EDITIONDATE: 2007-04-02T14:55:17+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147036258_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147036256_781744915
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_rbRateInfOnClick"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_WageSettings
        option explicit
        sub usrg_rbRateInfOnClick(ByVal Sender)
          Exit Sub 'работает OnLoadSettingsAfterCreate
          dim S
          set S = wg_WageSettings
          if Sender.Checked then
            S.Inflation.InflType = 1
          end if
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_RBRATEINFONCLICK
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONCLICK"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-03T15:26:35+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147019760_119619099 wg_WageSettings"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147036256_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_rbRateInf"
      PARENTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTKEY: "147036255_781744915 gdc_dlgUserComplexDocument147020774_119619099\\usrg_rbRateInf"
      EVENTNAME: "ONCLICK"
      FUNCTIONKEY: "147036258_781744915 usrg_rbRateInfOnClick"
      DISABLE: 1
      EDITIONDATE: 2014-03-03T15:26:35+03:00
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147036251_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147036252_781744915
    Fields: 
      NAME: "usrg_rbSalaryInf"
      DESCRIPTION: ~
      PARENT: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTTYPE: 0
      MACROSGROUPKEY: ~
      REPORTGROUPKEY: ~
      CLASSNAME: ""
      OBJECTNAME: "usrg_rbSalaryInf"
      SUBTYPE: ""
      EDITIONDATE: 2007-04-02T14:55:00+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147036254_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147036252_781744915
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_rbSalaryInfOnClick"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_WageSettings
        option explicit
        sub usrg_rbSalaryInfOnClick(ByVal Sender)
          Exit Sub 'работает OnLoadSettingsAfterCreate
          dim S
          set S = wg_WageSettings
          if Sender.Checked then
            S.Inflation.InflType = 0
          end if
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_RBSALARYINFONCLICK
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "ONCLICK"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147021903_119619099 gdc_dlgUserComplexDocument147020774_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-03T15:26:29+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147019760_119619099 wg_WageSettings"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147036252_781744915
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_rbSalaryInf"
      PARENTNAME: "gdc_dlgUserComplexDocument147020774_119619099"
      OBJECTKEY: "147036251_781744915 gdc_dlgUserComplexDocument147020774_119619099\\usrg_rbSalaryInf"
      EVENTNAME: "ONCLICK"
      FUNCTIONKEY: "147036254_781744915 usrg_rbSalaryInfOnClick"
      DISABLE: 1
      EDITIONDATE: 2014-03-03T15:26:29+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 520236113_2108071301
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 520236114_2108071301
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "UNKNOWN"
      LANGUAGE: "VBScript"
      NAME: "wg_AvgSalaryStrGenerate_Sick_pl"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#include pl_GetScriptIDByName
        '#include wg_GetConstByIDAndDate
        
        Function wg_AvgSalaryStrGenerate_Sick_pl(ByRef Sender)
        '
          Dim T, T1, T2
          
          Dim Creator, gdcObject, gdcSalary
          '
          Dim PL, Ret, Pred, Tv, Append
          Dim PredFile
          'avg_wage_sick
          Dim P_main, Tv_main, Q_main
          'avg_wage_sick_in
          Dim P_in, Tv_in, Q_in
          Dim EmplKey, FirstMoveKey, DateCalc, IsAvgWageDoc
          'avg_wage_run, avg_wage_sql
          Dim P_run, Tv_run, Q_run, P_sql, Tv_sql, Q_sql, P_kb
          Dim DateCalcFrom, DateCalcTo
          Dim PredicateName, Arity, SQL
          '
          'avg_wage_out, avg_wage_det
          Dim P_out, Tv_out, Q_out, P_det, Tv_det, Q_det
          Dim AvgWage, AvgWageRule
          Dim Period, PeriodRule, MonthDays, ExclDays, CalcDays, IsFullMonth, Wage
          Dim TabDays, TabHoures, NormDays, NormHoures
        
          T1 = Timer
          wg_AvgSalaryStrGenerate_Sick_pl = False
          Set Creator = New TCreator
        
          Sender.GetComponent("actApply").Execute
        
          Set gdcObject = Sender.gdcObject
          '
          EmplKey = gdcObject.FieldByName("usr$emplkey").AsInteger
          FirstMoveKey = gdcObject.FieldByName("usr$firstmovekey").AsInteger
          DateCalc = gdcObject.FieldByName("usr$from").AsDateTime
          IsAvgWageDoc = gdcObject.FieldByName("USR$REFERENCE").AsInteger
        
          'init
          Set PL = Creator.GetObject(nil, "TgsPLClient", "")
          Ret = PL.Initialise("")
          If Not Ret Then
            Exit Function
          End If
          'debug
          PL.Debug = True
          'load
          Ret = PL.LoadScript(pl_GetScriptIDByName("twg_avg_wage"))
          If Not Ret Then
            Exit Function
          End If
        
          Set gdcSalary = Sender.GetComponent("usrg_gdcAvgSalaryStr")
          '
          gdcSalary.First
          While Not gdcSalary.EOF
            gdcSalary.Delete
          Wend
          '
          gdcObject.FieldByName("USR$AVGSUMMA").Clear
          gdcObject.FieldByName("USR$THIRDMETHOD").AsInteger = 0
          gdcObject.FieldByName("USR$CALCBYBUDGET").AsInteger = 0
          '
          Sender.Repaint
        
          'avg_wage_sick_in(EmplKey, FirstMoveKey, DateCalc, IsAvgWageDoc)
          P_in = "avg_wage_sick_in"
          Set Tv_in = Creator.GetObject(4, "TgsPLTermv", "")
          Set Q_in = Creator.GetObject(nil, "TgsPLQuery", "")
          Tv_in.PutInteger 0, EmplKey
          Tv_in.PutInteger 1, FirstMoveKey
          Tv_in.PutDate 2, DateCalc
          Tv_in.PutInteger 3, IsAvgWageDoc
          '
          Q_in.PredicateName = P_in
          Q_in.Termv = Tv_in
          '
          Q_in.OpenQuery
          If Q_in.EOF Then
            Exit Function
          End If
          Q_in.Close
        
          'avg_wage_sick(_) - prepare data
          P_main = "avg_wage_sick"
          Set Tv_main = Creator.GetObject(1, "TgsPLTermv", "")
          Set Q_main = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_main.PredicateName = P_main
          Q_main.Termv = Tv_main
          '
          Q_main.OpenQuery
          If Q_main.EOF Then
            Exit Function
          End If
          Q_main.Close
          
          'avg_wage_sick_run(EmplKey, FirstMoveKey, DateCalcFrom, DateCalcTo)
          P_run = "avg_wage_sick_run"
          Set Tv_run = Creator.GetObject(4, "TgsPLTermv", "")
          Set Q_run = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_run.PredicateName = P_run
          Q_run.Termv = Tv_run
          'avg_wage_sick_sql(EmplKey, FirstMoveKey, PredicateName, Arity, SQL)
          P_sql = "avg_wage_sick_sql"
          P_kb = "avg_wage_sick_kb"
          Set Tv_sql = Creator.GetObject(5, "TgsPLTermv", "")
          Set Q_sql = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_sql.PredicateName = P_sql
          Q_sql.Termv = Tv_sql
          '
          Q_run.OpenQuery
          If Q_run.EOF Then
            Exit Function
          End If
          '
          Append = False
          '
          Do Until Q_run.EOF
            EmplKey = Tv_run.ReadInteger(0)
            FirstMoveKey = Tv_run.ReadInteger(1)
            DateCalcFrom = Tv_run.ReadDate(2)
            DateCalcTo = Tv_run.ReadDate(3)
            '
            Tv_sql.Reset
            Tv_sql.PutInteger 0, EmplKey
            Tv_sql.PutInteger 1, FirstMoveKey
            Q_sql.OpenQuery
            '
            Do Until Q_sql.EOF
              PredicateName = Tv_sql.ReadAtom(2)
              Arity = Tv_sql.ReadInteger(3)
              SQL = Tv_sql.ReadString(4)
              '
              Ret =  PL.MakePredicatesOfSQLSelect _
                        (SQL, _
                        gdcBaseManager.ReadTransaction, _
                        PredicateName, PredicateName, Append)
              If Ret >= 0 Then
                 Ret = PL.Call(P_kb, Tv_sql)
              End If
              '
              Q_sql.NextSolution
            Loop
            Q_sql.Close
            '
            Append = True
            '
            Q_run.NextSolution
          Loop
          Q_run.Close
        
          'save param_list
          If PL.Debug Then
            Pred = "param_list"
            PredFile = "param_list"
            Set Tv = Creator.GetObject(3, "TgsPLTermv", "")
            PL.SavePredicatesToFile Pred, Tv, PredFile
          End If
        
          'avg_wage_sick(Variant) - calc result
          Q_main.OpenQuery
          If Q_main.EOF Then
            Exit Function
          End If
          Q_main.Close
        
          'avg_wage_sick_out(EmplKey, FirstMoveKey, AvgWage, AvgWageVariant)
          P_out = "avg_wage_sick_out"
          Set Tv_out = Creator.GetObject(4, "TgsPLTermv", "")
          Set Q_out = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_out.PredicateName = P_out
          Q_out.Termv = Tv_out
          'avg_wage_sick_det(EmplKey, FirstMoveKey,
          '                  Period, Rule,
          '                  MonthDays, ExclDays, CalcDays, IsFullMonth,
          '                  Wage,
          '                  TabDays, NormDays, TabHoures, NormHoures) :-
          P_det = "avg_wage_sick_det"
          Set Tv_det = Creator.GetObject(13, "TgsPLTermv", "")
          Set Q_det = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_det.PredicateName = P_det
          Q_det.Termv = Tv_det
          '
          Q_out.OpenQuery
          If Q_out.EOF Then
            Exit Function
          End If
          '
          Do Until Q_out.EOF
            EmplKey = Tv_out.ReadInteger(0)
            FirstMoveKey = Tv_out.ReadInteger(1)
            AvgWage = Tv_out.ReadFloat(2)
            AvgWageRule = Tv_out.ReadAtom(3)
            '
            Tv_det.Reset
            Tv_det.PutInteger 0, EmplKey
            Tv_det.PutInteger 1, FirstMoveKey
            Q_det.OpenQuery
            '
            Do Until Q_det.EOF
              Period = Tv_det.ReadDate(2)
              PeriodRule = Tv_det.ReadAtom(3)
              '
              Select Case AvgWageRule
                Case "by_calc_days", "by_calc_days_doc"
                  Select Case PeriodRule
                    Case "by_cal_flex"
                      PeriodRule = "по табелю мастера"
                    Case "by_cal"
                      PeriodRule = "по табелю"
                    Case "by_orders"
                      PeriodRule = "по приказам"
                    Case Else
                      PeriodRule = ""
                  End Select
                Case "by_budget"
                  PeriodRule = "от БПМ"
                Case "by_rate"
                  PeriodRule = "от ставки"
                Case "by_not_full"
                  PeriodRule = "по не полным месяцам"
                Case Else
                  PeriodRule = ""
              End Select
              '
              MonthDays = Tv_det.ReadInteger(4)
              ExclDays= Tv_det.ReadInteger(5)
              CalcDays = Tv_det.ReadInteger(6)
              IsFullMonth = Tv_det.ReadInteger(7)
              Wage = Tv_det.ReadFloat(8)
              TabDays = Tv_det.ReadFloat(9)
              NormDays = Tv_det.ReadFloat(10)
              TabHoures = Tv_det.ReadFloat(11)
              NormHoures = Tv_det.ReadFloat(12)
              '
              gdcSalary.Append
              gdcSalary.FieldByName("USR$ISFULL").AsVariant = IsFullMonth
              gdcSalary.FieldByName("USR$DATE").AsVariant = Period
              gdcSalary.FieldByName("USR$CALCDAYS").AsVariant = CalcDays
              gdcSalary.FieldByName("USR$SALARY").AsVariant = Wage
              gdcSalary.FieldByName("USR$DOW").AsVariant = TabDays
              gdcSalary.FieldByName("USR$SCHEDULERDOW").AsVariant = NormDays
              gdcSalary.FieldByName("USR$HOW").AsVariant = TabHoures
              gdcSalary.FieldByName("USR$SCHEDULERHOW").AsVariant = NormHoures
              gdcSalary.FieldByName("USR$DESCRIPTION").AsVariant = PeriodRule
              gdcSalary.Post
              '
              Q_det.NextSolution
            Loop
            Q_det.Close
            '
            Q_out.NextSolution
          Loop
          Q_out.Close
          '
        
          gdcSalary.First
          '
          If AvgWage > 0 then
            gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency = AvgWage
          End If
          '
          Select Case AvgWageRule
            Case "by_budget"
              gdcObject.FieldByName("USR$CALCBYBUDGET").AsInteger = 1
            Case "by_rate"
              gdcObject.FieldByName("USR$THIRDMETHOD").AsInteger = 1
          End select
          '
          gdcObject.Post
          '
        
          wg_AvgSalaryStrGenerate_Sick_pl = True
          
          T2 = Timer
          T = T2 - T1
        '
        End function
        
      DISPLAYSCRIPT: | 
        WG_AVGSALARYSTRGENERATE_SICK_PL
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-14T10:43:15+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "151158419_5956463 pl_GetScriptIDByName"
          - 
            ADDFUNCTIONKEY: "147043669_974374174 wg_GetConstByIDAndDate"
  - 
    Properties: 
      Class: "TgdcMacrosGroup"
      RUID: 147022905_119619099
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 520236114_2108071301
    Fields: 
      HASCHILDREN: 1
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      OBJECTPARENT: ~
      CLASSNAME: ""
      SUBTYPE: ""
      PARENT: ~
      NAME: "Локальные макросы"
      ISGLOBAL: 0
      DESCRIPTION: ~
      EDITIONDATE: 2004-05-07T12:05:09+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 520236116_2108071301
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 520236114_2108071301
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      MODULE: "MACROS"
      LANGUAGE: "VBScript"
      NAME: "Macros_AvgSalaryStrGenerate_Sick"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#include wg_AvgSalaryStrGenerate_Sick_pl
        
        Sub Macros_AvgSalaryStrGenerate_Sick(OwnerForm)
          Dim Ret
          Ret = wg_AvgSalaryStrGenerate_Sick_pl(OwnerForm)
        End Sub
        
      DISPLAYSCRIPT: | 
        MACROS_AVGSALARYSTRGENERATE_SICK
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147022904_119619099 gdc_dlgUserComplexDocument147022845_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QJAAAAT1dORVJGT1JNCQAAAE9XTkVSRk9STQAAAAAAAAAAAAAAAAsAAAAAAAAAAAAA
        AABGTlNURkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-05T11:58:29+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "520236113_2108071301 wg_AvgSalaryStrGenerate_Sick_pl"
  - 
    Properties: 
      Class: "TgdcMacros"
      RUID: 520236114_2108071301
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      MACROSGROUPKEY: "147022905_119619099 Локальные макросы"
      FUNCTIONKEY: "520236116_2108071301 Macros_AvgSalaryStrGenerate_Sick"
      NAME: "Расчет структуры ср. заработка"
      SERVERKEY: ~
      ISLOCALEXECUTE: 0
      ISREBUILD: 0
      EXECUTEDATE: ~
      SHORTCUT: 0
      EDITIONDATE: 2014-03-05T11:58:29+03:00
      DISPLAYINMENU: 1
      RUNONLOGIN: 0
  - 
    Properties: 
      Class: "TgdcDelphiObject"
      RUID: 147368583_274788016
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147489065_336327731
    Fields: 
      NAME: "usrg_gdcAvgSalaryStr"
      DESCRIPTION: ~
      PARENT: "147022904_119619099 gdc_dlgUserComplexDocument147022845_119619099"
      OBJECTTYPE: 0
      MACROSGROUPKEY: ~
      REPORTGROUPKEY: ~
      CLASSNAME: ""
      OBJECTNAME: "usrg_gdcAvgSalaryStr"
      SUBTYPE: ""
      EDITIONDATE: 2005-01-26T12:28:17+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147489067_336327731
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147489065_336327731
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_gdcAvgSalaryStrAfterDelete"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_GetAvgSalarySum
        '#include wg_EnableFieldChange
        '#include wg_SetSilkAvgSum
        option explicit
        sub usrg_gdcAvgSalaryStrAfterDelete(ByVal DataSet)
          Exit Sub 'отключено
        ' пересчитываем сумму среднего заработка
          wg_SetSilkAvgSum(DataSet)
        '  if wg_EnabledFieldChange(DataSet, "AVGSALARYCALC") then
        '    wg_GetAvgSalarySum(DataSet)
        '  end if
        
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_GDCAVGSALARYSTRAFTERDELETE
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "AFTERDELETE"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147022904_119619099 gdc_dlgUserComplexDocument147022845_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QHAAAAREFUQVNFVAcAAABEQVRBU0VUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZO
        U1RGTFBS
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-12T10:57:53+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147368587_274788016 wg_GetAvgSalarySum"
          - 
            ADDFUNCTIONKEY: "147016040_119619099 wg_EnableFieldChange"
          - 
            ADDFUNCTIONKEY: "147302770_531940465 wg_SetSilkAvgSum"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147489065_336327731
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_gdcAvgSalaryStr"
      PARENTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      OBJECTKEY: "147368583_274788016 gdc_dlgUserComplexDocument147022845_119619099\\usrg_gdcAvgSalaryStr"
      EVENTNAME: "AFTERDELETE"
      FUNCTIONKEY: "147489067_336327731 usrg_gdcAvgSalaryStrAfterDelete"
      DISABLE: 1
      EDITIONDATE: 2014-03-12T10:57:53+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147368586_274788016
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147368584_274788016
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      MODULE: "EVENTS"
      LANGUAGE: "VBScript"
      NAME: "usrg_gdcAvgSalaryStrAfterPost"
      COMMENT: ~
      SCRIPT: | 
        '#include wg_GetAvgSalarySum
        '#include wg_EnableFieldChange
        '#include wg_SetSilkAvgSum
        option explicit
        sub usrg_gdcAvgSalaryStrAfterPost(ByVal DataSet)
          Exit Sub 'отключено
        ' пересчитываем сумму среднего заработка
        '  if wg_EnabledFieldChange(DataSet, "AVGSALARYCALC") then
        '    wg_GetAvgSalarySum(DataSet)
        '  end if
          call wg_SetSilkAvgSum(DataSet)
        end sub
        
      DISPLAYSCRIPT: | 
        USRG_GDCAVGSALARYSTRAFTERPOST
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: "AFTERPOST"
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147022904_119619099 gdc_dlgUserComplexDocument147022845_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QHAAAAREFUQVNFVAcAAABEQVRBU0VUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZO
        U1RGTFBS
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-12T10:46:17+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147368587_274788016 wg_GetAvgSalarySum"
          - 
            ADDFUNCTIONKEY: "147016040_119619099 wg_EnableFieldChange"
          - 
            ADDFUNCTIONKEY: "147302770_531940465 wg_SetSilkAvgSum"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147368584_274788016
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "usrg_gdcAvgSalaryStr"
      PARENTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      OBJECTKEY: "147368583_274788016 gdc_dlgUserComplexDocument147022845_119619099\\usrg_gdcAvgSalaryStr"
      EVENTNAME: "AFTERPOST"
      FUNCTIONKEY: "147368586_274788016 usrg_gdcAvgSalaryStrAfterPost"
      DISABLE: 1
      EDITIONDATE: 2014-03-12T10:46:18+03:00
  - 
    Properties: 
      Class: "TgdcTableField"
      RUID: 156810157_126906444
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      REFRELATIONNAME: ~
      REFLISTFIELD: ~
      REFCROSSRELATION: ~
      SETLISTFIELD: ~
      SETLISTFIELDKEY: ~
      RELATIONTYPE: "T"
      STRINGLENGTH: ~
      DEFSOURCE: | 
        DEFAULT '0'
      COMPUTED_VALUE: ~
      SOURCENULLFLAG: ~
      NULLFLAG: 1
      RDB$FIELD_POSITION: 15
      FIELDNAME: "USR$CALCDAYS"
      RELATIONNAME: "USR$WG_AVGSALARYSTR"
      FIELDSOURCE: "DCURRENCY"
      CROSSTABLE: ~
      CROSSFIELD: ~
      RELATIONKEY: "147021881_119619099 Структура среднего заработка, USR$WG_AVGSALARYSTR"
      FIELDSOURCEKEY: "147000131_486813904 Сумма, DCURRENCY"
      CROSSTABLEKEY: ~
      CROSSFIELDKEY: ~
      LNAME: "Дни расчетные"
      LSHORTNAME: "Дни расчет."
      DESCRIPTION: "Число дней для раcчета"
      VISIBLE: 1
      FORMAT: ~
      ALIGNMENT: "L"
      COLWIDTH: 20
      READONLY: 0
      GDCLASSNAME: ~
      GDSUBTYPE: ~
      OBJECTS: ~
      DELETERULE: ~
      EDITIONDATE: 2014-03-10T10:18:12+03:00
  - 
    Properties: 
      Class: "TgdcTableField"
      RUID: 151269722_1763407244
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      REFRELATIONNAME: ~
      REFLISTFIELD: ~
      REFCROSSRELATION: ~
      SETLISTFIELD: ~
      SETLISTFIELDKEY: ~
      RELATIONTYPE: "T"
      STRINGLENGTH: ~
      DEFSOURCE: | 
        DEFAULT '0'
      COMPUTED_VALUE: ~
      SOURCENULLFLAG: ~
      NULLFLAG: ~
      RDB$FIELD_POSITION: 9
      FIELDNAME: "USR$FOROVERTIME"
      RELATIONNAME: "USR$WG_HOURTYPE"
      FIELDSOURCE: "DBOOLEAN"
      CROSSTABLE: ~
      CROSSFIELD: ~
      RELATIONKEY: "147015022_119619099 Тип отработанных часов, USR$WG_HOURTYPE"
      FIELDSOURCEKEY: "147000135_486813904 Логическое, DBOOLEAN"
      CROSSTABLEKEY: ~
      CROSSFIELDKEY: ~
      LNAME: "Для сверхурочных"
      LSHORTNAME: "Для сверхурочных"
      DESCRIPTION: ~
      VISIBLE: 1
      FORMAT: ~
      ALIGNMENT: "L"
      COLWIDTH: 20
      READONLY: 0
      GDCLASSNAME: ~
      GDSUBTYPE: ~
      OBJECTS: ~
      DELETERULE: ~
      EDITIONDATE: 2011-10-26T16:18:04+03:00
  - 
    Properties: 
      Class: "TgdcTableField"
      RUID: 522226219_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      REFRELATIONNAME: ~
      REFLISTFIELD: ~
      REFCROSSRELATION: ~
      SETLISTFIELD: ~
      SETLISTFIELDKEY: ~
      RELATIONTYPE: "T"
      STRINGLENGTH: ~
      DEFSOURCE: | 
        DEFAULT '0'
      COMPUTED_VALUE: ~
      SOURCENULLFLAG: ~
      NULLFLAG: ~
      RDB$FIELD_POSITION: 25
      FIELDNAME: "USR$REFERENCE"
      RELATIONNAME: "USR$WG_SICKLIST"
      FIELDSOURCE: "DBOOLEAN"
      CROSSTABLE: ~
      CROSSFIELD: ~
      RELATIONKEY: "147022846_119619099 Начисление больничных, USR$WG_SICKLIST"
      FIELDSOURCEKEY: "147000135_486813904 Логическое, DBOOLEAN"
      CROSSTABLEKEY: ~
      CROSSFIELDKEY: ~
      LNAME: "Справка"
      LSHORTNAME: "Справка"
      DESCRIPTION: ~
      VISIBLE: 1
      FORMAT: ~
      ALIGNMENT: "L"
      COLWIDTH: 20
      READONLY: 0
      GDCLASSNAME: ~
      GDSUBTYPE: ~
      OBJECTS: ~
      DELETERULE: ~
      EDITIONDATE: 2014-03-10T19:08:07+03:00
  - 
    Properties: 
      Class: "TgdcTableField"
      RUID: 509041440_63617372
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      REFRELATIONNAME: ~
      REFLISTFIELD: ~
      REFCROSSRELATION: ~
      SETLISTFIELD: ~
      SETLISTFIELDKEY: ~
      RELATIONTYPE: "T"
      STRINGLENGTH: ~
      DEFSOURCE: | 
        DEFAULT '0'
      COMPUTED_VALUE: ~
      SOURCENULLFLAG: ~
      NULLFLAG: ~
      RDB$FIELD_POSITION: 24
      FIELDNAME: "USR$THIRDMETHOD"
      RELATIONNAME: "USR$WG_SICKLIST"
      FIELDSOURCE: "DBOOLEAN"
      CROSSTABLE: ~
      CROSSFIELD: ~
      RELATIONKEY: "147022846_119619099 Начисление больничных, USR$WG_SICKLIST"
      FIELDSOURCEKEY: "147000135_486813904 Логическое, DBOOLEAN"
      CROSSTABLEKEY: ~
      CROSSFIELDKEY: ~
      LNAME: "Расчёт(неполн. мес.)"
      LSHORTNAME: "Расчёт(неполн. мес.)"
      DESCRIPTION: ~
      VISIBLE: 1
      FORMAT: ~
      ALIGNMENT: "L"
      COLWIDTH: 20
      READONLY: 0
      GDCLASSNAME: ~
      GDSUBTYPE: ~
      OBJECTS: ~
      DELETERULE: ~
      EDITIONDATE: 2013-11-22T18:24:20+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 394420819_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      PARENT: "990010_17 USER - Administrator"
      NAME: "gdc_dlgUserComplexDocument147022845_119619099(Tgdc_dlgUserComplexDocument)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2012-02-21T12:09:30+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 497125569_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      PARENT: "394420819_99701464 USER - Administrator\\gdc_dlgUserComplexDocument147022845_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "ibgrDetail(TgsIBGrid)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2013-09-12T10:36:15+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 394420820_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      PARENT: "394420819_99701464 USER - Administrator\\gdc_dlgUserComplexDocument147022845_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "pnlMaster(TPanel)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2012-02-21T12:09:30+03:00
  - 
    Properties: 
      Class: "TgdcStorageFolder"
      RUID: 489119204_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      PARENT: "394420819_99701464 USER - Administrator\\gdc_dlgUserComplexDocument147022845_119619099(Tgdc_dlgUserComplexDocument)"
      NAME: "usrg_grAvgSalaryStr(TgsIBGrid)"
      DATA_TYPE: "F"
      STR_DATA: ~
      INT_DATA: ~
      DATETIME_DATA: ~
      CURR_DATA: ~
      BLOB_DATA: ~
      EDITIONDATE: 2013-07-30T17:00:30+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 147368576_274788016
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 147368574_274788016
    Fields: 
      OBJECTNAME: "Tgdc_dlgUserComplexDocument147022845_119619099"
      MODULE: "METHOD"
      LANGUAGE: "VBScript"
      NAME: "Tgdc_dlgUserComplexDocument147022845_119619099SyncField"
      COMMENT: ~
      SCRIPT: | 
        '#include WG_GETCONSTBYIDANDDATE
        '#include WG_CALCSICLLISTCOEFF
        '#include wg_SetWageDocLookupParams
        '#include wg_MonthHour
        '#include wg_RoundSum
        '#include wg_CalcSchedulerWorkTime
        '#include wg_Total
        option explicit
        sub Tgdc_dlgUserComplexDocument147022845_119619099SyncField(Self, Field, SyncList)
        '*** Данный код необходим для вызова кода определенного в gdc-классе.***
        '*** При его удаления  возможно нарушение  правильной работы системы.***
          call Inherited(Self, "SyncField", Array(Self, Field, SyncList))
        '***               Конец кода поддержки gdc-класса.                  ***
          dim MoveCardList, TotalDateEnd, MoveCard, LineSum
          dim gdcDetailObject, gdcObject, FeeTypeKey, IBSQL
          dim LimitPercent, ByHour, ByBudget, DateFrom, AvgSalaryByRB, LastDay
          dim Creator, DT, Pregnancy, DB, DE, WorkDays, WorkHours
          dim Scheduler, ShedulerKey, wg_EmployeeMovement
          dim K
        
          set Creator = New TCreator
          set IBSQL = Creator.GetObject(nil, "TIBSQL", "")
          IBSQL.Transaction = Self.gdcObject.ReadTransaction
          IBSQL.SQL.Text = " SELECT " + _
            " USR$DATEBEGIN, USR$DATEEND " + _
            " FROM USR$WG_SICKLIST SICK " + _
            " WHERE SICK.USR$FROM = :DT " + _
            " AND SICK.USR$EMPLKEY = :emplkey "
            
          dim q
          set q = creator.GetObject(nil, "TIBSQL", "")
          q.Transaction = Self.gdcObject.ReadTransaction
        
          if Field.DataSet.Self = Self.gdcObject.Self then
            select case Field.FieldName
              case "USR$TOTALDOCKEY"
                wg_SetWageDocLookupParams(Self)
                
        
        
              case "USR$EMPLKEY"
                'Определим карточку сотрудника на конец месяца начисления
                if not Self.gdcObject.FieldByName("usr$totaldockey").IsNull then
                  Self.gdcObject.FieldByName("usr$calcbyhour").AsInteger = 0
                  set MoveCardList = wg_EmplMoveList.MoveCardList(Field.AsInteger, Null)
                  if Assigned(MoveCardList) then
                    TotalDateEnd = wg_Total.DateEnd(Self.gdcObject.FieldByName("usr$totaldockey").AsInteger)
                    set MoveCard = MoveCardList.ExistMoveCardByDate(TotalDateEnd)
                    if Assigned(MoveCard) then
                      if MoveCard.PayFormKey = gdcBaseManager.GetIDByRUIDString(wg_PayForm_Salary_RUID) and not(MoveCard.ByHour) then
                        Self.gdcObject.FieldByName("usr$calcbyhour").AsInteger = 0
                      end if
                    end if
                  end if
                end if
        
        
                wg_SetWageDocLookupParams(Self)
        
              case "USR$ILLTYPEKEY"
                q.Close
                q.SQL.Text = _
                "select it.USR$CALCTYPE as ctype " & _
                "from USR$WG_ILLTYPE it " & _
                "where it.ID = :id "
                q.ParamByName("id").AsInteger = Field.AsInteger
                q.ExecQuery
                Self.GetComponent("usrg_cbCalcType").ItemIndex = q.FieldByName("ctype").AsInteger
                Field.DataSet.FieldByName("usr$calctype").AsInteger = q.FieldByName("ctype").AsInteger
        
                  Pregnancy = (gdcBaseManager.GetIDByRUIDString(wg_SickType_Pregnancy_RUID) = Self.gdcObject.FieldByName("USR$ILLTYPEKEY").AsInteger)
                  if Pregnancy then
                    Field.DataSet.FieldByName("USR$AVGPERIOD").AsInteger = 6
                    Self.GetComponent("usrg_cbCalcType").ItemIndex = wg_SickType100
                    Field.DataSet.FieldByName("usr$calctype").AsInteger = wg_SickType100
                    Field.DataSet.FieldByName("USR$CALCBYHOUR").AsInteger = 0
                  'added 18.07.13
                  elseif Field.DataSet.FieldByName("USR$FROM").AsDateTime < CDate("11.07.2013") then
                    Field.DataSet.FieldByName("USR$AVGPERIOD").AsInteger = 2
                  elseif Field.DataSet.FieldByName("USR$FROM").AsDateTime >= CDate("11.07.2013") then
                    Field.DataSet.FieldByName("USR$AVGPERIOD").AsInteger = 6
                  'end added
                  end if
        
            'added 18.07.13
            case "USR$FROM"
              Pregnancy = (gdcBaseManager.GetIDByRUIDString(wg_SickType_Pregnancy_RUID) = Self.gdcObject.FieldByName("USR$ILLTYPEKEY").AsInteger)
              if Field.DataSet.FieldByName("USR$FROM").AsDateTime >= CDate("11.07.2013") or Pregnancy then
                Field.DataSet.FieldByName("USR$AVGPERIOD").AsInteger = 6
              else
                Field.DataSet.FieldByName("USR$AVGPERIOD").AsInteger = 2
              end if
            ' added end
                
              case "USR$AVGSUMMA"
                set gdcDetailObject = Self.gdcDetailObject
                set gdcObject = Self.gdcObject
                FeeTypeKey = gdcBaseManager.GetIDByRUIDString(wg_FeeType_SickList_RUID)
                'Декретный или нет
                Pregnancy = (gdcBaseManager.GetIDByRUIDString(wg_SickType_Pregnancy_RUID) = gdcObject.FieldByName("USR$ILLTYPEKEY").AsInteger)
                gdcDetailObject.Cancel
                gdcDetailObject.First
                if not gdcObject.FieldByName("usr$percent").IsNull then
                  LimitPercent = gdcObject.FieldByName("usr$percent").AsCurrency
                else
                  LimitPercent = 100
                end if
                ByHour = (gdcObject.FieldByName("usr$calcbyhour").AsInteger = 1)
                ByBudget = (gdcObject.FieldByName("USR$CALCBYBUDGET").AsInteger = 1)
        
                'Максимальный размер пособий, исчисленных в соответствии с настоящим Положением,
                'кроме пособий по беременности и родам, исчисленных в соответствии с пунктами 39 и 40 настоящего Положения,
                'за календарный месяц по каждому месту работы устанавливается в размере трехкратной величины
                'средней заработной платы рабочих и служащих в республике в месяце, предшествующем каждому месяцу
                'временной нетрудоспособности, отпуска по беременности и родам.
                '
                'Максимальный размер пособий за неполный месяц устанавливается в размере величины,
                'получаемой путем деления трехкратной величины средней заработной платы рабочих и служащих в
                'республике в месяце, предшествующем месяцу временной нетрудоспособности, отпуска по беременности и родам,
                'на количество рабочих дней (часов) по графику работы работника в месяце временной нетрудоспособности,
                'отпуска по беременности и родам с последующим умножением полученного результата на
                'количество рабочих дней (часов) временной нетрудоспособности, отпуска по беременности и родам, в этом месяце.
        
                while (not gdcDetailObject.EOF)
                  gdcDetailObject.Edit
                  if not ByBudget then
                    if not ByHour then
                      LineSum = _
                        gdcDetailObject.FieldByName("USR$DOI").AsCurrency * gdcDetailObject.FieldByName("USR$PERCENT").AsCurrency * _
                        Self.gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency / 100
                    else
                      LineSum = _
                        gdcDetailObject.FieldByName("USR$HOI").AsCurrency * gdcDetailObject.FieldByName("USR$PERCENT").AsCurrency * _
                        Self.gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency / 100
                    end if
                    K = wg_CalcSiclListCoeff(gdcObject.FieldByName("USR$DATEBEGIN").AsDateTime, _
                      gdcDetailObject.FieldByName("USR$DATEBEGIN").AsDateTime)
        
                    LineSum = LineSum * LimitPercent / 100 * K
                  else
                    LastDay = Day(DateAdd("m", 1, DateSerial( _
                      Year(gdcDetailObject.FieldByName("USR$DATEBEGIN").AsDateTime), _
                      Month(gdcDetailObject.FieldByName("USR$DATEBEGIN").AsDateTime), 1)) - 1)
                    if LastDay > 0 then
                      LineSum = _
                        Self.gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency * _
                        gdcDetailObject.FieldByName("USR$DOI").AsInteger / LastDay
                    else
                      LineSum = 0
                    end if
                  end if
                  'if not Pregnancy then
                    set wg_EmployeeMovement = wg_EmplMoveList.MoveCardList(gdcObject.FieldByName("USR$EMPLKEY").AsInteger, Null)
                    if Assigned(wg_EmployeeMovement) then
                      'Зредняя зрп за месяц предыдущий месяцу болезни
                      DateFrom = gdcDetailObject.FieldByName("USR$INCLUDEDATE").AsDateTime
                      set MoveCard = wg_EmployeeMovement.ExistMoveCardByDate(DateFrom)
                      if Assigned(MoveCard) then
                        WorkDays = 0
                        WorkHours = 0
                        ' определяем период начала и конца итогового начисления
                        DB = wg_Total.DateBegin(wg_Total.TotalDocByDate(DateFrom))
                        DE = wg_Total.DateEnd(wg_Total.TotalDocByDate(DateFrom))
                        call wg_CalcSchedulerWorkTime(gdcObject.FieldByName("usr$emplkey").AsInteger, _
                          MoveCard.FirstMoveKey, DB, DE, gdcObject.ReadTransaction, True, WorkDays, WorkHours)
        
                        if not ByHour then
                          if WorkDays > 0 then
                            AvgSalaryByRB = 3 * wg_MonthHour.AvgSalaryByRB(_
                              DateSerial(Year(DateFrom), Month(DateFrom), 1) -1) / WorkDays * gdcDetailObject.FieldByName("USR$DOI").AsCurrency
                          else
                            AvgSalaryByRB = 0
                          end if
                        else
                          if WorkHours > 0 then
                            AvgSalaryByRB = 3 * wg_MonthHour.AvgSalaryByRB(_
                              DateSerial(Year(DateFrom), Month(DateFrom), 1) -1) / WorkHours * gdcDetailObject.FieldByName("USR$HOI").AsCurrency
                          else
                            AvgSalaryByRB = 0
                          end if
                        end if
                        
                        if AvgSalaryByRB <> 0 and LineSum > AvgSalaryByRB then
                          LineSum = AvgSalaryByRB
                        end if
                      end if
                   ' end if
                  end if
                  Self.gdcDetailObject.FieldByName("usr$summa").AsCurrency = wg_RoundSum(FeeTypeKey, LineSum)
                  gdcDetailObject.Post
                  gdcDetailObject.Next
                wend
                gdcDetailObject.First
                
              ' 50% от бюджета прожиточного минимума
              ' срабатывает, если при пересчете декрета пользователь выбрал "50% БМП"
              case "USR$CALCBYBUDGET"
                if Field.AsInteger = 0 then
                  Self.gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency = 0
                else
                  dim gdcAvgStr
                  set gdcAvgStr = Self.GetComponent("usrg_gdcAvgSalaryStr")
                  'Выключаем автоперерасчет среднего заработка
                  gdcAvgStr.Tag = 1
                  'Удалим старые значения
                  gdcAvgStr.First
                  while not gdcAvgStr.Eof
                    gdcAvgStr.Delete
                  wend
                  call Tgdc_dlgUserComplexDocument147022845_119619099SyncField_CalcAvgSumBudget(Self.gdcObject)
                  gdcAvgStr.Tag = 0
                end if
              case "USR$FROM"
                if (not Field.IsNull) and Self.gdcObject.FieldByName("USR$CALCBYBUDGET").AsInteger = 1 then
                  call Tgdc_dlgUserComplexDocument147022845_119619099SyncField_CalcAvgSumBudget(Self.gdcObject)
                end if
            end select
          end if
        end sub
        
        ' 50% от бюджета прожиточного минимума
        sub Tgdc_dlgUserComplexDocument147022845_119619099SyncField_CalcAvgSumBudget(gdcO)
          dim AvgSum, OnDate
          if gdcO.FieldByName("USR$FROM").IsNull then
            OnDate = Date
          else
            OnDate = gdcO.FieldByName("USR$FROM").AsDateTime
          end if
          ' бюджет прожиточного минимума
          AvgSum = wg_GetConstByIDAndDate(gdcBaseManager.GetIDByRUIDString(wg_cnst_LivingWage_RUID), OnDate)
          gdcO.FieldByName("usr$avgsumma").AsCurrency = Round(AvgSum  / 2)
        end sub
        
      DISPLAYSCRIPT: | 
        TGDC_DLGUSERCOMPLEXDOCUMENT147022845_119619099SYNCFIELD
        TGDC_DLGUSERCOMPLEXDOCUMENT147022845_119619099SYNCFIELD_CALCAVGSUMBUDGET
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147022925_119619099 TgdcCreateableForm\\Tgdc_dlgG\\Tgdc_dlgTR\\Tgdc_dlgHGR\\Tgdc_dlgUserComplexDocument\\Tgdc_dlgUserComplexDocument147022845_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QEAAAAU0VMRgQAAABTRUxGAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZOU1RQUlNU
        BQAAAEZJRUxEBQAAAEZJRUxEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZOU1RQUlNUCAAAAFNZ
        TkNMSVNUCAAAAFNZTkNMSVNUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEZOU1RGTFBS
      INHERITEDRULE: 0
      USEDEBUGINFO: ~
      EDITIONDATE: 2014-03-21T13:57:18+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "147043669_974374174 wg_GetConstByIDAndDate"
          - 
            ADDFUNCTIONKEY: "155074107_1698257362 wg_CalcSiclListCoeff"
          - 
            ADDFUNCTIONKEY: "147025267_449804462 wg_SetWageDocLookupParams"
          - 
            ADDFUNCTIONKEY: "147019334_119619099 wg_MonthHour"
          - 
            ADDFUNCTIONKEY: "147804276_375143752 wg_RoundSum"
          - 
            ADDFUNCTIONKEY: "147523125_336327731 wg_CalcSchedulerWorkTime"
          - 
            ADDFUNCTIONKEY: "147586119_119619099 wg_Total"
  - 
    Properties: 
      Class: "TgdcEvent"
      RUID: 147368574_274788016
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "Tgdc_dlgUserComplexDocument147022845_119619099"
      PARENTNAME: "Tgdc_dlgUserComplexDocument"
      OBJECTKEY: "147022925_119619099 TgdcCreateableForm\\Tgdc_dlgG\\Tgdc_dlgTR\\Tgdc_dlgHGR\\Tgdc_dlgUserComplexDocument\\Tgdc_dlgUserComplexDocument147022845_119619099"
      EVENTNAME: "SYNCFIELD"
      FUNCTIONKEY: "147368576_274788016 Tgdc_dlgUserComplexDocument147022845_119619099SyncField"
      DISABLE: ~
      EDITIONDATE: 2014-03-21T13:57:19+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 528604221_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "PROLOG"
      LANGUAGE: "VBScript"
      NAME: "twg_struct_in_params"
      COMMENT: ~
      SCRIPT: | 
        % twg_struct_in_params
        
        :- new_param_list(wg_struct_vacation, in,
            [
            ]).
        
        :- new_param_list(wg_struct_sick, in,
            [
            pFirstCalcType-0, pFirstDuration-12, pFirstPart-0.8,
            pBudget_xid-147073065,
            pBudget_dbid-1224850260
            ]).
        
        %
        
        
      DISPLAYSCRIPT: ~
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: ~
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-21T12:22:22+03:00
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 528605649_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 528605678_99701464
    Fields: 
      OBJECTNAME: "APPLICATION"
      MODULE: "UNKNOWN"
      LANGUAGE: "VBScript"
      NAME: "wg_AvgSalaryDetailGenerate_Sick_pl"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#include pl_GetScriptIDByName
        
        Function wg_AvgSalaryDetailGenerate_Sick_pl(ByRef Sender)
        '
          if not Sender.OwnerForm.gdcObject.VariableExists("DontRecalcLine") then
            Sender.OwnerForm.gdcObject.AddVariableItem("DontRecalcLine")
          end if
          Sender.OwnerForm.gdcObject.Variables("DontRecalcLine") = True
          'Сбрасываем кэш для Переменных
          set wg_Variable_ = Nothing
        '
          Dim Creator, gdcObject, gdcDetail
          '
          Dim PL, Ret, Pred, Tv, Append
          Dim PredFile
          'struct_sick_sql
          Dim P_sql, Tv_sql, Q_sql
          Dim EmplKey, FirstMoveKey, DateBegin, DateEnd, PredicateName, Arity, SQL
          'struct_sick_in
          Dim P_in, Tv_in, Q_in
          Dim DateCalc, AvgWage, CalcType, BudgetOption
          'struct_sick_out
          Dim P_out, Tv_out, Q_out
          Dim AccDate, IncludeDate, Percent, DOI, HOI, Summa
        
          wg_AvgSalaryDetailGenerate_Sick_pl = False
          Set Creator = New TCreator
        
          Sender.GetComponent("actApply").Execute
        
          Set gdcObject = Sender.gdcObject
          '
          EmplKey = gdcObject.FieldByName("usr$emplkey").AsInteger
          FirstMoveKey = gdcObject.FieldByName("usr$firstmovekey").AsInteger
          DateBegin = gdcObject.FieldByName("USR$DATEBEGIN").AsDateTime
          DateEnd = gdcObject.FieldByName("USR$DATEEND").AsDateTime
          AvgWage = gdcObject.FieldByName("USR$AVGSUMMA").AsCurrency
          CalcType = Sender.GetComponent("usrg_cbCalcType").ItemIndex
          BudgetOption = gdcObject.FieldByName("USR$CALCBYBUDGET").AsInteger
          '
          Dim IBSQL
          Set IBSQL = Creator.GetObject(nil, "TIBSQL", "")
          IBSQL.Transaction = gdcBaseManager.ReadTransaction
          IBSQL.SQL.Text = _
              "select " & _
              "  t.USR$DATEBEGIN " & _
              "from " & _
              "  usr$wg_total t " & _
              "where " & _
              "  t.DOCUMENTKEY = :TDK "
          IBSQL.ParamByName("TDK").asInteger = gdcObject.FieldByName("USR$TOTALDOCKEY").AsInteger
          IBSQL.ExecQuery
          DateCalc = IBSQL.FieldByName("USR$DATEBEGIN").AsDateTime
          '
        
          'init
          Set PL = Creator.GetObject(nil, "TgsPLClient", "")
          Ret = PL.Initialise("")
          If Not Ret Then
            Exit Function
          End If
          'debug
          PL.Debug = True
          'load
          Ret = PL.LoadScript(pl_GetScriptIDByName("twg_struct"))
          If Not Ret Then
            Exit Function
          End If
        
          Set gdcDetail = Sender.gdcDetailObject
          '
          gdcDetail.First
          While Not gdcDetail.EOF
            gdcDetail.Delete
          Wend
          '
          Sender.Repaint
        
          'struct_sick_sql(EmplKey, FirstMoveKey, DateBegin, DateEnd, PredicateName, Arity, SQL)
          P_sql = "struct_sick_sql"
          Set Tv_sql = Creator.GetObject(7, "TgsPLTermv", "")
          Set Q_sql = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_sql.PredicateName = P_sql
          Q_sql.Termv = Tv_sql
          '
          Append = False
          '
          Tv_sql.PutInteger 0, EmplKey
          Tv_sql.PutInteger 1, FirstMoveKey
          Tv_sql.PutDate 2, DateBegin
          Tv_sql.PutDate 3, DateEnd
          '
          Q_sql.OpenQuery
          Do Until Q_sql.EOF
            PredicateName = Tv_sql.ReadAtom(4)
            Arity = Tv_sql.ReadInteger(5)
            SQL = Tv_sql.ReadString(6)
            '
            Ret =  PL.MakePredicatesOfSQLSelect _
                      (SQL, _
                      gdcBaseManager.ReadTransaction, _
                      PredicateName, PredicateName, Append)
            '
            Q_sql.NextSolution
          Loop
          Q_sql.Close
          
          'save param_list
          If PL.Debug Then
            Pred = "param_list"
            PredFile = "param_list"
            Set Tv = Creator.GetObject(3, "TgsPLTermv", "")
            PL.SavePredicatesToFile Pred, Tv, PredFile
          End If
        
          'struct_sick_in(DateCalc, DateBegin, DateEnd, AvgWage, CalcType, BudgetOption)
          P_in = "struct_sick_in"
          Set Tv_in = Creator.GetObject(6, "TgsPLTermv", "")
          Set Q_in = Creator.GetObject(nil, "TgsPLQuery", "")
          Tv_in.PutDate 0, DateCalc
          Tv_in.PutDate 1, DateBegin
          Tv_in.PutDate 2, DateEnd
          Tv_in.PutFloat 3, AvgWage
          Tv_in.PutInteger 4, CalcType
          Tv_in.PutInteger 5, BudgetOption
          '
          Q_in.PredicateName = P_in
          Q_in.Termv = Tv_in
          '
          Q_in.OpenQuery
          If Q_in.EOF Then
            Exit Function
          End If
          Q_in.Close
        
          'struct_sick_out(AccDate, IncludeDate, Percent, DOI, HOI, Summa, DateBegin, DateEnd)
          P_out = "struct_sick_out"
          Set Tv_out = Creator.GetObject(8, "TgsPLTermv", "")
          Set Q_out = Creator.GetObject(nil, "TgsPLQuery", "")
          Q_out.PredicateName = P_out
          Q_out.Termv = Tv_out
          Q_out.OpenQuery
          If Q_out.EOF Then
            Exit Function
          End If
          '
          Do Until Q_out.EOF
            '
            AccDate = Tv_out.ReadDate(0)
            IncludeDate = Tv_out.ReadDate(1)
            Percent = Tv_out.ReadFloat(2)
            DOI = Tv_out.ReadFloat(3)
            HOI = Tv_out.ReadFloat(4)
            Summa = Tv_out.ReadFloat(5)
            DateBegin = Tv_out.ReadDate(6)
            DateEnd = Tv_out.ReadDate(7)
            '
            gdcDetail.Append
            gdcDetail.FieldByName("USR$ACCDATE").AsVariant = AccDate
            gdcDetail.FieldByName("USR$INCLUDEDATE").AsVariant = IncludeDate
            gdcDetail.FieldByName("USR$PERCENT").AsVariant = Percent
            gdcDetail.FieldByName("USR$DOI").AsVariant = DOI
            gdcDetail.FieldByName("USR$HOI").AsVariant = HOI
            gdcDetail.FieldByName("USR$SUMMA").AsVariant = Summa
            gdcDetail.FieldByName("USR$DATEBEGIN").AsVariant = DateBegin
            gdcDetail.FieldByName("USR$DATEEND").AsVariant = DateEnd
            gdcDetail.Post
            '
            Q_out.NextSolution
          Loop
          Q_out.Close
          '
          gdcDetail.First
        
          wg_AvgSalaryDetailGenerate_Sick_pl = True
        '
        Sender.OwnerForm.gdcObject.Variables("DontRecalcLine") = False
        '
        End function
        
      DISPLAYSCRIPT: | 
        WG_AVGSALARYDETAILGENERATE_SICK_PL
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "1010001_17 APPLICATION"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QGAAAAU0VOREVSBgAAAFNFTkRFUgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABGTlNU
        RkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-21T14:13:09+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "151158419_5956463 pl_GetScriptIDByName"
  - 
    Properties: 
      Class: "TgdcFunction"
      RUID: 528605680_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
      HeadObject: 528605678_99701464
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      MODULE: "MACROS"
      LANGUAGE: "VBScript"
      NAME: "Macros_AvgSalaryDetailGenerate_Sick"
      COMMENT: ~
      SCRIPT: | 
        Option Explicit
        '#include wg_AvgSalaryDetailGenerate_Sick_pl
        
        Sub Macros_AvgSalaryDetailGenerate_Sick(OwnerForm)
          Dim Ret
          Ret = wg_AvgSalaryDetailGenerate_Sick_pl(OwnerForm)
        End Sub
        
      DISPLAYSCRIPT: | 
        MACROS_AVGSALARYDETAILGENERATE_SICK
        
      MODIFYDATE: ~
      OWNERNAME: ~
      FUNCTIONTYPE: ~
      EVENT: ~
      LOCALNAME: ~
      PUBLICFUNCTION: 1
      SHORTCUT: ~
      GROUPNAME: ~
      MODULECODE: "147022904_119619099 gdc_dlgUserComplexDocument147022845_119619099"
      ENTEREDPARAMS: !!binary > 
        U0xQUlBSU1QJAAAAT1dORVJGT1JNCQAAAE9XTkVSRk9STQAAAAAAAAAAAAAAAAsAAAAAAAAAAAAA
        AABGTlNURkxQUg==
      INHERITEDRULE: 0
      USEDEBUGINFO: 0
      EDITIONDATE: 2014-03-14T11:24:22+03:00
    Set: 
      - 
        Table: "RP_ADDITIONALFUNCTION"
        Items: 
          - 
            ADDFUNCTIONKEY: "528605649_99701464 wg_AvgSalaryDetailGenerate_Sick_pl"
  - 
    Properties: 
      Class: "TgdcMacros"
      RUID: 528605678_99701464
      AlwaysOverwrite: False
      DontRemove: False
      IncludeSiblings: False
    Fields: 
      OBJECTNAME: "gdc_dlgUserComplexDocument147022845_119619099"
      MACROSGROUPKEY: "147022905_119619099 Локальные макросы"
      FUNCTIONKEY: "528605680_99701464 Macros_AvgSalaryDetailGenerate_Sick"
      NAME: "Расчет структуры больничного"
      SERVERKEY: ~
      ISLOCALEXECUTE: 0
      ISREBUILD: 0
      EXECUTEDATE: ~
      SHORTCUT: 0
      EDITIONDATE: 2014-03-14T11:24:23+03:00
      DISPLAYINMENU: 1
      RUNONLOGIN: 0